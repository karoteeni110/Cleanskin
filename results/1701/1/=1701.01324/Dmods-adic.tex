\documentclass{article}
\usepackage{amsmath,amssymb,xypic,theorem}
\xyoption{curve}

\theoremstyle{change}
\theorembodyfont{\itshape}
\newtheorem{thm}[subsubsection]{Theorem}
\newtheorem{prop}[subsubsection]{Proposition}
\newtheorem{lemma}[subsubsection]{Lemma}
\newtheorem{cor}[subsubsection]{Corollary}
\setcounter{tocdepth}{2}

\makeatletter
\renewcommand{\subsection}{\@startsection%
{subsection}{2}{0mm}{\baselineskip}{-1em}%
{\normalfont\normalsize\bfseries}}
\renewcommand{\subsubsection}{\@startsection%
{subsubsection}{3}{0mm}{\baselineskip}{-1em}%
{\normalfont\normalsize\textit}}
\makeatother

\numberwithin{equation}{subsubsection}
%\renewcommand{\theenumi}{\roman{enumi}}
%\renewcommand{\labelenumi}{\textit{(\theenumi)}}

\renewcommand{\theenumi}{\theequation}
\renewcommand{\labelenumi}%
  {\stepcounter{equation}{\rm(\theequation)}}

\newcommand{\demobox}{\vrule height6pt width6pt depth0pt}
\newcommand{\version}{\hfill{\it Version of \today}}
\newcommand{\nodemo}{\unskip\nobreak\hfil\qquad
\demobox\parfillskip=0pt\par}

% proofs
\newenvironment{demo}{\noindent{\it Proof.}}
{{\unskip\nobreak\hfil\qquad
\demobox\parfillskip=0pt\par}
\medskip}

% examples, exercises

\newenvironment{example}{\medskip\noindent{\textit{Example.}}}{\medskip}
\newenvironment{remark}{\medskip\noindent{\textit{Remark.}}}{\medskip}
\newenvironment{history}{\medskip\noindent{\bf Historical Remarks.}}{\medskip}

\include{mathdefs} % all symbols
\newcommand\hP{\hat P}
\newcommand\hI{\hat I}
\newcommand\hJ{\hat J}
\newcommand\hK{\hat K}
\renewcommand\spec{\mathrm{sp}}
\newcommand\lc{\lceil}
\newcommand\lcc{\lceil\!\lceil}
\newcommand\rc{\rceil}
\newcommand\rcc{\rceil\!\rceil}
\newcommand{\tensu}[1]{\underset{{#1}}{\otimes}}
\newcommand{\ctensu}[1]{\underset{{#1}}{\hat\otimes}}



\title{Arithmetic $\D$-modules on Adic Formal Schemes}
\author{Richard Crew}

\begin{document}
\maketitle

\section*{Introduction}
\label{sec:intro}

In a series of papers \cite{berthelot:1990}, \cite{berthelot:1996},
\cite{berthelot:2000}, \cite{berthelot:2002} Berthelot created a
theory of arithmetic differential operators, with the goal of
constructing a category of $p$-adic coefficients in which
Grothendieck's formalism of the six operations should
hold. Specifically, if $\cX\to\cS$ is a smooth morphism of $p$-adic
formal schemes (i.e. of finite type and formally smooth), he
constructs rings $\niv{\D}{m}_{\cX/\cS}$ and
$\Ddag_{\cX/\cS\bQ}=\limdir_m\niv{\hD}{m}_{\cX/\cS\bQ}$ of differential
operators on $\cX$, shows that they are coherent sheaves of rings and
sketches a formalism of the six operations for coherent
$\Ddag_{\cX/\cS\bQ}$-modules. Parts of the theory are still
conjectural, particularly those relating to the preservation of
coherence or holonomy (finiteness is always a problem with $p$-adic
cohomology theories). However Caro and Tsuzuki have shown
\cite{caro-tsuzuki:2012} that a full subcategory of the category of
holonomic $F\Ddag$-modules is stable under the six operations and
contains the overconvergent $F$-isocrystals as a full subcategory.

The aim of this paper is to extend the construction and study of the
rings $\niv{\D}{m}_{\cX/\cS}$, $\niv{\hD}{m}_{\cX/\cS}$ and
$\Ddag_{\cX/\cS\bQ}$ to a class of morphisms $\cX\to\cS$ that are not
of finite type or even adic. A very simple example was treated in
\cite{crew:2006} and \cite{crew:2012}, where $\V$ is a complete
discrete valuation ring of mixed characteristic $p>0$, $\cS=\Spf{\V}$
and $\cX=\Spf{\V[[t]]}$. In this case the rings
$\niv{\hD}{m}_{\cX/\cS}$ and $\Ddag_{\cX/\cS}$ can be constructed and
their basic properties demonstrated by elementary means. A more
complex example of the same sort is when $\cX$ is the completion along
a closed subscheme of a smooth formal $\V$-scheme $\cP$; this is the
basic setting for the theory of convergent and overconvergent
isocrystals and rigid cohomology. One could also take $\cP$ to be a
formal $\cS$-scheme, where $\cS$ is any adic locally noetherian formal
scheme; the case $\cS=\Spf{\V[[t]]}$ is the important one in the study
of vanishing cycles.

In this article we restrict our attention to locally noetherian formal
schemes, as in the works of Berthelot just cited. Since the noetherian
condition is not preserved by fiber products one needs to impose
finiteness conditions on morphisms to preserve the noetherian
condition. While it is true that much recent work has sought to weaken
the noetherian hypothesis when working with formal schemes, one still
needs finiteness conditions on the morphisms to get useful results. In
this paper we consider a class of morphisms for which the base change
problem is solved by definition. A morphism $\cX\to\cS$ of adic
locally noetherian formal schemes is \textit{universally noetherian}
if for any morphism $\cS'\to\cS$ with $\cS'$ noetherian the fibered
product $\cX\times_\cS\cS'$ is noetherian. The class of universally
noetherian morphisms has remarkable stability properties and includes
the examples described above. There are many other examples; for
instance localization also gives rise to universally noetherian
morphisms.

A \textit{quasi-smooth} morphism is one that is separated, formally
smooth and universally noetherian. The construction of the algebraic
(Grothendieck) ring of differential operators and of Berthelot's ring
$\niv{\D}{m}_{\cX/\cS}$ extends to the quasi-smooth case in a
relatively straightforward way. However in our case the reduction
modulo $p^n$ of the ring $\niv{\D}{m}_{\cX/\cS}$ is not a
quasicoherent sheaf on a scheme, as in \cite{berthelot:1996}, and this
is a problem when one wants to prove finiteness results
(e.g. coherence) for the $p$-adic completion of
$\niv{\D}{m}_{\cX/\cS}$, or define cohomological operations. Instead
we must complete $\niv{\D}{m}_{\cX/\cS}$ with respect to an ideal of
definition of $\O_\cX$, which requires some care to get a sheaf of
rings on $\cX$. Once this is done, the basic finiteness results for
$\niv{\hD}{m}_{\cX/\cS}$ and $\Ddag_{\cX/\cS}$ proven in
\cite{berthelot:1996} for smooth $\cX/\cS$ extend without difficulty
to the quasi-smooth case.

In the last two sections we give a new construction of the category of
convergent isocrystals on a separated $k$-scheme of finite type, where
$k$ is a field of positive characteristic and show that the pullback
by relative Frobenius is an autoequivalence of this category. The
construction itself is an extension of that of \cite{berthelot:1996},
where it is shown that if $X$ is closed fiber of a smooth formal
$\V$-scheme $\cX$ of finite type, the category of convergent
isocrystals on $X/K$ is equivalent to the category of
$\Ddag_{\cX/\V\bQ}$-modules that are coherent as
$\O_{\cX\bQ}$-modules. In this case, the fact that the pullback by
relative Frobenius is an equivalence of categories is a consequence of
Berthelot's Frobenius descent theorem \cite{berthelot:2000}. It is
interesting that in the more general case considered here the ring
$\Ddag_{\cX/\V\bQ}$ does not appear at all. Replacing it is series of
rings $\cB_{J,m}\ctens_{\O_\cX}\niv{\hD}{m}_{\cX/\V\bQ}$, where $\cX$
is the completion of $\cP$ along $X\subset\cP$, $J$ is a fixed ideal
of definition of $\O_\cX$ and $\cB_{J,m}$ is an $\O_\cX$-algebra whose
extension of scalars $\cB_{J,m}\tens\bQ$ is locally the ring of
rigid-analytic functions on a closed tube of $X$ in $\cP$. We show
that the category of convergent isocrystals on $X/K$ is equivalent to
the category $\Isoc(\cX,J)$ whose objects are systems $(M_m,f_{mm'})$,
where $M_m$ a left $\cB_{J,m}\ctens\niv{\hD}{m}_{\cX/\V\bQ}$ that is
coherent as a $\cB_{J,m}\tens\bQ$-module, and the $f_{mm'}$ are a
transitive systems of $\cB_{J,m}\tens\niv{\hD}{m}_{\cX/\V\bQ}$-linear
isomorphisms $\cB_{J,m}\ctens_{\cB_{J,m'}}M_{m'}\isom M_m$ for
$m'\ge m$.

Fix $q=p^s$ and let $F:\cX\to\cX'$ be a lifting of the relative $q$th
power Frobenius $X\to\niv{X}{q}$. The pullback by $F$ of
$\cB_m\ctens\niv{\hD}{m}_{\cX'/\V\bQ}$ is isomorphic to
$\cB_{m+s}\ctens\niv{\hD}{m+s}_{\cX/\V\bQ}$, and the Frobenius descent
theorem asserts that $F^*$ is an equivalence of the category of left
$\cB_m\ctens\niv{\hD}{m}_{\cX'/\V\bQ}$-modules with the category of
left $\cB_{m+s}\ctens\niv{\hD}{m+s}_{\cX/\V\bQ}$-modules (when
$\cX/\V$ is smooth this is shown in \cite{berthelot:2000}, and the
argument in the general case is the same). The fact that $F^*$ is an
equivalence of the categories of convergent isocrystals on $\cX$ and
$\cX'$ follows from the descent theorem and the equivalence of
$\Isoc(\cX,J)$ with the category of convergent isocrystals on $X/K$.

The same methods can be used to reconstruct the category of
overconvergent isocrystals on $X/K$ and prove the corresponding
theorem about the Frobenius pullback. One must consider, in addition
to the tube algebras of \S\ref{sec:tubes-and-isocrystals}, algebras
generalizing the ones denoted by $\niv{\hat\cB}{m}_\cX(Z)$ in \S4.2 of
\cite{berthelot:1996}. This needs some additional constructions which
we will treat in a sequel.

The reader will probably recognize that the use of formal methods in
preference to rigid-analytic ones is a return to Ogus's point of view
on the theory of convergent isocrystals; in fact the tube algebras
mentioned above are examples of what are called \textit{enlargements}
in \cite{ogus:1984}. However the study of what we call the tube
algebras in \S\ref{sec:tubes-and-isocrystals} goes far beyond what is
needed for the purposes of rigid geometry and the theory of convergent
isocrystals. It suggests that the theory of overconvergent isocrystals
and rigid cohomology can be generalized to the situation where $X/S$
is of finite type and $S$ has an closed embedding $S\inj\cS$ into an
adic locally noetherian formal scheme flat over $\bZ_p$. This too will
be dealt with in a sequel. In a recent book \cite{lazda-pal:2016}
Lazda and P\'al have proposed a theory of overconvergent isocrystals
and rigid cohomology of this sort when $\cS=\Spf{\V[[t]]}$ and
$\V[[t]]$ has the $p$-adic topology (\textit{not} the topology defined
by the maximal ideal). However they use the theory of adic spaces
rather than formal methods.

Another generalization of \S\ref{sec:isocrystals} would replace the
category $\Isoc(\cX,J)$ by a more extensive one consisting of systems
$(M_m,f_{mm'})$ as before, but where now $M_m$ is a simply a coherent
$\cB_{J,m}\ctens\niv{\hD}{m}_{\cX/\V\bQ}$-module. A left
$\cB_{J,m}\ctens\niv{\hD}{m}_{\cX/\V\bQ}$-module that is coherent as a
$\cB_{J,m}$-module is automatically coherent as a left
$\cB_{J,m}\ctens\Ddag_{\cX/\V\bQ}$-module, so this category extends
$\Isoc(\cX,J)$. Whether this defines a useful theory of $p$-adic
coefficients depends on the extent to which Berthelot's conjectures on
the preservation of holonomy are valid in some form for this type of
category.

\bigskip

\noindent\textit{Acknowledgements.} 
I am indebted to many people for helpful conversations and a large
number of pointed questions that served to improve the originial
manuscript. I am particularly grateful for help from Pierre Berthelot
and Bernard Le Stum in Rennes, and Francesco Baldassari and Bruno
Chiarellotto in Padua. Much of this article was worked out during
visits to IRMAR at the University of Rennes I and to the mathematics
department of the University of Padua. I would like to thank both
institutions for their support.  \bigskip

\noindent\textit{Notation and Conventions.} 
Terminology and notation regarding commutative algebra and formal
schemes generally follows EGA \cite{EGA}. For example if $M$ is an
$A$-module an $f\in A$, $M_f$ is the (algebraic) localization of $M$,
and if $M$ is a topological $A$-module $M_{\{f\}}$ is the formal
localization, i.e. the completion of $M_f$. A topological ring $R$ is
\textit{preadic} if it has the $J$-adic topology for some ideal
$J\sset R$, and \textit{adic} if it is preadic, separated and
complete.

All formal schemes are assumed to be \textit{adic} and, unless stated
otherwise, \textit{locally noetherian}. These conditions will
frequently be stated explicitly for emphasis.

In any category with fibered products the notation $X_S(r)$ denotes
the fibered product of $r+1$ copies of $X$ over $S$. We use the same
notation for tensor products of rings, or completed tensor products of
topological rings. 

The tensor product of an abelian group $M$ with $\bQ$ will usually be
written $M_\bQ$, as in \cite{berthelot:1996}.

When dealing with rings or geometric constructions in an affine
setting, completions will usually be denoted by a ``hat'' which is
dropped in purely geometric situations. For example if $A$ is an
$R$-algebra, $\diff_{A/R}$ is the usual module of 1-forms,
$\cdiff_{A/R}$ is its completion in the natural topology, but the
sheafification of $\cdiff_{A/R}$ for a morphism $\cX\to\cS$ is
$\diff_{\cX/\cS}$. The exceptions are the rings
$\niv{\D}{m}_{\cX/\cS}$ and $\niv{\hD}{m}_{\cX/\cS}$, since this
notation is completely entrenched in the literature, and it is useful
to have a separate notation for $\niv{\D}{m}_{\cX/\cS}$.

In addition to the standard notations for multi-indices, we use the
following: for $K=(k_1,\ldots,k_n)\in\bZ^n$ we write $K<a$
(resp. $K\le a$) to mean $k_i<a$ (resp. $k_i\le a$) for all $i$.

\tableofcontents

\section{Formal Geometry}
\label{sec:formal-schemes}

\subsection{Flatness and formal smoothness.}
\label{sec:formal-flatness}

We will use the same definition of formal smoothness for a morphism of
formal schemes as for ordinary schemes: a morphism $\cX\to\cS$ of
formal schemes is \textit{formally smooth} (resp. \textit{formally
  unramified}, \textit{formally \'etale}) if for any commutative
square
\begin{displaymath}
  \xymatrix{
    Z_0\ar[r]\ar[d]&\cX\ar[d]\\
    Z\ar[r]\ar@{.>}[ur]&\cS
  }  
\end{displaymath}
in which $Z$ is an \textit{affine scheme} and $Z_0\to Z$ is a
nilpotent immersion, there exists a morphism $Z\to\cX$ (resp. there is
at most one morphism, there exists a unique morphism) making the
extended diagram commutative. When $\cX=\Spf{B}$ and $\cS=\Spf{A}$ are
affine $\cX\to\cS$ is formally smooth if and only if $B$ is a formally
smooth $A$-algebra. The reader may check that most of the elementary
properties of formally smooth, formally unramified and formally
\'etale morphisms of ordinary schemes (e.g. \cite[IV \S17]{EGA}
propositions 17.1.3 and 17.1.4) are also valid in the present context
of adic locally noetherian formal schemes. There is one important
exception: with this definition, formally smoothness is \textit{not} a
local property, either on the base or the source. We will return to
this question in section \ref{sec:smooth-formal-case}.  For now we
observe that if $f:\cX\to\cS$ is formally smooth (resp. unramified,
\'etale) and $U\sset\cX$, $V\sset\cS$ are open formal subschemes such
that $f(U)\sset V$ , the induced morphisms $U\to V$ is formally smooth
(resp. unramified, \'etale); this follows from the definitions and the
fact that $Z$ and $Z_0$ have the same underlying topological space.

\begin{lemma}\label{lemma:completions-of-local-rings}
  Let $A$ be an adic ring with ideal of definition $J$, $x\in\Spf{A}$,
  $\fm\subset A$ the open prime ideal corresponding to $x$. If $M$ is
  a coherent $A$-module let $\cM$ be the sheaf on $\Spf{A}$
  corresponding to $M$ and $\cM_x$ the stalk of $\cM$ at $x$. Then the
  natural morphism $M_\fm\to\cM_x$ induces an isomorphism
  $\hat M_\fm\isom\hat\cM_x$ of the $J$-adic completions.
\end{lemma}
\begin{demo}
  By definition $M_\fm=\limdir_fM_f$ and $\cM_x=\limdir_fM_{\{f\}}$
  where $f$ runs through $A\setminus\fm$, and the natural map
  $M_\fm\to\cM_x$ is induced by $M_f\to M_{\{f\}}$. It suffices to
  show that
  \begin{displaymath}
    (\limdir_fM_f)\tens_AA/J^n\to(\limdir_fM_{\{f\}})\tens_AA/J^n
  \end{displaymath}
  is an isomorphism for all $n$. Since inductive limits commute with
  tensor products, this is the same as
  \begin{displaymath}
    \limdir_f(M_f\tens_AA/J^n)\to\limdir_f(M_{\{f\}}\tens_AA/J^n)
  \end{displaymath}
  and the assertion is clear, since
  $M_f\tens_AA/J^n\to M_{\{f\}}\tens_AA/J^n$ is an isomorphism.
\end{demo}

The morphism $M_\fm\to\cM_x$ is functorial in $M$, and also in $A$ in
the sense that if $A\to B$ is a continuous homomorphism of adic rings
yielding $f:\Spf{B}\to\Spf{A}$, and $\fn\subset B$ is an open prime
ideal corresponding to $y\in\Spf{B}$ such that $f(y)=x$, the diagram
\begin{displaymath}
  \xymatrix{
    (B\tens_AM)_\fn\ar[r]&f^*\cM_y\\
    M_\fm\ar[r]\ar[u]&\cM_x\ar[u]
  }
\end{displaymath}
is commutative. It follows that the isomorphisms of completions is
functorial in the same sense.

Recall that a morphism $f:\cX\to\cS$ of locally ringed spaces, and in
particular of locally noetherian formal schemes is \textit{flat} at a
point $x\in\cX$ if the morphism $\O_{f(x)}\to\O_x$ of local rings is
flat, and $f$ is flat if it is flat at every point of $x$.

\begin{lemma}\label{lemma:formal-flatness}
  For any morphism $f:\cX\to\cS$ of locally noetherian adic formal
  schemes, the following are equivalent:
  \begin{enumerate}
  \item $f$ is flat;
  \item $f$ is flat at every closed point of $\cX$;
  \item for every pair $\Spf{B}\sset\cX$, $\Spf{A}\sset\cX$ of open
    affines such that $f(\Spf{B})\sset\Spf{A}$, $B$ is a flat
    $A$-algebra.
  \end{enumerate}
\end{lemma}
\begin{demo}
  The implications
  \ref{lemma:formal-flatness}.3$\implies$\ref{lemma:formal-flatness}.1
  and
  \ref{lemma:formal-flatness}.1$\implies$\ref{lemma:formal-flatness}.2
  are clear. Suppose now that \ref{lemma:formal-flatness}.2 holds; we
  can also assume that $A$ and $B$ in \ref{lemma:formal-flatness}.3
  are noetherian. It suffices to show that for every maximal ideal
  $\fn\subset B$ and $\fm=A\cap\fn$, $B_\fn$ is a flat $A_\fm$-algebra
  \cite[Ch. II \S3 no. 4 Prop. 15]{bourbaki-AC}. By the faithful
  flatness of completions it suffices to show that $\hat B_\fn$ is a
  flat $\hat A_\fm$-algebra, where the completions are taken with
  respect to the adic topologies of $A$ and $B$.

  Since $B$ is adic and noetherian it is a Zariski ring, and every
  maximal ideal is open. Therefore $\fn\subset B$ corresponds to a
  closed point $x\in\cX$ and $y=f(x)$ corresponds to $\fm$. Now
  \ref{lemma:formal-flatness}.2 asserts $\O_x$ is a flat
  $\O_y$-algebra, and thus $\hat\O_x$ is a flat $\hat\O_y$-algebra. By
  lemma \ref{lemma:completions-of-local-rings} there are isomorphisms
  $\hat\O_x\simeq\hat B_\fn$ and $\hat\O_y\simeq\hat A_\fm$, and by
  functoriality the map $\hat A_\fm\to\hat B_\fn$ corresponds via
  these identifications to $\hat\O_y\to\hat\O_x$.
\end{demo}

\begin{prop}\label{prop:formally-smooth-implies-flat}
  A formally smooth morphism $f:\cX\to\cS$ of adic locally noetherian
  schemes is flat.
\end{prop}
\begin{demo}
  It suffices to show that for all $x\in\cX$ and $y=f(x)$ that $\O_x$
  is a flat $\O_y$-algebra. Pick open affine neighborhoods $x\in U$,
  $y\in V$ such that $f(U)\sset V$; by the remark just before the
  proposition, the morphism $U\to V$ induced by $f$ is formally
  smooth. If $U=\Spf{B}$ and $V=\Spf{A}$, the topological $A$-algebra
  $B$ is formally smooth. Then $\O_x$ is a formally smooth
  $\O_y$-algebra for the preadic topologies induced by $B$ and $A$,
  and therefore formally smooth for the preadic topologies defined by
  the maximal ideals of $\O_x$ and $\O_y$. The assertion then follows
  from theorem 19.7.1 of \cite[$0_{IV}$]{EGA}.
\end{demo}

\begin{cor}\label{cor:formally-smooth-implies-flat}
  If $A$ is an adic noetherian ring and $B$ is an adic noetherian ring
  and a formally smooth $A$-algebra, $B$ is flat over $A$.
\end{cor}

\subsection{Universally noetherian morphisms.}
\label{sec:formal-schemes-finiteness}

If $f:\cX\to\cS$ is a morphism of locally noetherian formal schemes,
we say that $f$ is \textit{universally noetherian} if for every
morphism $g:\cS'\to\cS$ of formal schemes with $\cS'$ adic and
noetherian, the fiber product $\cX\times_\cS\cS'$ is noetherian. We
will also say that $\cX$ is a universally noetherian formal
$\cS$-scheme.  If $A$ and $B$ are adic noetherian rings and $A\to B$
is a continuous homomorphism, we say that $B$ is a universally
noetherian $A$-algebra if $\Spf{B}$ is a universally noetherian formal
$\Spf{A}$-scheme. To check that $\cX\to\cS$ is noetherian, it suffices
to check the condition for morphisms $\cS'\to\cS$ with $\cS'$ formally
affine and noetherian. In particular if $A$ is a noetherian ring, an
$A$-algebra $B$ is universally noetherian if and only if $A\ctens_BC$
is a noetherian ring for any adic noetherian $B$-algebra $C$.

Suppose for example that $k$ is a field with the discrete topology.
The $k$-algebra $k[[X]]$ with the $(X)$-adic topology is universally
noetherian, since for any adic noetherian $k$-algebra $C$ the
completed tensor product $k[[X]]\ctens_kC\simeq C[[X]]$ is
noetherian. On the other hand if $k$ is a field of characteristic $0$
and $k[[X]]$ has the discrete topology, $k\to k[[X]]$ is not
universally noetherian since $k[[X]]\tens_kk[[X]]$ is not
noetherian. If it were, the kernel of the multiplication map
$k[[X]]\tens_kk[[X]]\to k[[X]]$ would be a finitely generated ideal,
and $\diff_{k[[X]]/k}$ would be a finitely generated
$k[[X]]$-module. In particular $\diff_{k((X))/k}$, which is a
localization of $\diff_{k[[X]]/k}$ would be a $k((X))$-space of finite
dimension. On the other hand $k((X))$ has infinite transcendance
degree over $k$, and this implies that $\diff_{k((X))/k}$ is not a
$k((X))$-space of finite dimension; since $k((X))$ is a separable
extension of $k$, this follows from \cite[$0_{IV}$]{EGA} Cor. 20.5.10
and Cor. 20.6.19.

It is immediate from the definition that a universally noetherian
morphism is quasicompact, and that if $f:\cX\to\cS$ is universally
noetherian and $\cS$ is noetherian, then so is $\cX$. 

\begin{lemma}
  If $f:\cX\to\cS$ is universally noetherian and $\cS'\to\cS$ is morphism with
  $\cS'$ locally noetherian, the fiber product $\cX\times_\cS\cS'$ is
  locally noetherian.
\end{lemma}
\begin{demo}
  Let $\{U_\alpha\}_{\alpha\in I}$ be a cover of $\cS'$ by noetherian
  formal schemes. By definition the
  $f^{-1}(U_\alpha)=\cX\times_\cS U_\alpha$ are noetherian, and since
  they cover $\cX$, $\cX$ is locally noetherian.
\end{demo}

Thus fibered products with a universally noetherian morphism do not
force us to leave the category of adic locally noetherian schemes.
The usual \textit{sorites} hold for the class of universally
noetherian morphisms:

\begin{prop}\label{prop:noeth-sorites}
  (i) An immersion is universally noetherian.  (ii)
  Let $f:\cX\to\cS$ be a morphism of locally noetherian schemes.
  If $f:\cX\to\cS$ is universally noetherian and $\cS'$ is any locally
  noetherian formal $\cS$-scheme, the base-change
  $\cX\times_\cS\cS'\to\cS'$ is universally noetherian. (iii) If $\cY$
  is locally noetherian and $f:\cX\to\cS$, $g:\cY\to\cX$ are
  universally noetherian, so is $f\circ g:\cY\to\cS$. (iv) If
  $f:\cX\to\cS$ and $g:\cY\to\cS$ are universally noetherian morphisms
  then so is $f\times g:\cX\times_\cS\cY\to\cS$.
\end{prop}
\begin{demo}
  For (i) it suffices to treat the case of open and closed
  immersions. Since any base-change of an open (resp. closed)
  immersion is open (resp. closed), the assertion is clear in the case
  of closed immersions, and for open immersions it suffices to add
  that an open immersion of locally noetherian formal schemes is
  quasi-compact.  Assertions (ii) and (iii) follow from the definition
  and the transitivity of fibered products, while (iv) follows from
  (i) and (ii).
\end{demo}

The property of being universally noetherian is local on the base and,
with a suitable restriction, on the source:

\begin{prop}\label{prop:properties-of-loc-noeth}
  Let $f:\cX\to\cS$ be a morphism of locally noetherian schemes.  (i)
  If $f$ is quasi-compact and $\{U_\alpha\}_{\alpha\in I}$ is an open
  cover of of $\cX$, then $f$ is universally noetherian if and only if
  each of the induced morphisms $U_\alpha\to\cS$ is universally
  noetherian. (ii) If $\{V_\alpha\}_{\alpha\in I}$ is an open cover of
  $\cS$, then $f$ is universally noetherian if and only if the
  morphisms $f^{-1}(V_\alpha)\to V_\alpha$ are universally noetherian.
\end{prop}
\begin{demo}
  Necessity in assertions (i) and (ii) follows from the sorites
  \ref{prop:noeth-sorites}. To prove the condition is sufficient in
  (i) we first observe that for any $\cS'\to\cS$ with $\cS'$
  noetherian, each of the $U_\alpha\times_\cS\cS'$ are
  noetherian. Since the $U_\alpha\times_\cS\cS'$ cover
  $\cX\times_\cS\cS'$, the latter is locally noetherian. On the other
  hand since $\cX\to\cS$ is quasicompact, so is
  $\cX\times_\cS\cS'\to\cS'$, from which it follows that
  $\cX\times_\cS\cS'$ is quasicompact, hence noetherian. This proves
  (i), and sufficiency in (ii) follows from (i), as one sees by taking
  $U_\alpha=f^{-1}(V_\alpha)$ and observing, first, that $f$ is
  necessarily quasi-compact since all of the
  $f^{-1}(V_\alpha)\to V_\alpha$ are, and second that the composite
  morphisms $U_\alpha\to V_\alpha\to\cS$ are universally noetherian.
\end{demo}

\begin{prop}\label{prop:properties-of-loc-noeth2}
  If $\cX\to\cS$ is universally noetherian and $\cY$ is a locally
  noetherian formal $\cS$-scheme, any morphism $\cX\to\cY$ is
  universally noetherian.
\end{prop}
\begin{demo}
  By (ii) of the last proposition we may assume that $\cY$ is affine,
  in which case $\cY\to\cS$ is separated and
  $\cX\times_\cY\cT\to\cX\times_\cS\cT$ is a closed immersion.  Since
  by hypothesis $\cX\times_\cS\cT$ is noetherian, it follows that
  $\cX\times_\cY\cT$ is noetherian as well, as required.
\end{demo}

We will say that a morphism $f:X\to S$ of locally noetherian schemes
is universally noetherian if $X\times_SS'$ is noetherian for any
morphism of schemes $S'\to S$ with $S'$ noetherian. Note that this
condition is \textit{a priori} weaker than the condition that $f$ be
universally noetherian, where $X$ and $S$ are regarded as (discrete)
formal schemes, for the latter condition requires that $X\times_S\cS'$
be noetherian for any morphism $\cS'\to S$ with $\cS'$ a noetherian
\textit{formal} scheme. In fact these conditions are equivalent. We
first recall a general result of topological algebra, which combines
\cite[Ch. III \S2 no. 12 Cor. 2]{bourbaki-AC} and \cite[Ch. III \S2
no. 10 Cor. 5]{bourbaki-AC}; see also the general discussion of
completions in \cite[III \S2 no.\ 12]{bourbaki-AC}.

\begin{prop}\label{prop:general-noetherian-lemma}
  Suppose $R$ is a commutative ring and $I\subset R$ is a finitely
  generated ideal. If $\hat R$ is the separated completion of $R$ and
  $\hat I$ is the completion of $I$, identified with an ideal of
  $\hat R$, the completion if $I^n$ coincides with $\hat I^n$ and with
  $I^n\hat R$. The topology of $\hat R$ is the $\hat I$-adic topology
  and the natural homomorphism $R/I^n\to\hat R/\hat I^n$ is an
  isomorphism. Finally if $R/I$ is noetherian, so is $\hat R$.
\end{prop}

\begin{lemma}\label{lemma:univ-noeth-ord-schemes}
  A universally noetherian morphism $X\to S$ of noetherian schemes is
  also universally noetherian when $X$ and $S$ are considered as adic
  formal schemes.
\end{lemma}
\begin{demo}
  It suffices to treat the affine case $X=\Sp{B}$, $S=\Sp{A}$. Let
  $(C,J)$ be an adic noetherian ring. Then $B\tens_AJ$ is an ideal of
  finite type in $B\tens_AC$ and an ideal of definition of
  $B\tens_AC$, and by hypothesis the ring
  $(B\tens_AC)/(B\tens_AJ)\simeq B\tens_A(C/J)$ is noetherian. The
  last proposition then shows that $B\ctens_AC$ is noetherian, as
  required.
\end{demo}

\begin{prop}\label{prop:noeth-if-red-is noeth}
  Suppose $f:\cX\to\cS$ is a morphism of locally noetherian formal
  schemes and $f_0:X\to S$ is the corresponding morphism of reduced
  closed subschemes. Then $f$ is universally noetherian if and only if
  $f_0$ is universally noetherian
\end{prop}
\begin{demo}
  Necessity: if $f$ is universally noetherian then so is
  $\cX\times_\cS S\to S$, and the closed immersion $X\to\cX\times_\cS
  S$ is universally noetherian as well.

  Sufficiency: it is enough to check the case where $\cX=\Spf{B}$ and
  $\cS=\Spf{A}$ are formally affine. Then $A$ and $B$ are noetherian,
  and if $I\subset A$, $J\subset B$ are maximal ideals of definition,
  $X=\Sp{B/J}$ and $S=\Sp{A/I}$. Suppose $B'$ is a noetherian
  $A$-algebra with ideal of definition $J'$ such that $IB'\sset J'$.
  By hypothesis the ring $(B/J)\tens_{A/I}(B'/J')$ is noetherian.  Set
  $B''=B\tens_AB'$ and $J''=J\tens B'+B\tens J'\subset B''$. By
  definition $B\ctens_AB'$ is the completion $\hat B''$ for the
  $J''$-adic topology. Since $J\subset B$ and $J'\subset B'$ are
  finitely generated, so is $J''$ and it follows from proposition
  \ref{prop:general-noetherian-lemma} that $\hat B''$,
  i.e. $B\ctens_AB'$ is noetherian, as required.
\end{demo}

Recall that $f$ is \textit{formally of finite type} if, in the
notation of the last proposition, $f_0$ is of finite type.

\begin{cor}\label{cor:fft-is-noeth}
  A morphism of formal schemes that is formally of finite type is
  universally noetherian.
\end{cor}
\begin{demo}
  Since a morphism of finite type is universally noetherian this
  follows from the proposition.
\end{demo}

If $\cX$ is an adic formal scheme and $Y\subset\cX$ is a closed
subscheme, the completion $\hat\cX_Y$ of $\cX$ along $Y$ is defined in
the same way as in the case of ordinary schemes, c.f. \cite[I
Ch. 10]{EGA}.

\begin{cor}\label{cor:completion-is-noeth}
  If $f:\cX$ is a locally noetherian formal scheme and $Y\subset\cX$
  is a closed subscheme, the canonical morphism $i_Y:\hat\cX_Y\to\cX$
  is universally noetherian.
\end{cor}
\begin{demo}
  The morphism of reduced schemes induced by $i_Y$ is a closed
  immersion.
\end{demo}

From the corollary and the sorites we conclude that if $\cX\to\cS$ is
of finite type and $Y\subset\cX$ is closed, $\hat\cX_Y\to\cS$ is
universally noetherian; this will be the main case of interest
in section \ref{sec:tubes-and-isocrystals}. 

\begin{cor}\label{cor:localization-is noeth}
  Suppose $(A,I)$ is an adic noetherian ring, $S\subset A$ is a
  multiplicative system and $B$ is the completion of $S^{-1}A$ with
  respect to the ideal $S^{-1}I$. Then $B$ is a universally noetherian
  $A$-algebra. 
\end{cor}
\begin{demo}
  Suppose $(C,K)$ is an adic noetherian ring and $A\to C$ is
  continuous. We may suppose that $CI\sset K$. If $J$ is the
  completion of $S^{-1}I$, $B/J\simeq S^{-1}A/S^{-1}I$ and the
  isomorphism $(B/J)\tens_{(A/I)}(C/K)\simeq S^{-1}C/S^{-1}K$ shows
  that $(B/J)\tens_{(A/I)}(C/K)$ is noetherian. Thus $B/J$ is a
  universally noetherian $A/I$-algebra, and it follows from
  proposition \ref{prop:noeth-if-red-is noeth} that $A\to B$ is
  universally noetherian.
\end{demo}

Applying the corollary when $S$ is the complement of an open prime
ideal, we get:

\begin{cor}\label{cor:immersion-of-complete-local-ring-is-noeth}
  Suppose $\cX$ is a locally noetherian adic formal scheme and $x$ is
  a point of $\cX$. Denote by $\hat\O_x$ the completion of the local
  ring of $x$ with respect to an ideal of definition of $\cX$. Then
  $\Spf{\hat\O_x}\to\cX$ is an adic universally noetherian morphism.
  \nodemo
\end{cor}

From corollary \ref{cor:completion-is-noeth} we see that
$\Spf{\hat\O_x}\to\cX$ is also universally noetherian if $\hat\O_x$ is
given the adic topology defined by the maximal ideal, although the
morphism $\Spf{\hat\O_x}\to\cX$ is not adic in this case.

\begin{remark}
  It follows from lemma \ref{lemma:univ-noeth-ord-schemes} and
  corollary \ref{cor:immersion-of-complete-local-ring-is-noeth} that a
  morphism of schemes that is essentially of finite type is
  universally noetherian. I do not know if there are universally
  noetherian morphisms of schemes that are \textit{not} essentially of
  finite type. One can show that a field extension $L/K$ is
  universally noetherian if and only if $L$ is a finitely generated
  extension of $K$.
\end{remark}

The following proposition is an easy consequence of the fact that a
formal scheme has the same underlying topological space as its reduced
closed subscheme. Its equivalent properties define the notion of a
\textit{radicial} morphism of adic locally noetherian schemes.

\begin{prop}\label{prop:radicial-morphisms}
  For any universally noetherian morphism $f:\cY\to\cX$, the following
  are equivalent:
  \begin{enumerate}
  \item $f$ is universally injective, i.e. for any morphism
    $\cX'\to\cX$ with $\cX'$ locally noetherian,
    $\cY\times_\cX\cX'\to\cX'$ is injective.
  \item The morphism induced by $f$ on the reduced closed subschemes
    of $\cY$ and $\cX$ is radicial.
  \end{enumerate}\nodemo
\end{prop}

\section{Differentials and Smoothness}
\label{sec:smooth-morphisms}

\subsection{Differential invariants.}
\label{sec:differential-invariants}

As usual we start with the affine case, and then globalize. 

\subsubsection{}
\label{sec:topologies}

We begin with a review of the topological aspects of the module of
relative 1-forms.  Let $R$ be a topological ring and $A$ a topological
$R$-algebra, preadic with ideal of definition $J\subset A$.  We denote
by $I$ the diagonal ideal $I=\Ker(A\tens_RA\to A)$, so that the ring
of principal parts of order $r$ and the module of relative 1-forms are
\begin{displaymath}
  P^n_{A/R}=(A\tens_RA)/I^{r+1},\qquad\diff_{A/R}=I/I^2.
\end{displaymath}
We denote by $d_0$, $d_1:A\to P^n_{A/R}$ the morphisms
$d_0(b)=b\tens1$, resp. $d_1(b)=1\tens b$.

Ideals of $A\ctens_RA$ will always have the induced topology.  We
topologize $\diff_{A/R}=I/I^2$ as a subquotient of $A\tens_RA$
(i.e. as a quotient of $I$ in the induced topology, or as a subobject
of $P^2_{A/R}$; these are the same). For $K=A\tens J+J\tens A$ this
coincides with the $K$-adic topology; this is evident if $A\tens_RA$
is noetherian (Artin-Rees), but in general it follows from the fact
that for any ideal $M\sset A$,
\begin{displaymath}
  I\cap(A\tens M^2+M^2\tens A)\sset MI+I^2
\end{displaymath}
(c.f.\ \cite[$0_{IV}$ Prop. 20.4.5]{EGA}). For the $A$-module structure
of $\diff_{A/R}$ defined by $d_0$ or $d_1$, we have
\begin{displaymath}
  J^n\diff_{A/R}=K^n\diff_{A/R}
\end{displaymath}
and thus the topology of $\diff_{A/R}$ is also the $J$-adic topology
(this is without any assumption that $\diff_{A/R}$ is finitely
generated). As in \cite[$0_{IV}$ \S20.7]{EGA} we denote by
$\cdiff_{A/R}$ the completion of $\diff_{A/R}$ with respect to its
subquotient topology.  By the previous remarks $\cdiff_{A/R}$ is also
the $J$-adic completion when $\diff_{A/R}$ when regarded as a
$A$-module via $d_0$ or $d_1$. We denote by $\hP^n_{A/R}$ the
completion of $P^n_{A/R}$ with respect to its quotient topology.

If $R\to A$ and $A\to B$ are continuous homomorphisms of preadic rings,
the canonical exact sequence of relative 1-forms for the triple
$R\to A\to B$ induces a \textit{sequence}
\begin{equation}
  \label{eq:std-exact-sequence-completed-1}
  B\ctens_A\cdiff_{A/R}\to\cdiff_{B/R}\to\cdiff_{B/A}\to 0
\end{equation}
which is not necessarily exact. It is ``nearly exact'' in the sense
that $\cdiff_{B/R}\to\cdiff_{B/A}$ is surjective and the image of
$B\ctens_A\cdiff_{A/R}\to\cdiff_{B/R}$ is dense in the kernel of
$\cdiff_{B/R}\to\cdiff_{B/A}$, c.f. \cite[$0_{IV}$ 20.7.17.3]{EGA} and
the discussion there. If $A\to B$ is surjective with kernel $K$,
$\cdiff_{B/A}=0$ and there is similar sequence
\begin{equation}
  \label{eq:std-exact-sequence-completed-2}
  K/K^2\to B\ctens_A\cdiff_{A/R}\to\cdiff_{B/R}\to 0
\end{equation}
with the same ``near exactness'' property of
\ref{eq:std-exact-sequence-completed-1}, c.f. \cite[$0_{IV}$ 20.7.20]{EGA}

The sequence
\begin{displaymath}
  0\to I\to A\tens_RA\to A\to0
\end{displaymath}
is strict exact; in fact by construction $I$ has the induced topology,
and the image of $K^n\sset A\tens_RA$ in $A$ is $J^n$. Since the
completion of a strict exact sequence is strict exact \cite[Ch. III
\S2 no. 12 Lemme 2]{bourbaki-AC}, the sequence
\begin{equation}
  \label{eq:hatI-as-kernel}
  0\to\hI\to A\ctens_RA\to A\to 0
\end{equation}
is exact, in which $A\ctens_RA\to A$ is induced by
$a\ctens b\mapsto ab$. Our first goal is to show that when $A$ is a
universally noetherian $R$-algebra we may identify
$\cdiff_{A/R}\simeq\hI/\hI^2$ and
$\hat P^n_{A/R}\simeq A\ctens_RA/\hI^{r+1}$, c.f. proposition
\ref{prop:Omega-hat} below. We need the following generalization of
proposition \ref{prop:general-noetherian-lemma}:

\begin{lemma}\label{lemma:completions-of-powers}
  Let $R$ be a preadic ring with a finitely generated ideal of
  definition $J$, and suppose that $\hat R$ is noetherian. For any
  ideal $M\subset R$, $\hat M^n=(M^n)\,\widehat\relax$. 
\end{lemma}
\begin{demo}
  Let $i:R\to\hat R$ be the canonical map. Since $\hat R$ is adic with
  ideal of definition $\hat J$ (proposition
  \ref{prop:general-noetherian-lemma}), the completion of $M^n$,
  i.e. the closure of $i(M^n)$ is
  \begin{displaymath}
    (M^n)\,\widehat\relax=\bigcap_{k\ge0}(i(M^n)+\hat J^k).
  \end{displaymath}
  Since $\hat J^k$ is open,
  \begin{displaymath}
    i(M)+\hJ^k=\hat M+\hJ^k
  \end{displaymath}
  and taking powers yields
  \begin{displaymath}
    i(M^n)+\hJ^k=\hat M^n+\hJ^k
  \end{displaymath}
  for all $k\ge0$. Therefore 
  \begin{displaymath}
    (M^n)\,\widehat\relax=\bigcap_{k\ge0}(\hat M^n+\hat J^k).
  \end{displaymath}
  The right hand side is the closure of $\hat M^n$, but $\hat R$ is a
  Zariski ring by proposition \ref{prop:general-noetherian-lemma}, and
  the ideal $\hat M^n$ is already closed.
\end{demo}

\begin{prop}\label{prop:Omega-hat}
  Let $R\to A$ be a continuous homomorphism of noetherian adic rings.
  If $A$ is a universally noetherian $R$-algebra, there are functorial
  isomorphisms
  \begin{displaymath}
    \cdiff_{A/R}\simeq\hI/\hI^2
    \quad\text{and}\quad
    \hP^n_{A/R}\simeq(A\ctens_RA)/\hI^{r+1}.
  \end{displaymath}
\end{prop}
\begin{demo}
  If $J\subset A$ is an ideal of definition, $J$ is finitely generated
  and thus $K=A\tens J+J\tens A$ is a finitely generated ideal of
  $R=A\tens_RA$. The sequence
  \begin{displaymath}
    0\to I^2\to I\to\diff_{A/R}\to 0
  \end{displaymath}
  is strict exact by definition of the topologies involved, so its
  completion
  \begin{displaymath}
    0\to (I^2)\,\widehat\relax\to\hI\to\cdiff_{A/R}\to 0
  \end{displaymath}
  is also strict exact. By hypothesis $\hat R=A\ctens_RA$ is
  noetherian, and the lemma shows that this exact sequence is
  \begin{displaymath}
    0\to\hI^2\to\hI\to\cdiff_{A/R}\to 0
  \end{displaymath}
  and the first assertion follows. The second is proven in the same way.
\end{demo}

\begin{cor}\label{cor:Omega-hat-finitely-generated}
  If $R$ is noetherian and $A$ is an universally noetherian
  $R$-algebra, $\cdiff_{A/R}$ is generated as a $A$-module by finitely
  many elements of the form $1\ctens x-x\ctens1$.
\end{cor}
\begin{demo}
  Since $I$ is generated by elements of the form $1\tens x-x\tens1$
  and $\hI$ is the $K$-adic completion of $I$, $\hI$ is generated by
  the $1\ctens x-x\ctens1$ for all $x\in A$, and thus by finitely many
  of them, since $A\ctens_RA$ is noetherian.
\end{demo}

For $x\in A$ we will use $\md x$ to denote both the image of
$1\tens x-x\tens1$ in $\diff_{A/R}$ and the image of
$1\ctens x-x\ctens1$ in $\cdiff_{A/R}$; this should not cause
confusion.

\begin{cor}\label{cor:standard-exact-sequences}
  If $R\to A\to B$ are homomorphisms of adic noetherian rings with
  $R\to A$ and $R\to B$ universally noetherian, the sequence
  \begin{displaymath}
    B\tens_A\cdiff_{A/R}\to\cdiff_{B/R}\to\cdiff_{B/A}\to0
  \end{displaymath}
  is exact. If $A\to B$ is surjective with kernel $K$, the sequence
  \begin{displaymath}
    K/K^2\to B\tens_A\cdiff_{A/R}\to\cdiff_{B/R}\to 0
  \end{displaymath}
  is exact.
\end{cor}
\begin{demo}
  The hypotheses imply that $A\to B$ is universally noetherian, so
  that $\cdiff_{A/R}$ is a finitely generated $A$-module and
  $\cdiff_{B/R}$ and $\cdiff_{B/A}$ are finitely generated
  $B$-modules; thus in \ref{eq:std-exact-sequence-completed-1} we may
  replace the completed tensor product by an ordinary one.  Since $B$
  is noetherian, any submodule of the finitely generated modules
  $\cdiff_{B/R}$ and $\cdiff_{B/A}$ is closed, and exactness follows
  from the ``near exactness'' of the sequence
  \ref{eq:std-exact-sequence-completed-1}. The argument in the case of
  the second sequence is the same.
\end{demo}

Let $J$ be an ideal of definition $J\subset A$ and set
$A_n=A/J^{n+1}$. For $n'\ge n$ there is a natural $A$-module
homomorphism $\diff_{A_{n'}/R}\to\diff_{A_n/R}$, and the discussion of 
\cite[$O_{IV}$ 20.7.14]{EGA} shows that their inverse limit is the
separated completion of $\diff_{A/R}$, whence a canonical isomorphism 
\begin{equation}
  \label{eq:alternate-cdiff}
  \cdiff_{A/R}\simeq\liminv\diff_{A_n/R}
\end{equation}

\begin{example}
  Let $J$ be an ideal of definition of $R$, and let
  $A=R\{T_1,\ldots,T_d\}$ be the $J$-adic completion of the polynomial
  ring $R[T_1,\ldots,T_d]$. With $JA$ is an ideal of definition of
  $A$, $A$ is an $R$-algebra that is topologically of finite type, and
  therefore universally noetherian. Then \ref{eq:alternate-cdiff}
  shows that $\cdiff_{A/R}$ is free over $A$ with basis
  $\md T_1,\ldots,\md T_d$.
\end{example}

\begin{prop}\label{prop:cdiff-of-completions}
  Let $A$ be a universally noetherian $R$-algebra. If $M\subset A$ is
  an ideal containing an ideal of definition and $B$ is the $M$-adic
  completion of $A$, there is a natural and functorial isomorphism
  \begin{displaymath}
    B\tens_A\cdiff_{A/R}\isom\cdiff_{B/R}
  \end{displaymath}
\end{prop}
\begin{demo}
  Setting $K=M^n$ in the second exact sequence of corollary
  \ref{cor:standard-exact-sequences} and $B_n=A/M^n$ yields exact
  sequences
  \begin{displaymath}
    M^n/M^{2n}\to(A/M^n)\tens_A\cdiff_{A/R}\to\diff_{B_n/R}\to0
  \end{displaymath}
  for all $n\ge0$. Since the pro-object $\{M^n/M^{2n}\}_{n\ge0}$ is
  essentially zero, its image in
  $\{(A/M^n)\tens_A\cdiff_{A/R}\}_{n\ge0}$ is essentially zero and in
  particular Mittag-Leffler. Therefore the inverse limit over $n$ is
  an isomorphism
  \begin{displaymath}
    B\ctens_A\cdiff_{A/R}\isom\liminv_n\diff_{B_n/R}
  \end{displaymath}
  and we may replace the completed tensor product by an ordinary one
  since $\cdiff_{A/R}$ is finitely generated. The assertion then
  follows from \ref{eq:alternate-cdiff}.
\end{demo}

\begin{example}
  If $(R,J)$ is adic noetherian, we saw in the last example that for
  $R$-algebra $A=R\{X_1,\ldots,X_d\}$ with the $J$-adic topology,
  $\cdiff_{A/R}$ is free with basis $\md X_1,\ldots,\md X_d$. Then
  $B=R[[X_1,\ldots,X_d]]$ is completion of $A$ with respect to the
  ideal $M=(X_1,\ldots,X_d)$, and proposition
  \ref{prop:cdiff-of-completions} says that $\cdiff_{B/R}$ is the free
  $B$-module on $\md X_1,\ldots,\md X_d$; compare this with
  \cite[$0_{IV}$ Cor. 21.9.3]{EGA}.
\end{example}

\subsubsection{Deformations.}
\label{sec:deformations}

One more consequence of \cite[$0_{IV}$ 20.7.14]{EGA} will be
useful. Suppose $A$ is a topological $R$-algebra and $B$ is a discrete
topological $R$-algebra with an ideal $I\subset B$ such that
$I^2=0$. If a continuous $R$-homomorphism $u_0:A\to B$ is given, the
set of continuous $R$-homomorphisms $u:A\to B$ having the same
composite with $B\to B/I$ is principal homogenous under the $A$-module
of continuous derivations $A\to I$; the argument is the same as the
discrete case \cite[$0_{IV}$ Prop. 20.1.1]{EGA}. Since $u_0$ is
continuous and $B$ is discrete, $I$ is annihilated by an open ideal of
$A$, and it follows that the $A$-module of continuous derivations
$A\to I$ is the same as the set continuous $\hat A$-morphisms
$\cdiff_{A/R}\to I$, c.f. \cite[$0_{IV}$ 20.7.14.4]{EGA}.  When $A$ is
adic, the topology of $\cdiff_{A/R}$ is induced by the topology of
$A$, and it follows that any $A$-linear $\cdiff_{A/R}\to I$ is
continuous. Therefore the set of $u:A\to B$ having the same
composition with $B\to B/I$ as $u_0$ is principal homogenous under the
group $M=\Hom_A(\cdiff_{A/R},I)$. Since $I^2=0$, the $A$-module
structure of $I$ comes from a $B/I$-module structure, and
\begin{equation}
  \label{eq:deformation-group}
  M\simeq\Hom_{B/I}((B/I)\tens_A\cdiff_{A/R},I).   
\end{equation}

\subsubsection{Globalization.}
\label{sec:1-forms-global}

This presents no particular problem, and we will just state the main
consequences of the previous sections. We systematically drop the
``hat'' in a global setting. The most straightforward procedure is to
observe that the construction of $\cdiff_{A/R}$ sheafifies for a
morphism of universally noetherian formal schemes in the same manner
that the construction of $\diff_{A/R}$ does for ordinary schemes: for
any multiplicative system $S\subset A$,
$\diff_{S^{-1}A/R}\simeq S^{-1}\diff_{A/R}$; if $R\to A$ is
universally noetherian $\cdiff_{A/R}$ is a $A$-module of finite type,
and it follows that if $A\{S^{-1}\}$ denotes the completion of
$S^{-1}A$,
\begin{displaymath}
  \cdiff_{A\{S^{-1}\}/R}\simeq A\{S^{-1}\}\tens_A\cdiff_{A/R}.
\end{displaymath}
Thus for universally noetherian $\cX\to\cS$ there is a coherent
$\O_\cX$-module $\diff_{\cX/\cS}$ such that
$\Gamma(\cX,\diff_{\cX/\cS})\simeq\cdiff_{A/R}$ when $\cX=\Spf{A}$ and
$\cS=\Spf{R}$ are affine.

A slightly less direct but perhaps more natural construction is the
following. If $f:\cX\to\cS$ is a separated universally noetherian
morphism of adic locally noetherian formal schemes, we denote by $\cI$
the ideal of the diagonal immersion $\cX\to\cX\times_\cS\cX$, and set
\begin{equation}
  \label{eq:global-diff-and-principal-parts}
  \diff_{\cX/\cS}=\cI/\cI^2,\qquad
  \cP^n_{\cX/\cS}=\O_{\cX\times_\cS\cX}/\cI^n.
\end{equation}
When
$\cX=\Spf{A}$ and $\cS=\Spf{R}$ are affine, $\cI$ is the sheaf of
ideals corresponding to the kernel of $A\ctens_RA\to A$, which by the
exact sequence \ref{eq:hatI-as-kernel} is the completion $\hI$ of
$I=\Ker(A\tens_RA\to A)$. Therefore
\begin{displaymath}
  \Gamma(\cX,\diff_{\cX/\cS})\simeq\hI/\hI^2\simeq\cdiff_{A/R}
  \quad\text{and}\quad
  \Gamma(\cX,\cP^n_{\cX/\cS})\simeq(A\ctens_RA)/\hI^{r+1}
  \simeq\hP^n_{A/R}
\end{displaymath}
by proposition \ref{prop:Omega-hat}. If $\cY\to\cS$ and $\cX\to\cS$
are universally noetherian and $f:\cY\to\cX$ is a morphism
(necessarily universally noetherian), the sequence
\begin{equation}
  \label{eq:std-exact-sequence-completed-3}
  f^*\diff_{\cX/\cS}\to\diff_{\cY/\cS}\to\diff_{\cY/\cX}\to0
\end{equation}
is exact; if in addition $\cY\to\cX$ is a closed immersion with ideal
$\cK$, the sequence
\begin{equation}
  \label{eq:std-exact-sequence-completed-4}
  \cK/\cK^2\to f^*\diff_{\cX/\cS}\to\diff_{\cY/\cS}\to0
\end{equation}
is exact; these assertions follow immediately for corollary
\ref{cor:standard-exact-sequences}. Finally, if $J\subset\O_\cX$ is an
ideal of definition and $X_n$ is the closed subscheme of $\cX$ defined
by $J^{n+1}$, the isomorphism \ref{eq:alternate-cdiff} 
% and
% \ref{eq:alternate-principal-parts} 
globalizes to
\begin{equation}
  \label{eq:alternate-diff-global}
  \diff_{\cX/\cS}\simeq\liminv_n\diff_{X_n/\cS}.
\end{equation}

From proposition \ref{prop:diff-of-completions} we get

\begin{prop}\label{prop:diff-of-completions}
  If $\cX\to\cS$ is separated and universally noetherian and
  $Y\subset\cX$ is a closed subscheme, the canonical
  morphism
  \begin{displaymath}
    i_Y^*\diff_{\cX/\cS}\to\diff_{\hat\cX_Y/\cS}
  \end{displaymath}
  is an isomorphism.\nodemo
\end{prop}

The deformation theory of section \ref{sec:deformations} globalizes in
the same way. If $f:\cX\to\cS$ is universally noetherian, $Z$ is an
affine scheme over $\cS$, $Z_0\inj Z$ is a closed immersion whose
ideal $I$ is such that $I^2=0$, and $g:Z_0\to\cX$ is a $\cS$-morphism,
the sheaf of liftings of $g$ to a morphism $u:Z\to\cX$ making the
diagram
\begin{equation}
  \label{eq:formal-smooth-diagram2}
  \xymatrix{
    Z_0\ar[r]^g\ar[d]&\cX\ar[d]\\
    Z\ar[r]\ar[ur]^u&\cS
  }  
\end{equation}
commutative is a pseudo-torsor under the sheaf
$M=Hom_{\O_{Z_0}}(g^*\diff_{\cX/\cS},I)$. 

\subsection{Quasi-smooth morphisms.}
\label{sec:smooth-formal-case}

We say that a morphism $f:\cX\to\cS$ of locally noetherian formal
schemes is \textit{quasi-smooth} (resp. \textit{quasi-unramified},
\textit{quasi-\'etale}) if it is separated, universally noetherian and
formally smooth (resp. formally unramified, formally
\'etale)\footnote{This definition of ``quasi-smooth'' conflicts with
  \cite[Ch. IV 1.5.1]{berthelot:1974}. As we will not use Berthelot's
  notion, this will not be a problem.}. By proposition
\ref{prop:formally-smooth-implies-flat}, a quasi-smooth morphism is
flat. In particular an quasi-\'etale morphism is flat and
quasi-unramified; I do not know if the converse is true.

For example, a morphism $f:\cX\to\cS$ is \textit{smooth} if it is of
finite type (in particular, adic) and formally smooth. Note that this
definition is equivalent to the one given by Berthelot
\cite[2.1.5]{berthelot:1996} in the case of morphisms of adic formal
schemes over a complete discrete valuation ring. It is clear
that a smooth morphism is quasi-smooth, and conversely a quasi-smooth
morphism of finite type is smooth. 

The next proposition summarizes the basic properties of quasi-smooth,
quasi-unramified and quasi-\'etale morphisms. They follow from the
results on universally noetherian morphisms in section
\ref{sec:formal-schemes-finiteness} and basic properties of formally
smooth (resp. formally unramified, formally \'etale) morphisms whose
proofs are entirely parallel to the corresponding assertions for
morphisms of schemes, c.f. \cite[\S17]{EGA} propositions 17.1.3--5.

\begin{prop}\label{prop:smooth-sorites}
  (i) An immersion is quasi-unramified. An open immersion is
  quasi-\'etale.  (ii) If $f:\cX\to\cS$ and $g:\cY\to\cX$ are
  quasi-smooth (resp. quasi-unramified, quasi-\'etale) then so is
  $g\circ f:\cY\to\cS$. (iii) If $\cX\to\cS$ is quasi-smooth
  (resp. quasi-unramified, quasi-\'etale) and $\cS'\to\cS$ is any
  morphism of locally noetherian schemes, $\cX\times_\cS\cS'\to\cS'$
  is quasi-smooth (resp. quasi-unramified, quasi-\'etale). (iv) If
  $f:\cX\to\cS$ and $g:\cY\to\cS$ are quasi-smooth
  (resp. quasi-unramified, quasi-\'etale) then so is
  $f\times g:\cX\times_\cS\cY\to\cS$. (v) If $f:\cX\to\cS$ and
  $g:\cY\to\cX$ are universally noetherian morphisms and $f\circ g$ is
  quasi-unramified, then $g$ is quasi-unramified. (vi) If
  $f:\cX\to\cS$ is formally quasi-unramified, $g:\cY\to\cX$ is
  universally noetherian and $f\circ g$ is formally smooth
  (resp. formally quasi-\'etale) then so is $g$. (vii) If
  $f:\cX\to\cS$ is formally quasi-\'etale and $g:\cY\to\cX$ is
  universally noetherian, then $f\circ g$ is quasi-smooth
  (resp. quasi-\'etale) if and only if $f$ is.\nodemo
\end{prop}

We can now return to a question that was left open in section
\ref{sec:formal-flatness}:

\begin{prop}\label{prop:quasi-smooth-is-local}
  Let $f:\cX\to\cS$ be a universally noetherian morphism. (i) If
  $\{U_\alpha\}$ is an open cover of $\cX$ and
  $f_\alpha:U_\alpha\to\cS$ is the composite of $f$ with the open
  immersion $U_\alpha\to\cX$, then $f$ is quasi-smooth
  (resp. quasi-unramified, quasi-\'etale) if and only if all the
  $f_\alpha$ are quasi-smooth (resp. quasi-unramified,
  quasi-\'etale). (ii) If $\{V_\alpha\}$ is an open cover of $\cS$
  then $f$ is quasi-smooth (resp. quasi-unramified, quasi-\'etale) if
  and only if the morphisms $f^{-1}(V_\alpha)\to V_\alpha$ are
  quasi-smooth (resp. quasi-unramified, quasi-\'etale).
\end{prop}
\begin{demo}
  Assertion (ii) follows from (i), and the quasi-unramified and
  quasi-\'etale cases of (i) are formal consequences of the
  definitions, as in the proof of \cite[IV Prop. 17.1.6]{EGA},
  together with the basic properties of universally noetherian
  morphisms. In the quasi-smooth case the main thing is to prove
  formal smoothness, and we can again follow the argument of
  \textit{loc.\ cit.}, the point being that with the assumptions of
  (i), the set of local liftings $u$ in the diagram
  \ref{eq:formal-smooth-diagram2} is a torsor under the sheaf
  $M=Hom_{\O_{Z_0}}(h^*\diff_{\cX/\cS},\cI)$, and $Z_0$ being an
  affine scheme, this torsor is trivial.
\end{demo}

\begin{prop}
  If $Y\subset\cX$ is a closed subscheme then $i_Y:\hat\cX_\cY\to\cX$
  is quasi-\'etale.
\end{prop}
\begin{demo}
  We know that $i_Y$ is separated and universally noetherian. To show
  it is formally \'etale we may assume $\cX=\Spf{A}$ is affine. In
  fact it is formally unramified since
  $\cdiff_{\hat A/A}\simeq\cdiff_{\hat A/\hat A}=0$, and it is
  formally smooth since for any topological ring $A$, $A\to\hat A$ is
  formally smooth.
\end{demo}

For example, if $\cY\to\cS$ is quasi-smooth and $\cX$ is the
completion of $\cY$ along a closed subscheme then $\cX\to\cS$ is
quasi-smooth. Note that the corresponding morphism of reduced closed
subschemes need not be smooth. The next proposition shows that a
standard criterion for smoothness in the case of a morphism of finite
type remains true in the general case; as a consequence we get a
structure theorem for quasi-smooth morphisms analogous to the usual
one for morphisms of finite type.

\begin{lemma}\label{lemma:local-direct-factor}
  Suppose $B$ is adic and noetherian and $f:M\to N$ is a homomorphism
  of finitely generated $B$-modules. (i) $f$ is the inclusion of a
  direct summand if and only if $\Hom_B(N,L)\to\Hom_B(M,L)$ is
  surjective for all discrete $B$-modules $L$ annihilated by an open
  ideal of $B$. (ii) If $N$ is projective and $\fp\in\Spf{B}$ is such
  that $M_\fp\to N_\fp$ is the inclusion of a direct summand, there is
  a $f\in B\setminus\fp$ such that $M_f\to N_f$ is the inclusion of a
  direct summand.
\end{lemma}
\begin{demo}
  For (i), the condition is clearly necessary, and to show that it is
  sufficient it suffices to show that $\Hom_B(N,L)\to\Hom_B(M,L)$ is
  surjective for all finitely generated $B$-modules $L$. If $L$ is
  finitely generated and $J\subset B$ is an ideal of definition, the
  hypothesis implies that $\Hom_B(N,L/J^nL)\to\Hom_B(M,L/J^n)$ is
  surjective; since $M$ and $N$ are finitely generated this says that
  \begin{displaymath}
    \Hom_B(N,L)\tens_BB/J^n\to\Hom_B(M,L)\tens_BB/J^n
  \end{displaymath}
  is surjective for all $n$, and the assertion follows by the faithful
  flatness of the $J$-adic completion. Part (ii) is a consequence of
  \cite[Cor. 19.1.12]{EGA}.
\end{demo}

\begin{prop}\label{prop:smoothness-criteria}
  Suppose that $\cY/\cS$ and $\cX/\cS$ are universally noetherian and
  $f:\cY\to\cX$ is an $\cS$-morphism. (i) If $\cY\to\cS$ is quasi-smooth,
  then $f$ is quasi-smooth if and only if
  $f^*\diff_{\cX/\cS}\to\diff_{\cY/\cS}$ is the inclusion of a local
  direct summand. (ii) (Jacobian criterion) If $f$ is a closed
  immersion with ideal $\cK$ and $\cX/\cS$ is quasi-smooth, then
  $\cY\to\cS$ is quasi-smooth if and only if
  $\cK/\cK^2\to f^*\diff_{\cX/\cS}$ is the inclusion of a local direct
  summand.
\end{prop}
\begin{demo}
  The hypotheses imply that $\cY\to\cX$ is universally noetherian
  (prop. \ref{prop:properties-of-loc-noeth}, (iii)), so we only have
  to prove formal smoothness in both cases. We may work locally
  everywhere, so we may assume that $\cY\to\cX\to\cS$ is the formal
  spectrum of $R\to A\to B$.  With the notation and terminology of
  \cite[$0_{IV}$ \S20]{EGA}, a morphism $A\to B$ of topological
  algebras is formally smooth if and only if $\Exalcotop_A(B,L)=0$ for
  any discrete $B$-module $L$ annihilated by an open ideal of $B$,
  c.f.\ \cite[$0_{IV}$ 19.4.4]{EGA}. In the situation of the
  proposition there is an exact sequence
  \begin{multline*}
    0\to\Der_A(B,L)\to\Der_R(B,L)\to\Der_R(A,L)\to\\
    \to\Exalcotop_A(B,L)\to\Exalcotop_R(B,L)\to\Exalcotop_R(A,L)
  \end{multline*}
  for any discrete $B$-module $L$ annihilated by an open ideal of $B$
  (c.f. \cite[$0_{IV}$]{EGA} Propositions 20.3.5 and 20.3.6).

  In case (i) we have $\Exalcotop_R(B,L)=0$ for all $L$ as above, and
  thus $\Exalcotop_A(B,L)=0$ if and only if
  $\Der_R(B,L)\to\Der_R(A,L)$ is surjective. Equivalently, $A\to B$ is
  formally smooth if and only if
  $\Hom_B(\cdiff_{B/R},L)\to\Hom_B(B\tens_A\cdiff_{A/R},L)$ is
  surjective for all discrete $L$ annihilated by an open ideal of
  $B$. By (i) of the lemma, this is equivalent to
  $B\tens_A\cdiff_{A/R}\to\cdiff_{B/R}$ being the inclusion of a
  direct summand.

  In the case of (ii) we have $\Exalcotop_R(A,L)=0$ and
  $\Exalcotop_A(B,L)\simeq\Hom_B(K/K^2,L)$ for all $L$. Therefore
  $R\to B$ is formally smooth if and only if
  $\Hom_B(B\tens_A;\cdiff_{A/R},L)\to\Hom_B(K/K^2,L)$ is surjective
  for all $L$. As before, this condition is equivalent to
  $K/K^2\to B\tens_A\cdiff_{A/R}$ being the inclusion of a direct
  summand.
\end{demo}

\begin{cor}
  Let $\cX\to\cS$ be a morphism of formal schemes, $x\in\cX$ is a
  point and $\hat\O_x$ is the completion of the local ring $\O_x$ with
  respect to the adic topology of $\O_\cX$. Suppose that some
  neighborhood $\cV$ of $x$ has a closed embedding $\cV\inj\cY$ over
  $\cS$ into a quasi-smooth $\cS$-scheme $\cY$. If the composite
  morphism $\Spf{\hat\O_x}\to\cS$ is quasi-smooth, there is an open
  neighborhood $\cU$ of $x$ such that $\cU\to\cS$ is quasi-smooth.
\end{cor}
\begin{demo}
  We can assume $\cX=\cV$, and denote by $\cK$ the ideal of
  $f:\cX\to\cY$. Since $\cY\to\cS$ is universally noetherian, so is
  $\cX\to\cS$. By (ii) of lemma \ref{lemma:local-direct-factor} there
  is an open $\cU\sset\cX$ on which the natural map
  $\cK/\cK^2\to f^*\diff_{\cY/\cS}$ is the inclusion of a direct
  summand, and the assertion follows from (ii) of the proposition.
\end{demo}

The condition that $\cX\to\cS$ is locally embeddable into a
quasi-smooth $\cY\to\cS$ is satisfied when $\cX\to\cS$ is of finite
type, so this condition could be regarded as a weak finiteness
property.

The next proposition is a very special case of a very general (and
difficult) criterion of Grothendieck for a homomorphism of topological
rings to be formally smooth, c.f.  \textit{loc. cit.} Th. 19.5.3 and
Cor. 19.5.7, and more particularly \cite[$0_{IV}$ Rem. 19.5.8]{EGA}.
Its conclusion could be taken as a definition of
\textit{differentiably smooth} in the formal case:

\begin{prop}\label{prop:Grothendieck-formal-smoothness}
  Let $A\to B\to C$ be continuous homomorphisms of topological rings,
  and suppose that $A\to C$ formally smooth, $B\to C$ surjective with
  finitely generated kernel $I$, and $B$ is a Zariski ring. Then
  $I/I^2$ is a projective $C$-module and for all $n\ge0$ the natural
  map $\Sym_C^n(I/I^2)\to I^n/I^{n+1}$ is an isomorphism.\nodemo
\end{prop}

\begin{prop}\label{prop:formally-smooth-and-diff-smooth-formal-case}
  Suppose $f:\cX\to\cS$ is a quasi-smooth morphism of locally noetherian
  formal schemes, and let $\cI$ be the ideal of the diagonal of
  $f$. Then
  \begin{enumerate}
  \item $\diff_{\cX/\cS}$ is a locally free $\O_\cX$-module of finite
    type, and
  \item the natural morphism
    \begin{displaymath}
      \Sym^n_{\O_\cX}(\diff_{\cX/\cS})\to\cI^n/\cI^{n+1}
    \end{displaymath}
    is an isomorphism for all $n\ge0$.
  \end{enumerate}
\end{prop}
\begin{demo}
  We may assume that $\cX\to\cS$ is the formal spectrum of $A\to B$,
  so that $A$ and $B$ are noetherian and $A\to B$ is universally
  noetherian. Then $B\ctens_AB$ is noetherian, and in fact a Zariski
  ring, so we may apply to previous proposition with $B$, $C$ and $I$
  replaced by $B\ctens_AB$, $B$ and $\hI=\Ker(B\ctens_AB\to B)$
  respectively. The conclusion follows since $\cI$ is the sheaf of
  ideals associated to $\hI$, and $\diff_{\cX/\cS}$ is the module
  associated to $\hI/\hI^2$.
\end{demo}

\begin{cor}\label{cor:smooth-implies-regular-diagonal}
  If $f:\cX\to\cS$ is a quasi-smooth morphism of locally noetherian
  formal schemes, the diagonal $\cX\to\cX_\cS(r)$ is a regular
  immersion.   
\end{cor}
\begin{demo}
  The assertion is local, so we may assume $\cX=\Spf{A}$ and
  $\cS=\Spf{R}$ affine. Then $\cX_\cS(r)=\Spf{B}$ is a Zariski ring,
  formally smooth over $R$, and the proposition says that the ideal of
  $B\to A$ is quasi-regular. Since $B$ is noetherian it is
  $I$-adically separated, $(f_i)$ is regular by \cite[15.1.9]{EGA}.
\end{demo}

If $\cX/\cS$ is quasi-smooth and $\diff_{\cX/\cS}$ has constant rank, we
call this rank the \textit{formal relative dimension} of $\cX/\cS$,
and denote it by $\fdim{\cX/\cS}$. If $\cX/\cS$ is of finite type,
proposition \ref{prop:diff-of-completions} shows that $\fdim{\cX/\cS}$
is the relative dimension of $X/S$, but this is not true in general.

When $\cX/\cS$ is quasi-smooth we will say that an open affine $U\sset\cX$
is \textit{parallelizable} if there are
$x_1,\ldots,x_d\in\Gamma(U,\O_\cX)$ such that
$\{\md x_1,\ldots,\md x_d\}$ is a basis of
$\Gamma(U,\diff_{\cX/\cS})$; we will also say that the
$x_1,\ldots,x_d$ are \textit{local coordinates} on $U$ for
$\cX/\cS$. It is clear that when $\cX/\cS$ is quasi-smooth, the topology of
$\cX$ has a basis consisting of parallelizable open sets.

As an application we get a structure theorem for quasi-smooth morphisms
similar to the one that obtains for formally smooth morphisms of
finite type:

\begin{cor}\label{cor:structure-of-smooth-morphisms}
  Suppose $f:\cX\to\cS$ is quasi-smooth and $d=\fdim{\cX/\cS}$. Locally on
  $\cX$ there is a factorisation $f=p\circ g$ where
  $g:\cX\to\bA^d_\cS$ is quasi-\'etale and $p:\bA^d_\cS\to\cS$ is the
  canonical projection. In fact this factorisation exists on any open
  parallelizable $U\sset\cX$.
\end{cor}
\begin{demo}
  We may assume $\cX\to\cS$ is $R\to B$ with $B$ a quasi-smooth
  $R$-algebra and $\diff_{B/R}$ free with basis
  $\md x_1,\ldots,\md x_d$. The sections $x_1,\ldots,x_d$ give a
  factorisation $R\to R[T_1,\ldots,T_d]\to B$ with $T_i\mapsto x_i$,
  and since $R\to B$ is continuous this extends to a factorisation
  $R\to R\{T_1,\ldots,T_d\}\to B$. If $A=R\{T_1,\ldots,T_d\}$ is given
  the topology induced by $A$, proposition
  \ref{prop:smoothness-criteria} and the example after equation
  \ref{eq:alternate-cdiff} show that $\cdiff_{B/A}=0$, and $A\to B$ is
  formally unramified. Thus it suffices to show that $A\to B$ is
  formally smooth, which by proposition \ref{prop:smoothness-criteria}
  is so if and only if $B\tens_A\cdiff_{A/R}\to\cdiff_{B/R}$ is a
  local direct summand; by construction however this map is actually
  an isomorphism.
\end{demo}

\begin{prop}\label{prop:etale-and-radicial}
  A morphism of adic locally noetherian formal schemes that is \'etale
  and radicial is an open immersion.
\end{prop}
\begin{demo}
  Suppose $f:\cY\to\cX$ is \'etale and radicial, and let
  $J\subset\O_\cX$ be an ideal of definition. Since $f$ is \'etale it
  is adic, and $f^*J\subset\O_\cY$ is an ideal of definition. If we
  set $X_n=V(J^n)$ and $Y_n=V(J^n\O_\cY)$ then $X_n$, $Y_n$ are
  ordinary schemes and for all $n$ the induced map $f_n:Y_n\to X_n$ is
  \'etale and radicial. It is therefore an open immersion by \cite[IV
  Th. 17.9.1]{EGA}, and since $f$ is the inductive limit of the $f_n$,
  it is an open immersion as well.
\end{demo}

\begin{remark}
  We cannot weaken the hypothesis ``\'etale'' to ``quasi-\'etale.'' In
  fact if $\cX$ is any formal scheme and $\hat\cX_Y$ is the completion
  of $\cX$ along a proper closed subscheme, the canonical morphism
  $i_Y:\hat\cX_Y\to\cX$ is quasi-\'etale and radicial, but not an open
  immersion.
\end{remark}

\begin{prop}\label{prop:flatness-of-Frobenius}
  Let $f:\cX\to\cS$ be a quasi-smooth morphism of formal schemes of
  characteristic $p$. (i) The relative $q$th power Frobenius
  $F_{\cX/\cS}:\cX\to\niv{\cX}{q}$ is flat. (ii) If $f$ is formally of
  finite type, $F_{\cX/\cS}$ is finite.
\end{prop}
\begin{demo}
  We first prove (i) and (ii) in the case when $f$ is of finite
  type. Then $f$ is smooth, and is the inductive limit of a sequence
  of smooth morphisms $f_n:X_n\to S_n$ of schemes; here we choose an
  ideal of definition $J$ of $\cS$, and have set $S_n=V(J^n)$ and
  $X_n=V(f^*J^n)$. Then $F_{X_n/S_n}$ is finite and flat for all
  $n>0$, and for $n'\ge n$ $f_n$ is the reduction modulo $J^n$ of
  $f_{n'}$. It follows that $F_{\cX/\cS}$ is finite and flat.

  We next prove (i) in the general case. Since the assertion to be
  proven is of local nature we may assume $f$ factors
  \begin{displaymath}
    \cX\Xto{g}\cY:=\bA^d_\cS\Xto{p}\cS
  \end{displaymath}
  in which $g$ is quasi-\'etale and $p$ is the natural
  projection. There is a commutative diagram
  \begin{displaymath}
    \xymatrix{
      \cX\ar[rd]^h\ar@/^/[rrd]^{F_{\cX/\cS}}\ar@/_/[rdd]_g\\
      &\cY\times_{\niv{\cY}{q}}\niv{\cX}{q}\ar[r]_{\quad p_2}\ar[d]^{p_1}
      &\niv{\cX}{q}\ar[d]^{\niv{g}{q}}\\
      &\cY\ar[r]_{F_{\cY/\cS}}&\niv{\cY}{q}
    }
  \end{displaymath}
  in which the square is Cartesian. Since $p$ is smooth, $F_{\cY/\cS}$
  is finite and flat, and by base change the same is true for
  $p_2$. Since $F_{\cX/\cS}=h\circ p_2$ it suffices to show that $h$
  is flat. Again by base change $\niv{g}{q}$ and $p_1$ are
  quasi-\'etale, and in particular quasi-unramified; then since $g$ is
  quasi-\'etale, $h$ is quasi-\'etale as well. In particular $h$ is
  quasi-smooth, and therefore flat, as required.

  We assume finally that if $f$ is formally of finite type, and show
  that $F_{\cX/\cS}$ is finite. Again the assertion is local and we
  may assume $f=p\circ g$ with the same diagram as above. By the first
  part of the argument we know that $F_{\cY/\cS}$ is finite, so by
  base change so is $p_2$, and the assertion follows if we show that
  $h$ is an isomorphism. We claim that $h$ is of finite type. In fact
  it is formally of finite type since $g$ is, and its construction
  shows that it is an adic morphism; the claim then follows by \cite[I
  Prop. 10.13.1]{EGA}. Since $h$ is quasi-\'etale and of finite type
  it is \'etale, and since it is also radicial it is an open immersion
  by proposition \ref{prop:etale-and-radicial}. On the other hand
  $F_{\cX/\cS}$ and $F_{\cY/\cS}$ are universal homeomorphisms, and it
  follows first that $p_2$ is a universal homeomorphism, and second
  that $h$ is a universal homeomorphism. We conclude that $h$ is a
  surjective open immersion, i.e. an isomorphism.
\end{demo}

I do not know if there are quasi-smooth morphisms $\cX\to\cS$ such
that $F_{\cX/\cS}$ is not finite.

\subsection{Ordinary Differential Operators.}
\label{sec:diff-ord}

Although we are mainly concerned in this article with arithmetic
differential operators, we will take a moment to observe that the
construction of the usual (Grothendieck) ring of differential
operators extends to the case of a quasi-smooth morphism.

When $\cX/\cS$ is quasi-smooth, the rings $\cP^n_{\cX/\cS}$ are coherent,
locally free $\O_\cX$-modules, as are the $\O_\cX$-modules
\begin{displaymath}
  \Diff^n_{\cX/\cS}=\Hom_{\O_\cX}(\cP^n_{\cX/\cS},\O_\cX)
\end{displaymath}
of differential operators of order $n$. The projection maps for the
$\cP^n_{\cX/\cS}$ induce injective maps
$\Diff^{n'}_{\cX/\cS}\to\Diff^n_{\cX/\cS}$ for $n'\ge0$ and the
$\O_\cX$-module of differential operators
\begin{displaymath}
  \D_{\cX/\cS}=\limdir_n\Diff^n_{\cX/\cS}.
\end{displaymath}
is the direct limit in the category of $\O_\cX$-modules.  On any
parallelizable open affinoid, $\cP^n_{\cX/\cS}$ has a free basis
$\xi^I$, $|I|\le n$ where $\xi=1\ctens x-x\ctens1+I^{n+1}$ (we use the
usual multi-index notation). As usual the basis of $\Diff^n_{\cX/\cS}$
dual to $(\xi^I)_{|I|\le n}$ will be denoted by
$(\dpe{\d_i}{I})_{|I|\le n}$.

The same construction as in the algebraic case (c.f. for example
\cite[$0_{IV}$]{EGA}) gives $\D_{\cX/\cS}$ an $\O_\cX$-ring structure;
recall that this is done by dualizing a family of morphisms
\begin{displaymath}
  \delta_{n,n'}:\cP^{n+n'}_{\cX/\cS}\to\cP^n_{\cX/\cS}\tens\cP^{n'}_{\cX/\cS}
  \qquad
  x\tens y\mapsto x\tens1\tens1\tens y.
\end{displaymath}
(c.f. \cite[IV]{EGA}). Note that no completed tensor products are
involved. 

Although the lack of a category of ``quasicoherent $\O_\cX$-modules''
makes itself felt at this point, the fact that $\D_{\cX/\cS}$ is an
inductive limit of coherent $\O_\cX$-modules means that the sections
of $\D_{\cX/\cS}$ on any open affinoid are easily described; in
particular if $U=\Spf{A}$ is a parallelizable open affinoid in $\cX$
mapping to $\Spf{R}\sset\cS$, the $A$-module of sections
$D_{A/R}=\Gamma(U,\D_{U/\cS})$ is simply the free $R$ module with basis
$(\dpe{\d_i}{I})$. Thus local computations in $\D_{\cX/\cS}$ may be
done just as in the algebraic case.

If
\begin{displaymath}
  \xymatrix{
    \cX'\ar[r]\ar[d]&\cX\ar[d]\\
    \cS'\ar[r]&\cS
  }
\end{displaymath}
is a commutative diagram of locally noetherian formal schemes with
$\cX\to\cS$ and $\cX'\to\cS'$ quasi-smooth, the functoriality morphisms
\begin{displaymath}
 \md f:\Diff^n_{\cX'/\cS'}\to f^*\Diff^n_{\cX/\cS}
\end{displaymath}
are defined as usual; here the $f^*$ must be understood in the sense
of $\O$-modules on ringed spaces. The direct limit
\begin{displaymath}
  f^*\D_{\cX\to\cS}=\limdir_n f^*\Diff^n_{\cX/\cS}
\end{displaymath}
has a $(\Diff^n_{\cX'/\cS'},f^{-1}\Diff^n_{\cX/\cS})$-bimodule
structure, and the morphism
\begin{displaymath}
  \md f:\D_{\cX'/\cS'}\to f^*\D_{\cX\to\cS}
\end{displaymath}
can be used to give one construction of the left $\D_{\cY/\cS}$-module
structure of the inverse image $f^*M$ of a left $\D_{\cX/\cS}$-module $M$.

\subsubsection{Stratifications}
\label{sec:stratifications-algebraic}

Stratifications of an $\O_\cX$-module relative to $\cX/\cS$ are
defined in the same way as in the algebraic case; we review this to
set notation and terminology; we will use the same notation and
terminology for analogous concepts to be discussed later:
$m$-PD-stratifications, $m$-HPD-stratifications, and level $m$
analytic stratifications.

If $f:\cX\to\cS$ is a noetherian morphism of locally noetherian
schemes we denote by $\cX_\cS(r)$ the $(r+1)$-fold iterated fiber
product of $\cX$ over $\cS$, and by $\cX_\cS^n(r)\subset\cX_\cS^{r+1}$
the $n$th order infinitesimal neighborhood of the diagonal. The formal
scheme $\cX^n_\cS(r)$ is finite formally affine over $\cX$,
corresponding to the $\O_\cX$-algebra $\cP^n_{\cX/\cS}(r)$, the ring
of \textit{$r+1$-fold principal parts of order $n$}; when $r=1$ we
drop the $(1)$, and $\cP^n_{\cX/\cS}$ is the ring of principal parts
of order $n$ that was defined earlier. When $\cX=\Spf{A}$ and
$\cS=\Spf{R}$, $\cX^n_\cS(r)$ is the affine formal scheme associated
to the completion $\hat P^n_{A/R}(r)$ of $P^n_{A/R}:=A_R(r)/I^{n+1}$,
where $A_R(r)$ is the completed tensor product of $r+1$ copies of $A$
over $R$, and $I\subset A_R(r)$ is the kernel of the multiplication
map $m:A_R(r)\to A$.

For $r\le r'$ and subsets $K\sset[0,\ldots,r]$,
$K'\sset[0,\ldots,r']$ we denote by
\begin{equation}
  \label{eq:canonical-projections-and-inclusions}
  p^n_K:\cX_\cS^n(r')\to\cX_\cS^n(r)
  \qquad
  i^n_{K'}:\cX_\cS^n(r)\to\cX_\cS^n(r')
\end{equation}
the canonical projections and inclusions; thus
$p_{[0,\ldots,r]}:\cX^n_{\cX/\cS}(r)\to\cX$ is the morphism
correspdonding to the multiplication homomorphism $m:A^n_R(r)\to A$
when $\cX=\Spf{A}$ and $\cS=\Spf{R}$. The morphisms
\ref{eq:canonical-projections-and-inclusions} are induced by
homomorphisms
\begin{equation}
  \label{eq:canonical-projections-and-inclusions-ring}
  d^n_K:\cP^n_{\cX/\cS}(r)\to\cP^n_{\cX/\cS}(r')
  \qquad
  m^n_{K'}:\cP^n_{\cX/\cS}(r')\to\cP^n_{\cX/\cS}(r)
\end{equation}
defined by the inclusion of factors and multiplications; the
superscript $n$ will occaisonally be omitted.

If $M$ is an $\O_\cX$-module, 
a series of isomorphisms 
\begin{equation}
  \label{eq:stratification-algebraic}
  \chi_n:p_1^{n*}M\isom p_0^{n*}M  
\end{equation}
for $n\ge0$ will be said to be \textit{compatible} if
\begin{enumerate}
\item $\chi_0=id_M$,
\item for $n'\ge n$, the restriction of $\chi_{n'}$ to $\cX_S^n$ is
  $\chi_n$,
\end{enumerate}
and a \textit{stratification of $M$ relative to $\cS$} if the cocycle
condition holds as well:
\begin{enumerate}
\item
  $p^{n*}_{01}(\chi_n)\circ p^{n*}_{12}(\chi_n)=p^{n*}_{02}(\chi_n)$
  for all $n\ge0$,
\end{enumerate}
An $\cS$-stratified $\O_\cX$-module is an $\O_\cX$-module with an
(unspecified) stratification. An $\O_\cS$-linear morphism
$(M,\chi_n)\to(M',\chi'_n)$ of $\cS$-stratified $\O_\cX$-modules is
\textit{horizontal} if it is compatible with the stratifications.

% We denote by $\Strat(\cX/\cS)$
% the category of $\cS$-stratified $\O_\cX$-modules, and if $\cS$ is
% understood we will drop it from the terminology and notation.

The data of an $\cS$-stratification $\chi_n$ of $M$ is equivalent to a
family of morphisms
\begin{equation}
  \label{eq:stratification-theta}
  \theta_n=p^{n}_{1*}(\chi_n):M\to p^{n}_{1*}p^{n*}_0(M)
  =M\tens_{\O_\cX}\cP^n_{\cX/\cS}
\end{equation}
for $n\ge0$, $\O_\cX$-linear for the right structure of
$\cP^n_{\cX/\cS}$, which are compatible with the canonical morphisms
$\cP^{n'}_{\cX/\cS}\to\cP^n_{\cX/\cS}$, the identity for $n=0$, and
such that the diagram
\begin{equation}
  \label{eq:cocycle-in-terms-of-theta}
  \xymatrix{
    M\ar[d]^{\theta_{n'}}\ar[r]^{\theta_{n+n'}}
    &M\tens\cP^{n+n'}_{X/S}\ar[d]^{\delta_{n,n'}}\\
    M\tens\cP^{n'}_{X/S}\ar[r]_{\theta_n\tens1\qquad}
    &M\tens\cP^n_{X/S}\tens\cP^{n'}_{X/S}
  }
\end{equation}
commutes for all $n$, $n'\ge0$. 

The same argument as in the algebraic case shows that the category of
left $\D_{\cX/\cS}$-modules is equivalent to the category of
$\cS$-stratified $\O_\cX$-modules. The essential point is the
commutativity of \ref{eq:cocycle-in-terms-of-theta} and the fact that
the product in $\D_{\cX/\cS}$ is defined, essentially, by dualizing
the morphism $\delta_{n,n'}$ in the diagram
\ref{eq:cocycle-in-terms-of-theta}; we refer the reader to
\cite[\S2]{berthelot-ogus:1978} for the details. Finally,
$\cS$-stratified $\O_\cX$-modules have the following ``crystalline''
property: if $M$ is an $\cS$-stratified $\O_\cX$-module and $f$,
$g:\cY\to\cX$ are $\cS$-morphisms of locally noetherian formal schemes
that restrict to the same morphism $Y\to\cX$ on the reduced closed
subscheme $Y\subset\cY$, there is a canonical isomorphism
$\chi(f,g):g^*M\isom f^*M$ of $\O_\cY$-modules; it is an isomorphism
of $\D_{\cY/\cS}$-modules if $\cY\to\cS$ is quasi-smooth. The system of maps
$\chi(f,g)$ is transitive in the sense that
\begin{displaymath}
  \chi(f,g)\circ\chi(g,h)=\chi(f,h)
\end{displaymath}
for any three $f$, $g$, $h:\cY\to\cX$ reducing to the same map in the
reduced closed subscheme of $\cY$.

\section
{Arithmetic Differential Operators}
\label{sec:arith-diff}

\subsection{$m$-PD-structures.}
\label{sec:m-PD-structures}

We are fortunate that the theory of divided power ideals was worked
out in \cite{berthelot:1974} and \cite{berthelot:1990} in a very
general setting, and few modifications are needed to adapt the theory
to the formal case. We will briefly review this theory and how it is
used to construct the arithmetic differential operator rings, pointing
out the few places where perhaps something needs to be said about the
formal case. We will assume the reader is familiar with the
terminology and notation of \cite{berthelot:1996} and
\cite{berthelot:2000}, but we will summarize some of the main points
first.

From now on we fix a prime $p$, and all formal schemes will be formal
schemes over $\bZ_p$ (in addition to being adic and noetherian). All
divided powers will be assumed compatible with the canonical divided
powers of $(p)$.  

\subsubsection{Partial Divided Powers.}
\label{sec:m-PD}

Let $R$ be a commutative ring and $I\subset R$ an ideal. Recall that a
\textit{partial divided power structure of level $m$ on $I$} or an
\textit{$m$-PD-structure on $I$} is a PD-ideal $(J,\gamma)$ in $R$
such that
\begin{displaymath}
  \niv{I}{p^m}+pI\sset J\sset I.
\end{displaymath}
We also say that $(I,J,\gamma)$ is an $m$-PD-structure on $R$, that
$(R,I,J,\gamma)$ is an $m$-PD-ring and that $(I,J,\gamma)$ is an
$m$-PD-ideal in $R$. A morphism $(R,I,J,\gamma)\to(R',I',J',\gamma')$
of $m$-PD-rings is a ring homomorphism $f:R\to R'$ such that
$f(I)\sset I'$ and $f$ induces a morphism $(J,\gamma)\to(J',\gamma')$
of PD-ideals. 

Suppose $R\to A$ is a homomorphism and $(\fa,\fb,\alpha)$,
$(I,J,\gamma)$ are $m$-PD-structures on $R$ and $A$
respectively. Having unwound the definitions in
\cite[\S1.2]{berthelot:1996} we say that $(\fa,\fb,\alpha)$ and
$(I,J,\gamma)$ are \textit{compatible} if the following conditions
hold, in which $\fb_1=\fb+pR$:
\begin{enumerate}
\item $\fb_1A+J$ has a PD-structure inducing the PD-structures
  $\alpha$, $\gamma$ and the canonical PD-structure of $(p)$;
\item $\fb_1A\cap I\sset\fb_1A$ is a sub-PD-ideal.
\end{enumerate}
There are a number of ways to reformulate the first condition,
c.f. \cite[Lemme 1.2.1 and Def. 1.2.2]{berthelot:1996}. The second
condition is used in the construction of the $m$-PD-adic filtration,
see \S\ref{sec:m-PD-adic-filtration} below.  If $K\subset A$ is an
ideal, the $m$-PD-structure $(I,J,\gamma)$ induces an $m$-PD-structure
on $I(A/K)$ such that $A\to A/K$ is an $m$-PD-morphism if and only if
\begin{enumerate}
\item $(J+pA)\cap K$ is a sub-PD-ideal of $J+pA$
\end{enumerate}
and in this situation we will say that the $m$-PD-structure
$(I,J,\gamma)$ \textit{descends to $A/K$.} It is not necessarily
compatible with $(\fa,\fb,\alpha)$; this is the case if and only if
\begin{enumerate}
\item $(J+\fb_1A)\cap K$ is a sub-PD-ideal of $J+\fb_1A$, and
\item $\fb_1A\cap (I+K)$ is a sub-PD-ideal of $\fb_1A$
\end{enumerate}
c.f. \cite[1.3.2 and 1.3.4]{berthelot:1996}. 

If $(I,J,\gamma)$ is an $m$-PD-ideal in $R$, the partially divided
powers $\dpabniv{x}{k}{m}$ of an element $x\in I$ are defined by
\begin{equation}
  \label{eq:powers-and-level-m-powers}
  \dpbrniv{x}{k}{m}=x^r\gamma_q(x^{p^m})
\end{equation}
where $q$ and $r$ are integers satisfying $k=p^mq+r$ and $0\le r<p^m$.
It follows from the definition and the equality $q!\gamma_q(x)=x^q$
that
\begin{displaymath}
  q!\dpbrniv{x}{k}{m}=x^k.
\end{displaymath}
Thus if $p$ is nilpotent in $R$, $I$ is a nilideal. The partially
divided powers have a large number of formal properties which we will
not bother to state here.

\subsubsection{The $m$-PD-adic Filtration.}
\label{sec:m-PD-adic-filtration}

Any $m$-PD-ring $(R,I,J,\gamma)$ has a canonical filtration by ideals
$\dpbrshort{I}{n}\sset R$ with the following properties:
\begin{itemize}
\item $\dpbrshort{I}{0}=R$ and $\dpbrshort{I}{I}=I$.
\item $\dpbrshort{I}{n}\dpbrshort{I}{n'}\sset\dpbrshort{I}{n+n'}$.
\item If $x\in\dpbrshort{I}{n}$ then
  $\dpbrniv{x}{k}{m}\in\dpbrshort{I}{kn}$. 
\item Let $J_1=J+pR$; then for all $n\ge0$, $\dpbrshort{I}{n}\cap J_1$
  is a sub-PD-ideal of $J_1$. In particular $\dpbrshort{I}{n}\cap J$
  is a sub-PD-ideal of $J$.
\end{itemize}
The construction is quite involved and we refer the reader to
\cite[App.]{berthelot:1996}. An $m$-PD-ideal $(I,J,\gamma)$ is
\textit{$m$-PD-nilpotent} if $\dpbrshort{I}{n}=0$ for some $n$.

\subsubsection{The $m$-PD-envelope of an ideal.}
\label{sec:m-PD-envelope}

The principal construction of the theory is the $m$-PD-envelope of an
ideal. Let $(R,\fa,\fb,\alpha)$ be a ring with $m$-PD-structure, $A$
an $R$-algebra and $I\subset A$ an ideal. There is an $m$-PD-ring
\begin{displaymath}
  (P_{(m),\alpha}(I),I^\cani,I^\canj,[\ ])
\end{displaymath}
and an $R$-algebra homomorphism $A\to P_{(m),\alpha}$ such that
$(I^\cani,I^\canj,[\ ])$ is compatible with $(\fa,\fb,\alpha)$ and
having the following universal property: for any $A$-algebra $B$
with an $m$-PD-structure compatible with $(\fa,\fb,\alpha)$, the
structure morphism $A\to B$ factors uniquely through an
$m$-PD-morphism $P_{(m),\alpha}(I)\to B$. The ideal $I^\cani$
(resp. $I^\canj$) is called the \textit{canonical $m$-PD-ideal}
(resp. the \textit{canonical PD-ideal}) of the $m$-PD-envelope
$P_{(m),\alpha}(I)$. 

The quotient of $P_{(m),\alpha}$ by the $(n+1)$-st step of the
$m$-PD-adic filtration is denoted by $P^n_{(m),\alpha}(I)$; it has a
similar universal property with respect to homomorphisms of $A$ to
$m$-PD-nilpotent $m$-PD-rings.  From
\ref{eq:powers-and-level-m-powers} we see that the image of $I$ in
$P^n_{(m),\alpha}(I)$ is a nilideal.

The formation of $P_{(m),\alpha}$ and $P^n_{(m),\alpha}$ commutes with
flat base change: if $A\to A'$ is flat, the natural homomorphisms
$A'\tens_AP_{(m),\alpha}(I)\to P_{A',(m)}(IA')$ and
$A'\tens_AP^n_{(m),\alpha}(I)\to P^n_{A',(m)}(IA')$ are isomorphisms.

\subsubsection{The Regular Case.}
\label{sec:m-PD-regular}

The case when $I\subset A$ is a regular ideal (Zariski-locally
generated by a regular sequence) is particularly nice, and
particularly important. The algebras $P^n_{(m),\alpha}(I)$ are
independent of the $m$-PD-structure of $R$, flat over $R$ and their
formation commutes with arbitrary base change $R\to R'$. Suppose
furthermore that $I$ is generated by a regular sequence
$x_1,\ldots,x_d$, that $A/I$ is flat over $R$ and that the quotient
map $A\to A/I$ has a section $\sigma:A/I\to A$. Then via $\sigma$,
$P^n_{(m),\alpha}(I)$ is a free $A/I$-module on the $m$-PD-polynomials
$\dpbrniv{x}{K}{m}$ for $|K|\le n$ (in the usual multi-index
notation). Furthermore the image of $I^\cani$ in $P^n_{(m),\alpha}(I)$
is free on the $\dpbrniv{x}{K}{m}$ for $|K|>0$, and $I^\canj$ is
generated by $pP^n_{(m),\alpha}(I)$ and by the $\dpbrniv{x}{K}{m}$ for
those $K=(k_1,\ldots,k_d)$ for which at least one entry is $\ge p^m$.

If $p$ is nilpotent in $A$ these assertions hold for the full
$m$-PD-envelope $P_{(m),\alpha}(I)$, the only modification being that
when $A\to A/I$ has a section and $x_1,\ldots,x_d$ is a regular
sequence generating $I$, the $A/I$-module $P_{(m),\alpha}(I)$ is free
on the entire set of $\dpbrniv{x}{K}{m}$.

An important example is the $m$-PD-polynomial algebra
$R\<X_1,\ldots,X_d\>$, defined as the $m$-PD-envelope of the regular
ideal $(X_1,\ldots,X_d)\subset R[X_1,\ldots,X_d]$. Elements of
$R\<X_1,\ldots,X_d\>$ are called $m$-PD-polynomials; as an example of
their use in computation we recall, from the proof of
\cite[Prop. 4.2.1]{berthelot:1996} that for any natural number $r$
divisible by $p^{m+1}$ there is an $m$-PD-polynomial
$\niv{\varphi}{m}_r(X_1,X_2)$ such that for all $t_1$, $t_2$ in some
$m$-PD-ring $(R,I,J,\gamma)$ such that $t_1-t_2\in I$,
\begin{equation}
  \label{eq:varphi}
  t_2^r-t_1^r=p\niv{\varphi}{m}_r(t_1,t_2).
\end{equation}
We may work in $\bZ_{(p)}[X_1]\<X_2-X_1\>$, in which case, writing
$r=p^{m+1}q$, we see that
\begin{align*}
  X_2^r-X_1^r&=((X_1+(X_2-X_1))^{p^{m+1}})^q-X_1^r\\
  &=(X_1^{p^{m+1}}+p(*)+(X_2-X_1)^{p^{m+1}})^q-X_1^r\\
  &=(X_1^{p^{m+1}}+p(*)+p!\dpbrniv{(X_2-X_1)}{p^{m+1}}{m})^q-X_1^r\\
\end{align*}
from which the assertion follows. The identities
\begin{equation}
  \label{eq:varphi-identities}
  \niv{\varphi}{m}_r(X,X)=0,\qquad
  \niv{\varphi}{m}_r(X_1,X_2)+\niv{\varphi}{m}_r(X_2,X_3)
  =\niv{\varphi}{m}_r(X_1,X_3)
\end{equation}
can be proven by reduction to the case of
$\bZ_{(p)}[X_1]\<X_2-X_1\>$. Since the latter has no $p$-torsion,
these identities can be checked after multiplication by $p$, in which
case they are obvious consequences of \ref{eq:varphi}.

\subsubsection{Application to Formal Schemes.}
\label{sec:m-PD-formal-schemes}

The construction of $m$-PD-envelopes sheafifies on a scheme because it
commutes with flat base change, and localizations are flat. Thus if
$S$ is an $m$-PD-scheme and $X$ is an $S$-scheme, any ideal
$I\subset\O_X$ has an $m$-PD-envelope $\cP_{(m),\alpha}(I)$; it is a
quasi-coherent $\O_X$-module satisfying the same universal property as
in the affine case. The same holds for the $\cP^n_{(m),\alpha}(I)$.

Suppose now $\cS$ is an adic locally noetherian formal scheme with an
$m$-PD-structure $(\fa,\fb,\alpha)$, and $\cX$ is a formal
$\cS$-scheme that is adic and locally noetherian. Since formal
localizations are also flat, one might expect that the construction of
$m$-PD-envelopes sheafifies in the same way. However the lack of a
category of quasi-coherent $\O_\cX$-modules makes itself felt at this
point: there is no analogue here of the sheafification procedure that
is available in complete generality for schemes. If $\cI\subset\O_\cX$
is an ideal one can of course sheafify the presheaf of divided power
envelopes of $\cI$ on affines; the trouble starts when one tries to
prove that the ring of sections of this sheaf over an affine open is a
divided power envelope.

The situation is somewhat better for regular ideals, when one is
concerned only with the truncated divided power envelopes. Suppose
$\cI\subset\O_\cX$ is a regular ideal, and that the closed immersion
$\cY\to\cX$ defined by $\cI$ has a retraction $\cX\to\cY$ (i.e. the
quotient map $\O_\cX\to\O_\cX/\cI$ has a section). Let
$U=\Spf{A}\sset\cX$ and $V=\Spf{R}\sset\cS$ be open affines such that
$\cX\to\cS$ maps $U$ into $V$, and $U\to V$ is parallelizable. If we
set $I=\Gamma(U,\cI)$, then by hypothesis $A\to A/I$ has a section
$\sigma$, and we know that $P^n_{(m),\alpha}(I)$ is a free
$A/I$-module of finite rank via the section $\sigma$. For any
$f\in\Gamma(U,\O_\cX)$ the morphism $A\to A_{\{f\}}$ is flat and the
canonical morphism
\begin{displaymath}
  A_{\{f\}}\tens_AP^n_{(m),\alpha}(I)\to P^n_{(m),\alpha}(IA_{\{f\}})
\end{displaymath}
is an isomorphism. Since $P^n_{(m),\alpha}(I)$ is finitely generated
the tensor product may be replaced by a completed tensor
product. Finally, the sections of $\O_\cX\to\O_\cX/\cI$ being used all
come from a single global section. We conclude that there is a
coherent $\O_\cY$-module $\cP^n_{(m),\alpha}(\cI)$ with the property
that
\begin{displaymath}
  \Gamma(U,\cP^n_{(m),\alpha}(\cI))\simeq P^n_{(m),\alpha}(I)
\end{displaymath}
when $U$ is affine and $I=\Gamma(U,\cI)$. Since $\cX$ is locally
noetherian, the ideal $\cI$ is locally nilpotent in
$\cP^n_{(m),\alpha}(\cI)$, and therefore $\cP^n_{(m),\alpha}(\cI)$ is
supported on the closed formal subscheme of $\cX$ defined by $\cI$.

Like its affine counterpart, the $\O_\cX$-algebra
$\cP^n_{(m),\alpha}(\cI)$ has a universal property, best expressed by
introducing the formal scheme
\begin{displaymath}
  \cX^n_{(m),\alpha}(\cI)=\AffSp{\O_\cX}{\cP^n_{(m),\alpha}(\cI)}.
\end{displaymath}
Suppose $f:\cX'\to\cX$ is an $\cS$-morphism of an adic noetherian
formal schemes, and $\cX'$ has an $m$-PD-structure $(\cI',\cJ',\gamma')$
compatible with $(\fa,\fb,\alpha)$ and nilpotent of order $n$. If
$f^*\cI\sset\cI'$, $f$ has a unique factorization
\begin{displaymath}
  \cX'\Xto{g}\cX_{(m),\alpha}(\cI)\Xto{p}\cX
\end{displaymath}
for some $m$-PD-morphism $g$, where $p$ is the morphism corresponding
to the structure map of the coherent $\O_\cX$-algebra
$\cP^n_{(m),\alpha}(\cI)$.

The case of the full $m$-PD-envelope is more difficult, and requires
further hypotheses and no small amount of technicalities. We will deal
with it in section \ref{sec:P_m(I)}.

\begin{lemma}\label{lemma:passing-m-PD-to-quotient}
  Let $A$ be an noetherian ring with $m$-PD-structure
  $(I,J,\gamma)$. For any ideal $K\subset A$, the $m$-PD-structure
  $(I,J,\gamma)$ descends to $A/K^n$ for all sufficiently large $n$.
\end{lemma}
\begin{demo}
  By \ref{sec:m-PD-structures}.3 we need that
  $K^n\cap(J+pA)\sset J+pA$ is a sub-PD-ideal for all $n\gg0$,
  i.e. $\gamma_k(x)\in K^n\cap(J+pA)\sset J+pA$ for all
  $x\in K^n\cap(J+pA)\sset J+pA$ and $k>0$, and since $\gamma_1(x)=x$
  we may assume $k>1$. By Artin-Rees there is an integer $c$ such that
  \begin{displaymath}
    K^n\cap(J+pA)=K^{n-c}(K^c\cap(J+pA))
  \end{displaymath}
  for all $n>c$, and thus for all $x\in K^n\cap(J+pA)$, 
  \begin{displaymath}
    \gamma_k(x)\in K^{k(n-c)}(J+pA)
  \end{displaymath}
  by the basic PD-identities. We are done if $k(n-c)\ge n$, and since
  $k\ge2$ this holds when $n\ge 2c$.
\end{demo}

\begin{remark}
  The conclusion of the lemma can be restated as follows: $A$ has an
  cofinal set of ideals of definition $K$ such that the
  $m$-PD-structure of $A$ descends to $A/K^n$ for \textit{all} $n$; it
  suffices to replace $K$ by $K^N$ for all sufficiently large $N$.
\end{remark}


\subsection{The ring $\niv{\D}{m}_{\cX/\cS}$.}
\label{sec:diff-arith}

Suppose now $\cX\to\cS$ is quasi-smooth.  The considerations of the
last paragraph apply to the sheaf of rings $\O_{\cX_\cS(r)}$ and its
diagonal ideal $\cI$. We denote by $\cP^n_{\cX/\cS,(m)}(r)$ the
corresponding $m$-PD-envelope of order $n$, which is a coherent
locally free $\O_{cX_\cS(r)}$-algebra supported on the image of the
diagonal, and thus a coherent locally free $\O_\cX$-algebra. As before
we drop the $(r)$ when $r=1$. We reuse the notation
\begin{equation}
  \label{eq:canonical-projections-and-inclusions-ring}
  \begin{split}
    d^n_K:\cP^n_{\cX/\cS,(m)}(r)&\to\cP^n_{\cX/\cS,(m)}(r')\\
    m^n_{K'}:\cP^n_{\cX/\cS,(m)}(r')&\to\cP^n_{\cX/\cS,(m)}(r)
  \end{split}
\end{equation}
of \S\ref{sec:stratifications-algebraic} for the canonical projections
and inclusions; their existence follows from the universal property of
the truncated $m$-PD-envelopes. If we define
\begin{equation}
  \label{eq:level-m-diagonal-order-n}
  \cX^n_{\cS,(m)}(r)=\AffSp{\O_\cX}{\cP^n_{\cX/\cS,(m)}(r)}
\end{equation}
then $\cX^n_{\cS,(m)}(r)$ is a finite formally affine formal
$\cX$-scheme, and \ref{eq:canonical-projections-and-inclusions-ring}
induce morphisms 
\begin{equation}
  \label{eq:canonical-projections-and-inclusions}
  p^n_K:\cX_{\cS,(m)}^n(r')\to\cX_{\cS,(m)}^n(r)
  \qquad
  i^n_{K'}:\cX_{\cS,(m)}^n(r)\to\cX_{\cS,(m)}^n(r').
\end{equation}

The $\O_\cX$-module of level $m$ operators of order $\le n$ is defined
to be
\begin{displaymath}
  \Diff^n_{\cX/\cS,(m)}=Hom_{\O_\cX}(\cP^n_{\cX/\cS,(m)},\O_\cX).
\end{displaymath}
As in \cite[\S2.2]{berthelot:1990} the canonical projections
$\cP^{n'}_{\cX/\cS,(m)}\to\cP^n_{\cX/\cS,(m)}$ for
$n'\ge n$ induce injections
$\Diff^n_{\cX/\cS,(m)}\to\Diff^{n'}_{\cX/\cS,(m)}$ and the ring of
\textit{arithmetic differential operators of level $m$} is
\begin{displaymath}
  \niv{\D}{m}_{\cX/\cS}=\limdir_n\Diff^n_{\cX/\cS,(m)}
\end{displaymath}
where again the limit is to be understood in the sense of
$\O_\cX$-modules on the ringed space $(|\cX|,\O_\cX)$. When
$\cX=\Spf{B}$ and $\cS=\Spf{A}$ are affine, we define
$\Gamma(\cX,\Diff^n_{\cX/\cS,(m)})=\Diff^n_{A/R,(m)}$ and
$\Gamma(\cX,\niv{\D}{m}_{\cX/\cS})=\niv{D}{m}_{B/A}$, and then
\begin{displaymath}
  \niv{D}{m}_{B/A}=\limdir_n\Diff^n_{A/R,(m)}
\end{displaymath}
when $\cX$ is noetherian (so that taking global sections commutes with
the inductive limit). When $\cX\to\cS$ is parallelizable with local
coordinates $x_1,\ldots,x_d$, $\cP^n_{\cX/\cS,(m)}$ is the free module
with basis $(\dpniv{\xi}{I}{m})_{|I|\le n}$, where as usual
$\xi_i=1\ctens x_i-x_i\ctens1$. The dual basis of
$\Diff^n_{\cX/\cS,(m)}$ is denoted by
$\{\dpabniv{\d}{K}{m}\}_{|K|\le n}$.

We make $\niv{\D}{m}_{\cX/\cS}$ into a ring by means of a map
\begin{displaymath}
  \delta^{n,n'}_{(m)}:\cP^{n+n'}_{\cX/\cS,(m)}\to
  \cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)} 
\end{displaymath}
arising from $\delta^{n,n'}$ via the universal property of
$m$-PD-envelopes. The formal properties of the ring
$\niv{\D}{m}_{\cX/\cS}$ are the same as in
\cite[\S2.2]{berthelot:1996}, and are proven in the same way; we will
not bother to state them here. 

Once again we should point out that for a morphism $f:\cX'\to\cX$
above $\cS'\to\cS$, the
$(\niv{\D}{m}_{\cX'/\cS'},f^{-1}\niv{\D}{m}_{\cX/\cS})$-bimodule
$f^*\niv{\D}{m}_{\cX/\cS}$ is to be understood in the sense of ringed
spaces. This will not be an issue, as we will see later.

For $m'\ge m$ and all $n\ge0$ there is a canonical $m$-PD-morphism
\begin{displaymath}
  \cP^n_{\cX/\cS,(m')}\to\cP^n_{\cX/\cS,(m)}
\end{displaymath}
arising from the universal property by regarding the canonical
$m'$-PD-ideal of $\cP^n_{\cX/\cS,(m')}$ as an $m$-PD-ideal. Dualizing
this and taking the inductive limit in $n$ results in a ring
homomorphism
\begin{equation}
  \label{eq:Dm-change-of-level}
  \rho_{m',m}:\niv{\D}{m}_{\cX/\cS}\to \niv{\D}{m'}_{\cX/\cS}
\end{equation}
for all $m'\ge m$. In local coordinates it is given by the formula
\begin{equation}
  \label{eq:Dm-change-of-level-explicit}
  \rho_{m',m}(\dpabniv{\d}{K}{m})=\frac{Q!}{Q'!}\dpabniv{\d}{K}{m'}
\end{equation}
where $Q$, $Q'$ are defined by
\begin{displaymath}
  K=p^mQ+R=p^{m'}Q'+R'
\end{displaymath}
with $R<p^m$ (resp. $R'<p^{m'}$).

\subsubsection{Base change.}
\label{sec:base-change}

Let
\begin{equation}
  \label{eq:base-change}
  \xymatrix{
    \cX'\ar[r]^f\ar[d]&\cX\ar[d]\\
    \cS'\ar[r]&\cS
  }
\end{equation}
be a commutative diagram of locally noetherian formal schemes, with
$\cX'\to\cS'$ and $\cX\to\cS$ quasi-smooth and $\cS'\to\cS$ an
$m$-PD-morphism. For any left $\niv{\D}{m}_{\cX/\cS}$-module $M$ there
are, as in \cite[2.2.2]{berthelot:1996} and
\cite[\S2.1]{berthelot:2000} two equivalent ways of placing left
$\niv{\D}{m}_{\cX'/\cS'}$-module structure on $f^*M$. One is via the
natural homomorphism
\begin{equation}
  \label{eq:base-change-level-m}
  \md:\niv{\D}{m}_{\cX'/\cS'}\to\niv{\D}{m}_{\cX'\to\cX}=f^*\niv{\D}{m}_{\cX/\cS}
\end{equation}
which is deduced from the natural homomorphisms
\begin{displaymath}
  f^*\cP^n_{\cX/\cS}\to\cP^n_{\cX'/\cS'}
\end{displaymath}
by duality and passage to the limit; the induced
$(\niv{\D}{m}_{\cX'/\cS'},f^{-1}\niv{\D}{m}_{\cX/\cS})$-bimodule
structure on $\niv{\D}{m}_{\cX/\cS}$ yields a left
$\niv{\D}{m}_{\cX'/\cS'}$-module structure via the canonical
isomorphism
\begin{displaymath}
  \niv{\D}{m}_{\cX'\to\cX}\tens_{f^{-1}\niv{\D}{m}_{\cX/\cS}}M  
  \isom f^*M
\end{displaymath}
(c.f. \cite[2.1.3]{berthelot:2000}). The other method is to use the
commutative diagrams
\begin{displaymath}
  \xymatrix{
    (\cX')^n_\cS\ar[d]_{p_i}\ar[r]^{f\times f}&\cX^n_\cS\ar[d]^{p_i}\\
    \cS'\ar[r]&\cS
  }
\end{displaymath}
for $i=0$, $1$
to show that an $m$-PD-stratification of $M$ relative to $\cS$ pulls
back to an $m$-PD-stratification of $f^*M$ relative to $\cS'$. The
latter method is perhaps more convenient for proving the transitivity
formula $(fg)^*M\simeq g^*f^*M$, c.f. \cite[2.1.1]{berthelot:2000}. On
this point nothing needs to be added to the treatment of
\cite[2.1.3]{berthelot:2000} and \cite[2.1.1]{berthelot:2000}. 

\subsubsection{$m$-PD-stratifications.}
\label{sec:m-PD-stratifications}

An $m$-PD-stratification relative to $\cS$ of an $\O_\cX$-module $M$ is
defined just as before, but with the $\cX^n_{\cS,(m)}(r)$ in place of
the $\cX^n_{\cS}(r)$: it is a series of isomorphisms
\begin{equation}
  \label{eq:m-PD-stratification1}
  \chi_n:p^{n*}_1(M)\isom p^{n*}_0(M)
\end{equation}
satisfying the conditions \ref{sec:stratifications-algebraic}.4--6
(same conditions on different maps!). More generally, a sequence
$\{\chi_n\}_{n\ge0}$ is \textit{compatible} if it satisfies
\ref{sec:stratifications-algebraic}.4--5. The isomorphisms
\ref{eq:m-PD-stratification1} can also be given as a series of
isomorphisms
\begin{equation}
  \label{eq:m-PD-stratification2}
  \chi_n:\cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}M\isom
  M\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}
\end{equation}
of $\O_\cX$-modules with analogous properties, or via the adjunction
isomorphism as a series of morphisms
\begin{equation}
  \label{eq:m-PD-stratification3}
  \theta_n:M\to M\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}
\end{equation}
that are $\O_\cX$-linear for the right structure of
$\cP^n_{\cX/\cS,(m)}$, compatible with the canonical morphisms
$\cP^{n'}_{\cX/\cS,(m)}\to\cP^n_{\cX/\cS,(m)}$ for $n'\ge n$, the
identity for $n=0$, and making commutative the a diagram analogous to
\ref{eq:cocycle-in-terms-of-theta}. The argument that the category of
left $\niv{\D}{m}_{\cX/\cS}$-modules is equivalent to the category of
$\O_\cX$-modules with an $m$-PD-stratification relative to $\cS$ is
the same as the usual one.

\subsection{The ring $\niv{\hD}{m}_{\cX/\cS}$.}
\label{sec:completions}

In the setting of \cite{berthelot:1996}, the next step in the theory
is to form the $p$-adic completion $\niv{\hD}{m}_{\cX/\cS}$ of
$\niv{\D}{m}_{\cX/\cS}$, and then take the inductive limit of the
$\niv{\hD}{m}_{\cX/\cS\bQ}$ to get the full ring of arithmetic
differential operators. We have explained in the introduction why this
is not the thing to do here, and the reader will see a case ofthis
in the proof of theorem \ref{thm:coherence-finite-level}. Instead we
must complete $\niv{\hD}{m}_{\cX/\cS}$ with respect to an ideal of
definition; this does not obviously result in a sheaf of rings, and
what makes this idea workable is the fact that rings like
$\niv{\D}{m}_{\cX/\cS}$ are particularly rich in two-sided ideals,
c.f. corollary \ref{cor:lots-of-bilateralising-ideals}.

We    first    recall    some    definitions    and    results    from
\cite{nastasescu-van-oystaeyen:1982}             (c.f.            also
\cite[\S3.2]{berthelot:1996}). An  (left or right) ideal  $I\subset R$
in a ring is  \textit{central} if it is generated by  a set of central
elements,  and   \textit{centralising}  if   it  is  generated   by  a
centralising sequence, i.e. a sequence $x_1,\ldots,x_n\in R$ such that
for all $i$ the image of $x_i$ in $R/(x_1,\ldots,x_{i-1})$ lies in the
center. A  centralising ideal  is evidently 2-sided,  and when  $R$ is
noetherian the  standard results  from commutative  algebra concerning
$I$-adic  topologies   and  completions   extend  to  the   case  when
$I\subset  R$  is  centralising.  We   refer  the  reader  to  \cite[D
III]{nastasescu-van-oystaeyen:1982}  for   proofs  of   the  following
assertions, in  which $R$ is any  left and right noetherian  ring with
unit and $I$ is a centralising ideal:
\begin{itemize}
\item The Artin-Rees lemma holds in the following form: if $M$ is a
  finitely generated left $R$-module and $N$ is submodule of $M$,
  there is a function $f:\bN\to\bN$ such that
  \begin{displaymath}
    N\cap I^{f(n)}M\sset I^nN.
  \end{displaymath}
\item The $I$-adic completion functor functor $M\mapsto\hat M$ is
  exact on the category of finitely generated left (or right)
  $R$-modules.
\item The completion $\hat R$ is left and right flat over $R$, and 
\item The natural map $\hat R\tens_RM\to\hat M$ is an isomorphism for
  any finitely generated left $R$-module $M$.
\end{itemize}
If $I$ is a central ideal, the function $f$ may be taken to be of the
form $f(n)=c+n$ for some constant $c$, and the proof of the Artin-Rees
lemma is the same as in the commutative case. The general case is more
complicated, c.f. \cite[D V]{nastasescu-van-oystaeyen:1982}. The
remaining statements follow from the first by the usual arguments.

We can relativize the notion of a centralising ideal. Suppose $R\to A$
is a ring homomorphism with $R$ commutative; we say that an ideal
$J\subset R$ is \textit{centralising in $A$} if it is generated by a
sequence whose image in $A$ is centralising. Thus if $J\subset R$ is
centralising in $A$, $JA=AJ$ is a centralising ideal of $A$.

\begin{lemma}\label{lemma:constructing-centralising-ideals}
  Let $R\to A$ be a ring homomorphism with $R$ commutative and
  noetherian. Let $I\subset R$ be an ideal such that $IA$ is a central
  ideal in $A$. Let $J\subset R$ be any ideal and denote by $f:A\to
  A/IA$ the canonical homomorphism. The ideal $J'=J\cap
  f^{-1}(Z(A/I))$ is centralising in $A$.
\end{lemma}
\begin{demo}
  This is an immediate consequence of the definitions; the noetherian
  hypothesis is there to ensure that $J'$ is finitely generated, which
  is implicit in the definition.
\end{demo}

\begin{prop}\label{prop:existence-of-centralising-ideals}
  Suppose $\cX/\cS$ is quasi-smooth and $m\ge0$. Any ideal of
  definition containing the prime $p$ contains an ideal of definition
  that is centralising in $\niv{\D}{m}_{\cX/\cS}$.
\end{prop}
\begin{demo}
  We may assume that $\cX$ and $\cS$ are affine. Let $J\subset\O_\cX$
  be an ideal of definition and write $J=(p,f_1,\ldots,f_n)$. The
  ideal $J'$ constructed in lemma
  \ref{lemma:constructing-centralising-ideals} is topologically
  nilpotent since it is contained in $J$ and open since it contains
  $(p,f_1^{p^{m+1}},\ldots,f_n^{p^{m+1}})$, by
  \cite[prop. 2.2.6]{berthelot:1996}, c.f. also the remark at the end
  of \cite[\S3.2.3]{berthelot:1996}. It is therefore an ideal of
  definition. 
\end{demo}

Suppose $R$ is a commutative ring and $R\to A$ is an $R$-ring. We will
say that an ideal $I\subset R$ is \textit{bilateralising in $A$} if
$IA=AI$. If the reference to $A$ is clear we will simply say
\textit{bilateralising}. The following assertions are immediate:
\begin{enumerate}
\item If $I$ is bilateralising in $A$, $IA\subset A$ is a 2-sided ideal.
\item Sums and products of bilateralising ideals are
  bilateralising. In particular, powers of bilateralising ideals are
  bilateralising. 
\item A centralising ideal in $A$ is bilateralising.
\item If $M$ is a left $A$-module and $I\subset R$ is bilateralising,
  $M/IM$ is a left $A/IA$-module.
\end{enumerate}

\begin{cor}\label{cor:lots-of-bilateralising-ideals}
  The set of ideals of definition of $\O_\cX$ that are bilateralising
  in $\niv{\D}{m}_{\cX/\cS}$ is cofinal in the set of all ideals of
  definition.
\end{cor}
\begin{demo}
  In fact the lemma says that centralising ideals of definition exist,
  and if $J$ is one such, $\{J^n\}_{n\ge0}$ is a cofinal system of
  bilateralising ideals of definition.
\end{demo}

We will say that an ideal $J\sset\O_\cX$ is
\textit{$m$-bilateralising} if it is bilateralising in
$\niv{\D}{m}_{\cX/\cS}$, and if $m$ is understood we will simply say
that $J$ is bilateralising. 

It is easy to characterize the $m$-bilateralising ideals of
$\O_\cX$. We first recall the level $m$ Leibnitz identity
\begin{equation}
  \label{eq:commutation-in-Dm}
  \dpabniv{\d}{K}{m}f=\sum_{I+J=K}\abinom{K}{I}{m}
  \dpabniv{\d}{I}{m}(f)\dpabniv{\d}{J}{m}
\end{equation}
which is \cite[Prop. 2.2.4, (iv)]{berthelot:1996}.

\begin{prop}\label{prop:bilateral-iff-horizontal}
  An ideal $J\subset\O_\cX$ is $m$-bilateralising if and only if it is
  horizontal for $\niv{\D}{m}_{\cX/\cS}$, i.e.
  $\niv{\D}{m}_{\cX/\cS}J\sset J$.
\end{prop}
\begin{demo}
  As usual we may reduce to a parallelizable affine situation. If the
  $\dpabniv{\d}{K}{m}$ are the basic differential operators
  corresponding to a choice of local coordinates, the assertion that
  $J$ is $m$-bilateralising is equivalent to the containments
  \begin{displaymath}
    f\dpabniv{\d}{K}{m}\sset\niv{D}{m}J
    \qquad
    \dpabniv{\d}{K}{m}f\sset J\niv{D}{m}
  \end{displaymath}
  for all $f\in J$ and $K\in\bN^d$. Thus if $J$ is $m$-bilateralising
  and $f\in J$,
  \begin{displaymath}
    \dpabniv{\d}{K}{m}f-f\dpabniv{\d}{K}{m}\in J\niv{D}{m}
  \end{displaymath}
  for all $K\in\bN^d$. Since $\niv{D}{m}$ is free on the
  $\dpabniv{\d}{K}{m}$, \ref{eq:commutation-in-Dm} shows that
  $\dpabniv{\d}{K}{m}(f)\in J$. Conversely if $\niv{D}{m}J\sset J$,
  the containment $\dpabniv{\d}{K}{m}(f)\sset J\niv{D}{m}$ is an
  immediate consequence of \ref{eq:commutation-in-Dm}, and the other
  containment follows from \ref{eq:commutation-in-Dm} by induction on
  $|K|$.
\end{demo}

Since locally $\niv{\D}{m}_{\cX/\cS}$ is generated locally by the
$\dpabniv{\d}{K}{m}$ for $|K|\le p^{m}$, we deduce:

\begin{cor}\label{cor:bilateralising-descends}
  If $J\sset\O_\cX$ is $m'$-bilateralising and $m'\ge m$ then $J$ is
  $m$-bilateralising.\nodemo
\end{cor}

\begin{cor}\label{cor:bilaterals-and-envelopes}
  If $J\sset\O_\cX$ is $m$-bilateralising then
  \begin{displaymath}
    J\cP^n_{\cX/\cS,(m)}=\cP^n_{\cX/\cS,(m)}J
  \end{displaymath}
  for all $n\ge0$.
\end{cor}
\begin{demo}
  If for $f\in\O_\cX$ we set $\delta(f)=d_1(f)-d_0(f)$, it suffices to
  show that $\delta(J)\sset\cP^nJ\cap J\cP^n$ for all $n$. The Taylor
  formula says that
  \begin{displaymath}
    \delta(f)=\sum_{0<|K|\le n}d_0(\dpabniv{\d}{K}{m}(f))\dpniv{\xi}{K}{m}
  \end{displaymath}
  which yields $\delta(J)\sset J\cP^n$ for all $n$. It also
  shows that
  \begin{displaymath}
    \delta(f)=\sum_{0<|K|\le
      n}d_1(\dpabniv{\d}{K}{m}(f))\dpniv{\xi}{K}{m}
    -\sum_{0<|K|\le n}\delta(\dpabniv{\d}{K}{m}(f))\dpniv{\xi}{K}{m}
  \end{displaymath}
  from which we deduce that
  \begin{displaymath}
    \delta(J)\sset\cP^nJ+I^\cani\delta(J)
  \end{displaymath}
  and the result follows by iteration since $I^\cani$ is nilpotent in
  $\cP^n$. 
\end{demo}

If $J\subset\O_\cX$ is any open ideal we denote by $X_J$ the
(ordinary) scheme $(|\cX|,\O_\cX/J)$.  If $J$ is $m$-bilateralising we
set
\begin{equation}
  \label{eq:nivD-XJ}
  \niv{\D}{m}_{X_J/\cS}=\niv{\D}{m}_{\cX/\cS}/J\niv{\D}{m}_{\cX/\cS}
\end{equation}
(the notation is purely formal, since $X_J$ is not quasi-smooth over
$\cS$) which may be regarded indifferently as a sheaf of
$\O_\cX$-rings, or of $\O_\cX/J$-rings on $X_J$. Via the latter
structure, it is clearly a quasicoherent $\O_\cX/J$-module; in fact on
any parallelizable open $U\sset\cX$, $\niv{\D}{m}_{\cX/\cS}$ is free
$\O_\cX$-module on the $\dpabniv{\d}{I}{m}$, so that
$\niv{\D}{m}_{X_J/\cS}$ is a free $\O_\cX/J$-module on the images of
the $\dpabniv{\d}{I}{m}$ (for which we use the same notation).

If $J'\sset J$ is another open $m$-bilateralising ideal there is an
evident homomorphism
\begin{displaymath}
  \niv{\D}{m}_{X_{J'}/\cS}\to\niv{\D}{m}_{X_J/\cS}
\end{displaymath}
of $\O_\cX$-rings, inducing an isomorphism
\begin{displaymath}
  \niv{\D}{m}_{X_{J'}/\cS}\tens_{\O_{J'}}\O_\cX/J
  \isom\niv{\D}{m}_{X_J/\cS}
\end{displaymath}
of $\O_\cX/J$-rings. The $\O_\cX$-ring $\niv{\hD}{m}_{\cX/\cS}$ is the
inverse limit
\begin{equation}
  \label{eq:Dhatm}
  \niv{\hD}{m}_{\cX/\cS}=\liminv_J\niv{\D}{m}_{X_J/\cS}
\end{equation}
where $J$ runs through any cofinal set of ideals of definition of
$\O_\cX$ bilateralising in $\niv{\D}{m}_{\cX/\cS}$. On any
parallelizable open affine $\Spf{A}=U\sset\cX$, elements of
\begin{displaymath}
  \niv{\hat D}{m}_{A/R}=\Gamma(U,\niv{\D}{m}_{\cX/\cS})
\end{displaymath}
may be identified with formal series
$\sum_{I\in\bN^d}a_I\dpabniv{\d}{I}{m}$ with $a_I\to 0$ in the adic
topology of $A$. 

\begin{remark}
  The proof of corollary \ref{cor:lots-of-bilateralising-ideals} shows
  that the inverse limit in \ref{eq:Dhatm} is actually a $J$-adic
  completion for any centralising ideal of definition of $\O_\cX$. In
  particular the properties of such completions summarized in section
  \ref{sec:completions} apply in this case.
\end{remark}

It follows from corollary \ref{cor:bilateralising-descends} that
the natural morphism $\niv{\D}{m}_{\cX/\cS}\to\niv{\D}{m'}_{\cX/\cS}$
extends uniquely to a morphism
\begin{equation}
  \label{eq:Dmhat-change-of-level}
  \hat\rho_{m',m}:\niv{\hD}{m}_{\cX/\cS}\to \niv{\hD}{m'}_{\cX/\cS}.
\end{equation}
In fact in \ref{eq:Dhatm} we can use a set of $J$ bilateralising for
$\niv{\D}{m'}_{\cX/\cS}$ to compute both $\niv{\D}{m}_{\cX/\cS}$ and
$\niv{\D}{m'}_{\cX/\cS}$. The uniqueness of the extensions shows that
this system of morphisms is transitive.

\begin{thm}\label{thm:coherence-finite-level}
  Suppose $\cX\to\cS$ is a quasi-smooth morphism of adic locally
  noetherian schemes. (i) For any open ideal $J\subset\O_\cX$
  bilateralising in $\niv{\D}{m}_{\cX/\cS}$, the ring
  $\niv{\D}{m}_{X_J/\cS}$ is left and right coherent. (ii) The ring
  $\niv{\hD}{m}_{\cX/\cS}$ is left and right coherent.
\end{thm}
\begin{demo}
  For (i) it suffices, by \cite[Prop. 3.1.3]{berthelot:1996} to show
  that (a) for the canonical injection
  $\O_\cX\to\niv{\D}{m}_{X_J/\cS}$, $\niv{\D}{m}_{X_J/\cS}$ is
  quasi-coherent for the $\O_{X_J}$-module structures given by left
  and right multiplication, and (b) for any open affine $U\sset\cX$,
  $\Gamma(U,\niv{\D}{m}_{X_J/\cS}$ is a left and right noetherian. We
  have already seen that (a) is true, and (b) is proven in the same
  way as in \cite[Cor. 2.2.5 (ii)]{berthelot:1996}, i.e. by showing
  the the graded algebra for the filtration by order is finitely
  generated. Since the completion $\niv{\hD}{m}_{\cX/\cS}$ may be
  taken to be the $J$-adic completion for some $J\sset\O_\cX$
  centralising in $\niv{\D}{m}_{\cX/\cS}$, part (ii) follows from the
  facts about centralising ideals recalled in \S\ref{sec:completions},
  c.f also \cite[\S3.2.3]{berthelot:1996} and the last remark in that
  section.
\end{demo}

From \cite[Prop. 3.1.3]{berthelot:1996} we also get:

\begin{prop}\label{prop:coherent-modules-level-m}
  For $\cX\to\cS$ and $J$ as in theorem
  \ref{thm:coherence-finite-level}, a left (resp. right)
  $\niv{\D}{m}_{X_J/\cS}$-module $M$ is coherent if and only if it is
  quasicoherent as an $\O_\cX/J$-module, and for every $U\sset\cX$
  belonging to an open cover of $\cX$, the left (resp. right)
  $\Gamma(U,\niv{\D}{m}_{X_J/\cS})$-module of sections $\Gamma(U,M)$ is
  of finite type.
\end{prop}

The description of coherent left or right
$\niv{\hD}{m}_{\cX/\cS}$-modules is a little more involved, but very
little needs to be added to the treatment of
\cite[\S3.3]{berthelot:1996}. For the reader's convenience we recall
some results regarding completions from \cite[\S3.3]{berthelot:1996},
slightly reformulated for the present purposes. In what follows $\D$
is a sheaf of rings on $\cX$ endowed with a homomorphism
$\O_\cX\to\D$, and we assume that $\D$ satisfies the following
conditions:
\begin{enumerate}
\item $\O_\cX$ has an ideal of definition centralising in $\D$; in
  particular $\O_\cX$ has a fundamental system of ideals of definition
  that are bilateralising in $\D$.
\item For any open affine $U\sset\cX$, $\Gamma(U,\D)$ is left
  noetherian. 
\item As a left $\O_\cX$-module, $\D$ is a filtered inductive limit of
  $\O_\cX$-modules $\D_\lambda$ such that for all $\lambda$,
  $\D_\lambda\simeq\liminv_J\D_\lambda/J\D_\lambda$ (where $J$ runs
  through the set of bilateralising ideals of definition), and for all
  $\lambda$ and bilateralising open $J\sset\O_\cX$,
  $\D_\lambda/J\D_\lambda$ is a quasi-coherent $O_{X_J}$-module.
\end{enumerate}

These hypotheses apply in particular to
\begin{displaymath}
  \D=\niv{\D}{m}_{\cX/\cS},\quad
  \D_J=\niv{\D}{m}_{X_J/\cS},\quad
  \hD=\niv{\hD}{m}_{\cX/\cS}=\liminv_J\D_J
\end{displaymath}
and when $\cX$ is affine we write
\begin{displaymath}
  D=\Gamma(\cX,\niv{\D}{m}_{\cX/\cS}),\quad
  D_J=\Gamma(\cX,\niv{\D}{m}_{X_J/\cS}),\quad
  \hat D=\Gamma(\cX,\niv{\hD}{m}_{\cX/\cS})=\liminv_JD_J.
\end{displaymath}
In the inverse limits we can restrict $J$ to run of the powers of a
centralising ideal; then the results cited at the beginning of
\S\ref{sec:completions} show:

\begin{prop}
  Suppose $\D$ satisfies conditions
  \ref{prop:coherent-modules-level-m}.1--3. (i) For any open affine
  $U\sset\cX$, the ring $\Gamma(U,\hat\D)$ is left noetherian. (ii)
  For any pair of open affines $U'\sset U$, the homomorphism
  \begin{displaymath}
    \Gamma(U,\hat\D)\to\Gamma(U',\hat\D)
  \end{displaymath}
  is right flat.\nodemo
\end{prop}

When $\cX$ is affine we denote by $M\mapsto M^\triangle$ the functor
on $D$-modules defined by
\begin{equation}
  \label{eq:associated-sheaf}
  M^\triangle=\liminv_J(M/JM)\tilde{\relax}
\end{equation}
where the tilde denotes sheaf associated to a $O_{X_J}$-module. If we
identify $M$ with the constant presheaf with value $M$, there is a
natural homomorphism $\D\tens_DM\to M^\triangle$. Arguing as in
\cite[3.3.7--8]{berthelot:1996} we obtain:

\begin{prop}\label{prop:triangle-functor}
  With the above hypotheses and notation,
  \begin{enumerate}
  \item The canonical homomorphism $\hD\to\hat D^\triangle$ is an
    isomorphism.
  \item The functor $M\mapsto M^\triangle$ is exact on the category of
    $\hat D$-modules of finite type.
  \item For any $\hat D$-module $M$ of finite type, the canonical
    homomorphism $M\to\Gamma(\cX,M^\triangle)$ is an isomorphism.
  \item For all $\hat D$-modules $M$, $N$ of finite type, the canonical
    homomorphism
    \begin{displaymath}
      \Hom_{\hat D}(M,N)\to\Hom_{\hD}(M^\triangle,N^\triangle)
    \end{displaymath}
    is an isomorphism.
  \end{enumerate}
\end{prop}

As in \cite[3.3.8]{berthelot:1996}, the essential point is to show
that the canonical homomorphism $\Gamma(\cX,\D_J)\to\hD/J\hD$ is an
isomorphism for all ideals of definition that are bilateralising in
$\D$, and here it is important that $\D_J$ is a quasicoherent
$O_{X_J}$-module. The argument is basically that of \cite[I
10.10.2]{EGA}. Continuing as in \cite[\S3.3]{berthelot:1996} and
\cite[I 10.10]{EGA}, we obtain the following ``theorem A'':

\begin{thm}\label{thm:theorem-A}
  Suppose $\cX$ is affine and $\D$ satsifies conditions
  \ref{prop:coherent-modules-level-m}.1--3. The following are
  equivalent, for any $\hD$-module $\cM$:
  \begin{enumerate}
  \item For every ideal of definition $J\subset\O_\cX$ bilateralising
    in $\D$, the $\D_J$-module $\cM/J\cM$ is coherent, and the
    canonical homomorphism $\cM\to\liminv_J\cM/J\cM$ is an
    isomorphism, where the limit is over ideals of definition
    bilateralising in $\D$.
  \item There is an isomorphism $\cM\isom\liminv_J\cM_J$ where for all
    $J$ as before $\cM_J$ is a coherent $O_{X_J}$-module, and for
    $J\sset K$, the canonical homomorphism
    $\cM_K\tens_{\O_K}O_{X_J}\to \cM_J$ is an isomorphism.
  \item There is a $\hat D$-module $M$ and an isomorphism $\cM\isom
    M^\triangle$.
  \item The $\hat D$-module $\Gamma(\cX,\cM)$ is of finite type and
    the canonical homomorphism
    $\hD\tens_{\hat D}\Gamma(\cX,\cM)\to\cM$ is an isomorphism.
  \item $\cM$ is a coherent $\hD$-module.    
  \end{enumerate}
\end{thm}

\begin{cor}
  Suppose $\cX$ is affine. With the above notation, the functors
  \begin{displaymath}
    \cM\mapsto\Gamma(\cX,\cM),
    \qquad
    M\mapsto M^\triangle
  \end{displaymath}
  are inverse equivalences between the category of coherent
  $\hD$-modules and the category of $\hat D$-modules of finite type.
\end{cor}

We also get ``theorem B'':

\begin{thm}\label{thm:thmB}
  Suppose $\cX$ is affine. With the above notation
  \begin{displaymath}
    H^q(\cX,\cM)=0
  \end{displaymath}
  for any coherent $\hD$-module $\cM$.
\end{thm}

One can also prove, with the same arguments as in
\cite[\S3.5]{berthelot:1996}: 

\begin{thm}\label{thm:flatness-change-of-m}
  For all $m\le m'$, the canonical homomorphism
  \begin{displaymath}
    \niv{\hD}{m}_{\cX/\cS\bQ}\to\niv{\hD}{m'}_{\cX/\cS\bQ}
  \end{displaymath}
  is left and right flat.
\end{thm}

As in \cite[\S2.5]{berthelot:1996} we define
\begin{equation}
  \label{eq:Ddag}
  \Ddag_{\cX/\cS\bQ}=\limdir_m\niv{\hD}{m}_{\cX/\cS\bQ}
\end{equation}
with the inductive limit over the canonical morphisms
\ref{eq:Dmhat-change-of-level}. As in \cite[\S3.5]{berthelot:1996},
theorem \ref{thm:flatness-change-of-m} is the main step in showing
that $\Ddag_{\cX/\cS\bQ}$ is a coherent sheaf of rings. By taking
inductive limits it also follows that the canonical inclusion
\begin{displaymath}
  \niv{\hD}{m}_{\cX/\cS\bQ}\to\Ddag_{\cX/\cS\bQ}
\end{displaymath}
is flat.

Locally on $\cX$ a coherent $\niv{\hD}{m}_{\cX/\cS\bQ}$-module arises
from a coherent $\niv{\D}{m}_{\cX/\cS\bQ}$-module by tensoring with
$\bQ$. When $\cX$ is noetherian it follows that theorem \ref{thm:thmB}
holds for coherent $\niv{\hD}{m}_{\cX/\cS\bQ}$-modules as well, and
for coherent $\Ddag_{\cX/\cS\bQ}$-modules. 

\subsection{The sheaf $\cP_{(m)}(I)$.}
\label{sec:P_m(I)}

We can now return to a question that was left open in section
\ref{sec:m-PD-formal-schemes}, that of the sheafification of the full
$m$-PD-envelope of a regular ideal. As always we begin with the
affine case, so let $R$ be an adic noetherian $\bZ_p$-algebra with
$m$-PD-structure $(\fa,\fb,\alpha)$, $A$ an adic noetherian
$R$-algebra and $I\subset A$ an ideal. For $n\ge0$ we set
$R_n=R/p^{n+1}R$ and $A_n=A/p^{n+1}A$.  We make the following
assumptions on $I$ and $A$:
\begin{enumerate}
\item the ideal $IA_0\subset A_0$ is regular;
\item the quotient homomorphism $p:A\to A/I$ has a section
  $\sigma:A/I\to A$.
\item $A/I$ is a flat $R$-algebra
\end{enumerate}
It will be convenient to set $A'=A/I$.
If $(\bar f_1,\ldots,\bar f_r)$ is a regular sequence generating
$IA_0$ we pick $f_1,\ldots,f_r$ in $I$ lifting
$\bar f_1,\ldots,\bar f_r$. Then $I=(f_1,\ldots,f_r)$ and
$(p,f_1,\ldots,f_r)$ is regular, as is $(p^{n+1},f_1,\ldots,f_r)$ for
all $n\ge0$. It follows that $IA_n$ is regular for all $n\ge0$.

The $m$-PD-structure $(\fa,\fb,\alpha)$ descends to $R_n$ and we
denote by $P_{(m)}(IA_n)$ the $(\fa,\fb,\alpha)$-compatible
$m$-PD-envelope of $IA_n\subset A_n\ctens_RA_n$ (we will never deal
with the full $m$-PD-envelope $P_{(m)}(I)$ of $I\subset A\ctens_RA$).
If we set $A'_n=A'\tens_AA_n$ then $P_{(m)}(IA_n)$ with the
$A'_n$-module structure determined by $\sigma$ is a free
$A'_n$-module, with basis the $m$-PD-monomials in the regular
generators of $IA_n$.

For any $n'\ge n$ there is an isomorphism
\begin{displaymath}
  P_{(m)}(IA_{n'})\tens_{R_{n'}}R_n\isom P_{(m)}(IA_n)
\end{displaymath}
since the formation of $P_{(m)}(IA_n)$ is compatible with arbitrary
base-change in $R_n$. Since this merely says that
\begin{displaymath}
  P_{(m)}(IA_n)\simeq P_{(m)}(IA_{n'})/p^nP_{(m)}(IA_{n'})
\end{displaymath}
we may rewrite it as an isomorphism
\begin{equation}
  \label{eq:P_m-base-change}
  P_{(m)}(IA_{n'})\tens_{A_{n'}}A_n\isom P_{(m)}(IA_n).
\end{equation}
Let $J\subset A$ be an ideal of definition and choose $n\ge0$ such
that $p^{n+1}\in J$. Then $A/J$ is a $A_n$-algebra and the isomorphism
\ref{eq:P_m-base-change} shows that
\begin{equation}
  \label{eq:P_A/R,J}
  P_{J,(m)}(I):=P_{(m)}(IA_n)\tens_{A_n}(A/J)
  \simeq P_{(m)}(IA_n)/JP_{(m)}(IA_n)
\end{equation}
is independent of the choice of $n$ (and justifies the notation).
For $m'\ge m$ there is a natural morphism
\begin{equation}
  \label{eq:PmJ-change-of-level}
  P_{J,(m')}(I)\to P_{J,(m)}(I)
\end{equation}
arising from the fact that an $m$-PD-structure is automatically an
$m'$-PD-structure. Finally, we set
\begin{equation}
  \label{eq:P_A/R-hat}
  \hat P_{(m)}(I)=\liminv_J P_{J,(m)}(I)
\end{equation}
where $J$ runs through the set of ideals of definition of $A$. We
denote by 
\begin{equation}
  \label{eq:completion-of-canonical-m-PD-structure}
  \hat I^\canj\sset\hat I^\cani\subset\hat P_{(m)}(I)
\end{equation}
the closures of $I^\canj$ and $I^\cani$ in $\hat P_{(m)}(I)$ (or
equivalently, the $J$-adic completions). The change-of-level morphisms
\ref{eq:PmJ-change-of-level} induce natural morphisms
\begin{equation}
  \label{eq:hatPmJ-change-of-level}
  \hat P_{J,(m')}(I)\to \hat P_{J,(m)}(I)
\end{equation}
for all $m'\ge m$.

\begin{lemma}\label{lemma:flatness-of-hatP}
  Suppose \ref{sec:P_m(I)}.1--3 hold.  If $R$ is $\bZ_p$-flat, then so
  is $\hat P_{(m)}(I)$.
\end{lemma}
\begin{demo}
  We know that for all $n\ne0$, $P_{(m)}(IA_n)$ is flat over
  $R_n$. Tensoring the exact sequence
  \begin{displaymath}
    0\to p^nR/p^{n+1}R\to R/p^{n+1}R\Xto{p} R/p^{n+1}R
  \end{displaymath}
  with $P_{(m)}(IA_n)$ yields an exact sequence
  \begin{displaymath}
    0\to P_{(m)}(IA_n)\tens_{R_n}p^nR/p^{n+1}R
    \to P_{(m)}(IA_n)\Xto{p}P_{(m)}(IA_n).
  \end{displaymath}
  Since the inverse system $\{p^nR/p^{n+1}R\}$ is essentially null,
  passing to the inverse limit in $n$ shows that multiplication by $p$
  is injective.
\end{demo}

What is not obvious in this construction is whether the canonical
$m$-PD-structure of $P_{(m)}(IA_n)$ descends to $P_{J,(m)}(I)$ when
$p^{n+1}\in J$, or extends to the completion $\hat P_{(m)}(I)$, and if
so, whether the extensions are compatible with $(\fa,\fb,\alpha)$. We
will restrict our attention to the case where $J$ satisfies
\begin{equation}
  \label{eq:special-J1}
  \begin{minipage}{0.6\linewidth}
    $JP_{(m)}(IA_n)=\sigma(J')P_{(m)}(IA_n)$ for some ideal $J'\subset
    A'=A/I$ and some $n$ such that $p^{n+1}\in J'$.
  \end{minipage}
\end{equation}
When $p$ is nilpotent in $A$, $P_{(m)}(I)/I^\cani\simeq A/I\simeq A'$,
and thus \ref{eq:special-J1} implies that $J'=p(J)$ where $p:A\to A'$
is the canonical projection, and we see that \ref{eq:special-J1} is
equivalent to
\begin{equation}
  \label{eq:special-J2}
  \begin{minipage}{0.6\linewidth}
    $\sigma(p(J))P_{(m)}(IA_n)=JP_{(m)}(IA_n)$
    for some $n$ such that $p^{n+1}\in J$.
  \end{minipage}
\end{equation}
For any given $n$, $p^{n+1}\in J$ if and only if $p^{n+1}\in J'$; it follows
that these conditions are independent of the particular value of $n$.
When $I$ is generated by a regular sequence $(x_1,\ldots,x_d)$ and
$J\subset A'$ satisfies \ref{eq:special-J1}, $P_{J,(m)}(I)$ is the
free $A'/J$-module on the $m$-PD-monomials $\dpbrniv{x}{K}{m}$; this
follows from the description of the full $m$-PD-envelope in section
\ref{sec:m-PD-regular}. 

If $A$ has an ideal of definition that satisfies \ref{eq:special-J1}
we can give a similar description of the completion $\hat P_{(m)}(I)$:
elements of $\hat P_{(m)}(I)$ can be identified with series
$\sum_Ka_K\dpbrniv{x}{K}{m}$ with $a_K\in A'$ and $a_K\to0$ as
$|K|\to\infty$. In fact if $J\subset A$ is an ideal of definition
satisfying  \ref{eq:special-J1} then $J^n$ satsifies
\ref{eq:special-J1} as well, and furthermore $J'=p(J)$ is an ideal of
definition of $A'$. The above description of $\hat P_{(m)}(I)$ follows
from the previous description of the $\hat P_{J^n,(m)}(I)$. In
particular
\begin{displaymath}
  \hat P_{(m)}(I)/\hat I^\cani\simeq A'
\end{displaymath}
is a flat $R$-algebra.

\begin{prop}\label{prop:descent-of-m-PD-str-to-P/J}
  Let $R$ be a ring with $m$-PD-structure $(\fa,\fb,\alpha)$, $A$ an
  $R$-algebra, $I\subset A$ an ideal, and assume that
  \ref{sec:P_m(I)}.1--3 hold. Let $J\subset A$ be an ideal satisfying
  \ref{eq:special-J1}. (i) For any $n$ such that $p^{n+1}\in J$, the
  canonical $m$-PD-structure of the $m$-PD-envelope $P_{(m)}(A_nI)$
  descends to $P_{J,(m)}(I)$. (ii) If $\fb_1=\fb+pR$, the
  $m$-PD-structure on $P_{J,(m)}(I)$ is compatible with
  $(\fa,\fb,\alpha)$ if and only if $J'\cap \fb_1A'$ is a sub-PD-ideal
  of $\fb_1A'$.
\end{prop}
\begin{demo}
  If $p^{n+1}\in J$ we can replace $A$ and $I$ by $A_n$ and $IA_n$, which
  is a regular ideal in $A_n$; furthermore $A_n/IA_n$ is a flat
  $R_n$-algebra and the section $\sigma$ induces a section of
  $A_n\to A_n/IA_n$. We may therefore assume that $p$ is nilpotent in
  $A$ and set $P=P_{(m)}(I)$; from \ref{sec:m-PD}.3--5 (c.f. also
  \cite[1.3.4]{berthelot:1996}) we see that the conditions to be
  checked are that the following are sub-PD-ideals:
  \begin{align}
    \label{eq:descent-of-m-PD-to-P/J1}
    (I^\canj+pP)\cap J&\sset I^\canj+pP\\
    \label{eq:descent-of-m-PD-to-P/J2}
    (I^\canj+\fb_1P)\cap J&\sset I^\canj+\fb_1P\\
    \label{eq:descent-of-m-PD-to-P/J3}
    \fb_1P+(I^\cani+J)&\sset\fb_1P
  \end{align}
  where \ref{eq:descent-of-m-PD-to-P/J1} guarantees that the
  $m$-PD-structure of $P$ descends to $P/J$, and
  \ref{eq:descent-of-m-PD-to-P/J2}, \ref{eq:descent-of-m-PD-to-P/J3}
  guarantee that it is compatible with $(\fa,\fb,\alpha)$.  The
  question is Zariski-local so we may assume that $I$ is generated by
  a regular sequence $(x_1,\ldots,x_n)$. Then $P$ is a free
  $A'$-module on the $m$-PD-monomials $\dpbrniv{x}{K}{m}$ and the
  ideals in
  \ref{eq:descent-of-m-PD-to-P/J1}--\ref{eq:descent-of-m-PD-to-P/J3}
  have the following descriptions, where
  $x=\sum_Ka_K\dpbrniv{x}{K}{m}$ and $K<p^m$ means that every entry of
  $K$ is less than $p^m$:
  \begin{align*}
    x\in(I^\canj+pP)\cap J&\iff a_K\in J',\text{\ and\ }
                             K<p^m\implies a_K\in pA'\\
    x\in(I^\canj+\fb_1P)\cap J&\iff a_K\in J',\text{\ and\ }
                             K<p^m\implies a_K\in \fb_1A'\\
    x\in\fb_1P\cap(I^\cani+J)&\iff a_0\in J',\text{\ and\ }a_K\in \fb_1A'.
  \end{align*}
  Thus \ref{eq:descent-of-m-PD-to-P/J1} is a sub-PD-ideal because
  $pA'\cap J'$ is a sub-PD-ideal of $pA'$. If
  \ref{eq:descent-of-m-PD-to-P/J3} is a sub-PD-ideal then
  $\fb_1A'\cap J'$ is a sub-PD-ideal of $\fb_1A'$, and conversely this
  implies that \ref{eq:descent-of-m-PD-to-P/J2} and
  \ref{eq:descent-of-m-PD-to-P/J3} are sub-PD-ideals.
\end{demo}

With the hypotheses of the lemma, $(\fa,\fb,\alpha)$ extends to $A'$,
and the condition in (ii) is equivalent to the assertion that the
$m$-PD-structure $(\fa A',\fb A',\alpha)$ descends to $A'/J'$. Note
that this is automatic if $\fb_1$ is principal, or if $A'/J'$ is a
flat $R$-algebra. 

If $J$ satisfies \ref{eq:special-J1}, $P_{J,(m)}(I)$ has an
$m$-PD-adic filtration, and we denote by $P^n_{J,(m)}(I)$ the quotient
of $P^n_{J,(m)}(I)$ by the $n+1$-st step of that filtration.  On the
other hand the truncations $P^n_{(m)}(I)$ of the full $m$-PD-envelope
of the diagonal commutes with arbitrary base change in $R$, and in
particular with the base change $R\to R_n$. From the construction we
see that $P^n_{J,(m)}(I)$ is isomorphic to
$P^n_{J,(m)}(I)/JP^n_{J,(m)}(I)$.

\begin{cor}\label{cor:descent-of-m-PD-str-to-P/J^n}
  With the assumptions of proposition
  \ref{prop:descent-of-m-PD-str-to-P/J}, for any $J\subset A$
  satisfying \ref{eq:special-J1} the canonical $m$-PD-structure of
  $P_{J^n,(m)}(I)$ is compatible with the $m$-PD-structure
  $(\fa,\fb,\alpha)$ of $R$ for all sufficiently large $n$.
\end{cor}
\begin{demo}
  With the notation of the proposition and its proof, it suffices to
  show that $(J')^n\cap\fb_1A'$ is a sub-PD-ideal of $\fb_1A'$ for
  $n\gg0$, but this follows from lemma
  \ref{lemma:passing-m-PD-to-quotient}. 
\end{demo}

\begin{thm}\label{thm:descent-of-m-PD-str-to-Phat}
  Suppose $A$ and $I\subset A$ satisfy conditions
  \ref{sec:P_m(I)}.1--3, and that $A$ has an ideal of definition
  satisfying \ref{eq:special-J1}. The canonical $m$-PD-structure of
  $P_{(m)}(I)$ extends to an $m$-PD-structure
  $(\hat I^\cani,\hat I^\canj,\hat\gamma)$ on $\hat P_{(m)}(I)$ with
  $\hat I^\cani$ and $\hat I^\canj$ as in
  \ref{eq:completion-of-canonical-m-PD-structure}, and this
  $m$-PD-structure is compatible with $(\fa,\fb,\alpha)$.
\end{thm}
\begin{demo}
  Let $J$ be an ideal of definition of $A$ satisfying
  \ref{eq:special-J1}, and denote by $(I^\cani_n,I^\canj_n,\gamma_n)$
  the quotient $m$-PD-structure of $P_{J^n,(m)}(I)$. By construction
  \begin{displaymath}
    \hat I^\cani=\liminv_n I^\cani_n,\qquad \hat I^\canj=\liminv_n I^\canj
  \end{displaymath}
  and the containments
  $\niv{(I_n^\cani)}{p^m}+p I_n^\cani\sset I_n^\canj$ for all $n$ show
  that $\niv{(\hat I^\cani)}{p^m}+p\hat I^\cani\sset\hat I^\canj$.  If
  $\gamma_n=\{\gamma_{n,k}\}_{k>0}$, the functions
  $\hat\gamma_k=\liminv_n\gamma_{n,k}$ define a PD-structure on
  $\hat I^\canj$, and $(\hat I^\cani,\hat I^\canj,\hat\gamma)$ an
  $m$-PD-structure on $\hat P_{(m)}(I)$. We must show that
  $(\hat I^\cani,\hat I^\canj,\hat\gamma)$ is compatible with
  $(\fa,\fb,\alpha)$; this means that
  $\fb_1\hat P_{(m)}(I)+\hat I^\canj$ has a PD-structure extending the
  PD-structures $\bar\alpha$ of $\fb_1$ and $\hat\gamma$ of
  $\hat I^\canj$, and that $\fb_1\hat P_{(m)}(I)\cap\hat I^\cani$ is a
  sub-PD-ideal of $\fb_1\hat P_{(m)}(I)$. By construction
  $\fb_1P_{(m)}(I)+I^\canj$ has a PD-structure $\{\delta_k\}_{k>0}$
  extending $\bar\alpha$ and $\gamma$; on the other hand corollary
  \ref{cor:descent-of-m-PD-str-to-P/J^n} says that
  $(I^\cani_n,I^\canj_n,\gamma_n)$ of is compatible with
  $(\fa,\fb,\alpha)$ for all $n\gg0$, which implies that for all
  $k>0$, $\delta_k$ is $J$-adically continuous on
  $\fb_1P_{(m)}(I)+I^\canj$. Therefore $\delta$ extends by continuity
  to the closure of $\fb_1P_{(m)}(I)+I^\canj$, and in particular to
  $\fb_1\hat P_{(m)}(I)+\hat I^\canj$. Finally we observed earlier
  that $\hat P_{(m)}(I)/\hat I^\cani\simeq A'$ is a flat $R$-algebra,
  which implies that
  $\fb_1\hat P_{(m)}(I)\cap\hat I^\cani=\fb_1\hat I^\cani$ is a
  sub-PD-ideal of $\fb_1\hat P_{(m)}(I)$.
\end{demo}

The universal properties of these rings are as follows:

\begin{prop}
  Suppose that $A$ has an ideal of definition satisfying
  \ref{eq:special-J1}. (i) Let $A'$ be a \textit{discrete} topological
  $R$-algebra with an $m$-PD-structure $(I',J',\gamma)$ compatible
  with $(\fa,\fb,\alpha)$, and suppose $f:A\to A'$ is a continuous
  $R$-algebra homomorphism such that $f(I)\sset I'$. For any
  $m$-bilateralising ideal of definition $K\subset A$ such that
  $f(K)=0$, $f$ has a unique factorisation
  \begin{displaymath}
    A\to P_{K,(m)}(I)\Xto{f_K}A'
  \end{displaymath}
  in which $f_K$ is an $m$-PD-homomorphism over $R$.  (ii) Suppose
  $A'$ is an adic noetherian $R$-algebra with an $m$-PD-structure
  $(I',J',\gamma)$ compatible with $(\fa,\fb,\alpha)$. Any continuous
  $R$-algebra homomorphism $f:A\to A'$ such that $f(I)\sset I'$ has a
  unique factorization
  \begin{displaymath}
    A\to\hat P_{(m)}(I)\Xto{g}A'
  \end{displaymath}
  in which $g$ is an some $m$-PD-homomorphism $g$ over $R$.
\end{prop}
\begin{demo}
  (i) Pick $n$ such that $p^{n+1}\in J$; then $f$ factors through a
  morphism $f_n:A_n\to A'$, and the $m$-PD-structure $(I',J',\gamma)$
  descends to an $m$-PD-structure $(I'A_n,J'A_n,\bar\gamma)$
  compatible with $(\fa,\fb,\alpha)$. It follows that $f_n$ factors
  through a unique $m$-PD-morphism $f':P_{(m),\alpha}(IA_n)\to A'$,
  and since $JA'=0$, $f'$ factors through an $m$-PD-morphism
  $f':P_{(m),J,\alpha}(I)\to A'$ which is unique since $f'$ is.

  (ii) The same argument as before shows that for all $n\ge0$ the
  reduction $f_n:A_n\to A'_n$ of $f$ factors uniquely through an
  $m$-PD-morphism $P_{(m),\alpha}(IA_n)\to A'_n$ for all $n\ge0$. By
  lemma \ref{lemma:passing-m-PD-to-quotient} we know that $A'$ has an
  ideal of definition $K'$ such that the the $m$-PD-structure of $A'$
  descends to $A/(K')^n$ for all $n$ (c.f. the remark after the
  lemma). We can then find an ideal of definition $K\subset A$ such
  that $f(K)\sset K'$ and the $m$-PD-structure of $A$ descends to
  $A/K^n$ for all $n$. For any particular $n$ we can choose an $n'$
  such that $p^{n'+1}\in K^n$; then the morphism
  $f_{n'}\to P_{(m)}(IA_{n'})\to A'_{n'}$ induces a morphism
  $g_n:P_{(m),K^n}(I)\to A'/(K')^n$. The latter morphism is
  necessarily an $m$-PD-morphism since $f_{n'}$ is, and since
  $P_{(m)}(IA_{n'})\to P_{(m),K^n}(IA_{n'})$ is an
  $m$-PD-morphism. Since $A'$ is $K'$-adically complete, the inverse
  limit of the $g_n$ is an $m$-PD-morphism
  $\hat g:\hat P_{(m)}(I)\to A'$, and the construction shows that it
  is the unique morphism that factors $f$.
\end{demo}

We now globalize these constructions. Let $\cX\to\cS$ be a universally
noetherian morphism of locally noetherian adic formal $\bZ_p$-schemes
and $(\fa,\fb,\alpha)$ is an $m$-PD-structure on $\cS$. We impose on
$\cX/\cS$ and $\cI$ the following global versions of
\ref{sec:P_m(I)}.1--3:
\begin{enumerate}
\item The image of $\cI$ in $\O_\cX\tens_{\bZ_p}\bF_p$ is regular
  ideal;
\item If $\cY=V(\cI)$, the canonical closed immersion $\cY\to\cX$ has
  a retraction $\cX\to\cY$ over $\cS$.
\item $\cY\to\cS$ is flat.
\end{enumerate}
Finally, let $\cJ\subset\O_\cX$ be an ideal satisfying
\ref{eq:special-J1}. We can assume that $\cS=\Spf{R}$ is affine, and
for any affine $U=\Spf{A}\sset\cX$ we set $I=\Gamma(U,\cI)$ and
$J=\Gamma(U,\cJ)$. For any $f\in A$ the $A_n$-algebra $(A_n)_f$ is
flat, and the natural morphism
\begin{displaymath}
  P_{(m)}(IA_n)_f\to P_{(m)}(I(A_n)_f)
\end{displaymath}
is an isomorphism. Thus if $J$ is an open ideal such that
$p^{n+1}\in J$, the natural morphism
\begin{displaymath}
  A_f\tens_AP_{J,(m)}(I)\to P_{J,(m)}(IA_f)
\end{displaymath}
is an isomorphism. It follows that there is a quasicoherent sheaf of
$\O_{X_J}$-algebras $\cP_{\cJ,(m)}(\cI)$ with an $m$-PD-structure such
that for affine opens $U=\Spf{A}\sset\cX$, $V=\Spf{R}\sset\cS$ such
that $\cX\to\cS$ sends $U\to V$,
\begin{displaymath}
  \Gamma(U,\cP_{\cJ,(m)}(\cI))=P_{J,(m)}(I)
\end{displaymath}
where $I=\Gamma(U,\cI)$ and $J=\Gamma(U,\cJ)$. The
$\O_{X_\cJ}$-algebra $\cP_{\cJ,(m)}(\cI)$ gives us an affine morphism
$\cX_{\cS,(m)}^\cJ(\cI)\to\cX$ of formal schemes, where
\begin{equation}
  \label{eq:X_(m),SJ}
  \cX_{\cS,(m)}^\cJ(\cI):=Spec_{\O_{X_\cJ}}(\cP_{\cJ,(m)}(\cI)).   
\end{equation}

Suppose now $\O_\cX$ has an ideal of definition satisfying
\ref{eq:special-J1}. Then it has a cofinal set of such ideals of
definition, and we define
\begin{equation}
  \label{eq:P_A/R-global}
  \cP_{(m)}(\cI)=\liminv_J\cP_{\cJ,(m)}(\cI)
\end{equation}
where $\cJ$ runs through the set of ideals of definition satisfying
\ref{eq:special-J1}. 
If $U=\Spf{A}\sset\cX$ is an open affine mapping to an open affine
$\Spf{A}\sset\cS$ then
\begin{displaymath}
  \Gamma(U,\cP_{(m)}(\cI))\simeq\hat P_{(m)}(I)
\end{displaymath}
where as before $I=\Gamma(U,\cI)$. With the previous notation,
$\cP_{(m)}(\cI)$ is a sheaf of $\O_\cY$-modules whose reduction modulo
$J\subset\O_\cX$ for any $J$ satisfying \ref{eq:special-J1} is the
sheaf $\cP_{J,(m)}(\cI)$. We will attach a formal scheme to
$\cP_{J,(m)}(\cI)$ since this would take us out of the category of
adic locally noetherian formal schemes. As before there is a
change-of-level morphism
\begin{equation}
  \label{eq:Pm-change-of-level}
  \cP_{(m')}(\cI)\to \cP_{(m)}(\cI)
\end{equation}
for $m'\ge m$.

If we continue to suppose that $\O_\cX$ has an ideal of definition
satisfying \ref{eq:special-J1} we may state the universal properties
of $\cX_{(m),\cS}^J\to\cX$ and $\O_\cX\to\cP_{(m)}(\cI)$ as
follows. Suppose, first, that $X'$ is an $\cS$-\textit{scheme} with an
$m$-PD-structure $(I',J',\gamma')$ compatible with $(\fa,\fb,\alpha)$,
and $f:X'\to\cX$ is an $\cS$-morphism such that $f^*\cI\sset I'$.
There is a cofinal set of ideals of definition $J\subset\O_\cX$
satisfying \ref{eq:special-J1} such that $f$ factors
\begin{displaymath}
  X'\to \cX_{(m),\cS}^J(\cI)\Xto{f_J}\cX  
\end{displaymath}
for some unique $m$-PD-morphism $f_J$. Suppose, on the other hand that
$\cX'$ is a formal $\cS$-scheme with an $m$-PD-structure
$(\cI',\cJ',\gamma')$ compatible with $(\fa,\fb,\alpha)$, and
$f:X'\to\cX$ is an $\cS$-morphism such that $f^*\cI\sset\cI'$. Then
the canonical morphism $f^*\O_\cX\to\O_{\cX'}$ has a unique
factorization
\begin{displaymath}
  f^*\O_\cX\to f^*\cP_{(m)}(\cI)\Xto{g}\O_{\cX'}
\end{displaymath}
where $g$ is an $m$-PD-morphism (here the $f^*$ is understood in the
sense of ringed spaces).

\subsection{The sheaf $\cP_{\cX/\cS,(m)}(r)$.}
\label{sec:P_X/S,m}

When $R\to A$ is a quasi-smooth homomorphism of adic noetherian
$\bZ_p$-algebras we can apply the preceding constructions to the
diagonal ideal $I$ of the completed tensor product $A_R(r)$ of $r+1$
copies of $A$ over $R$. Here $I$ is the kernel of the multiplication
map $A_R(r)\to A$, which has $r+1$ sections, namely the maps
$d_i:A\to A_R(r)$ for $0\le i\le r$. Set $R_n=R/p^{n+1}R$ and
$A_n=A/p^{n+1}$ as before, and set $I_n=I(A_n)_{R_n}(r)$. Since
$R_0\to A_0=A\tens_{\bZ_p}\bF_p$ is quasi-smooth, $A_n$ is a flat
$R_n$-algebra and $I_n$ is a regular ideal; therefore the assumptions
\ref{sec:P_m(I)}.1--3 apply to $R$ and $I\subset A_R(r)$.

If $J\subset A$ is any ideal of definition, 
\begin{equation}
  \label{eq:Jr-A}
  J(r)=\sum_{0\le i\le r}d_i(J)A_R(r)
\end{equation}
is an ideal of definition of $A_R(r)$; that it satisfies
\ref{eq:special-J1} with $\sigma=d_i$ for any $i$ follows from:

\begin{lemma}\label{lemma:bilaterals-and-envelopes}
  Suppose $R\to A$ is quasi-smooth and $(\fa,\fb,\alpha)$ is an
  $m$-PD-structure on $R$. If $J\sset A$ is an $m$-bilateralising
  ideal,
  \begin{displaymath}
    J(r) P_{A_n/R_n,(m)}=d_i(J) P_{A_n/R_n,(m)}
  \end{displaymath}
  for $0\le i\le r$ and any $n$ such that $p^n\in J$.
\end{lemma}
\begin{demo}
  As before we reduce to the case where $p^n=0$ in $A$. 
  The canonical isomorphisms
  \begin{displaymath}
    P_{A/R,(m)}(r)\tens_A P_{A/R,(m)}(r')
    \simeq P_{A/R,(m)}(r+r')
  \end{displaymath}
  show that it suffices to treat the case $r=1$, which may be
  rephrased as an equality
  \begin{equation}
    \label{eq:J2}
    JP_{A/R,(m)}=P_{A/R,(m)}J
  \end{equation}
  for all $m$-bilateralising $J$. Set $P=P_{A/R,(m)}$; in the notation
  of corollary \ref{cor:bilaterals-and-envelopes} we must show that
  $\delta(J)\sset JP\cap PJ$, and the same Taylor series argument
  shows that $\delta(J)\sset JP$. By Zariski localization we may
  assume that $A$ has local coordinates relative to $R$, which we may
  use to get a basis $\{\dpniv{\xi}{K}{m}\}_{K\ge0}$ of $P$ as a
  $B$-module via $d_1:B\to P$. The corollary tells us that the image
  of $\delta(J)$ under the natural projection $P\to P^n=P^n_{A/R,(m)}$
  is contained in $P^nJ$ for all $n$. Thus if $x\in\delta(J)$ is
  $\sum_Kd_1(a_K)\dpbrniv{\xi}{I}{m}$ in terms of the basis we have
  $a_K\in J$ for all $K$, and thus $x\in PJ$.
\end{demo}

\begin{remark}
  The equality \ref{eq:J2} looks like the definition of
  ``bilateralising'' but has nothing to do with it, since in fact
  $P_{B/A,(m)}$ is a commutative ring. The ideals $JP_{B/A,(m)}$,
  $P_{B/A,(m)}J$ are the ideals generated by the image of $J$ under
  the two ring homomorphisms $d_0$, $d_1:B\to B_{B/A,(m)}$.
\end{remark}

Suppose now $\cS$ is an adic locally noetherian formal $\bZ_p$-scheme
with $m$-PD-structure $(\fa,\fb,\alpha)$ and $\cX\to\cS$ is
quasi-smooth. We may apply the results of \S\ref{sec:P_m(I)}, with the
result that for any bilateralising $J\subset\O_\cX$ there is a sheaf
$\cP_{\cX/\cS,J,(m)}(r)$ with $r+1$ $\O_\cX$-module structures,
quasi-coherent for any one of them. The sheaf $\cP_{\cX/\cS,(m)}(r)$
is the inverse limit
\begin{equation}
  \label{eq:P_X/S,m}
  \cP_{\cX/\cS,(m)}(r)=\liminv_J\cP_{\cX/\cS,J,(m)}(r)
\end{equation}
where $J$ runs through all bilateralising ideals of definition (this
is another case of dropping the hat in a geometric context). When
$U=\Spf{A}\sset\cX$ is an open affine lying over $\Spf{R}\sset\cS$ we
have
\begin{equation}
  \label{eq:P_X/S,m}
  \Gamma(U,\cP_{\cX/\cS,(m)}(r))\simeq\hat P_{B/A,(m)}(r)
\end{equation}
As before we omit the $(r)$ when $r=1$, and call the two
$\O_\cX$-module structures arising from $d_0$ and $d_1$ the
\textit{left} and \textit{right} structures.

As before, the scheme
\begin{displaymath}
  \cX^J_{\cS,(m)}=\mathit{Spec}_{\O_\cX}(\cP_{\cX/\cS,J,(m)})
\end{displaymath}
is relatively affine over $X_J$, and the inductive system of
$\cX^J_{\cS,(m)}$ has the following universal property. Let $Y$ be a
\textit{scheme} over $\cS$ such that the $m$-PD-structure
$(\fa,\fb,\alpha)$ of $\cS$ extends to $Y$, and let $f_0$,
$f_1:Y\to\cX$ be $\cS$-morphisms congruent modulo $\fa$ in the sense
that if $Y_0\subset Y$ is the closed subscheme defined by $\fa\O_Y$,
the two composite morphisms
\begin{displaymath}
  \xymatrix{
    Y_0\ar[r]&Y\ar@/^/[r]^{f_0}\ar@/_/[r]_{f_1}&\cX
  }
\end{displaymath}
are equal. There is a cofinal set of $J\subset\O_\cX$ such that there
is a unique morphism $g_J:Y\to\cX^J_{\cS,(m)}$ such
that the morphism $(f_0,f_1):Y\to\cX\times_\cS\cX$ factors
\begin{displaymath}
  Y\Xto{g_J}\cX^J_{\cS,(m)}\to X_J\times_\cS X_J
  \to\cX\times_\cS\cX.
\end{displaymath}
Then $f_i=p_i\circ g$ where $p_0$,
$p_1:Spec(\cP_{\cX/\cS,J,(m)})\to\cX$ are the canonical
projections.

\subsection{$m$-HPD-stratifications.}
\label{sec:m-HPD-stratifications}

We have already observed that a left $\niv{\D}{m}_{\cX/\cS}$-module
structure on an $\O_\cX$-module $M$ is equivalent to an
$m$-PD-stratification of $M$ relative to $\cS$. When $J\subset\O_\cX$
is bilateralising this construction can be restricted to the case of
$\O_{X_J}$-modules, yielding an equivalence of the category of left
$\niv{\D}{m}_{X_J/\cS}$-modules with the category of
$\O_{X_J}$-modules endowed with an $\cS$-stratification in the
previous sense. 

With the results of the last section, the following definition is now
possible: an \textit{$m$-HPD-stratification} of an $\O_{X_J}$-module
$M$ relative to $\cS$ is an isomorphism
\begin{equation}
  \label{eq:m-HPD-stratification}
  \chi:\cP_{\cX/\cS,J,(m)}\tens_{\O_{X_J}}M\isom M\tens_{\O_{X_J}}\cP_{\cX/\cS,J,(m)}
\end{equation}
restricting to the identity on the diagonal and satisfying the cocycle
condition. If $\chi$ is an $m$-HPD-stratification, extending scalars
by $\cP_{\cX/\cS,(m)}\to\cP^n_{\cX/\cS,(m)}$ for all $n$ results in an
$m$-PD-stratification of $M$ relative to $\cS$, and $\chi$ is
determined by this $m$-PD-stratification. We may then say that a left
$\niv{\D}{m}_{\cX/\cS,J}$-module $M$ is \textit{quasi-nilpotent} if
its associated $m$-PD-stratification extends to an
$m$-HPD-stratification. The argument of
\cite[Prop. 2.3.7]{berthelot:1996} with $\cP_{\cX/\cS,J,(m)}$ in place
of $\cP_{\cX/\cS}$ then shows:

\begin{prop}\label{prop:nilpotence-criterion}
  A left $\niv{\D}{m}_{\cX/\cS,J}$-module $M$ is quasi-nilpotent if and
  only if for every local section $x$ of $M$ and some system of local
  coordinates (defined in the same neighborhood as $m$),
  $\dpabniv{\d}{I}{m}(x)=0$ for $|I|\gg0$. If this is so, then in fact
  $\dpabniv{\d}{I}{m}(x)=0$ for any system of local coordinates and
  $|I|\gg0$. \nodemo
\end{prop}

\begin{cor}\label{cor:nilpotence-criterion}
  If $M$ is a quasi-nilpotent left $\niv{\D}{m}_{\cX/\cS,J}$-module,
  then so is any submodule or quotient module of $M$, and conversely
  if $M$ is a left $\niv{\D}{m}_{\cX/\cS,J}$-module and $N\sset M$ is
  a submodule such that $N$ and $M/N$ are quasi-nilpotent, then $M$ is
  quasi-nilpotent. If $M$ and $N$ are quasi-nilpotent left
  $\niv{\D}{m}_{\cX/\cS,J}$-modules then so are $M\tens_{\O_\cX}N$ and
  $Hom_{\O_\cX}(M,N)$.\nodemo
\end{cor}

For example, if $J\subset\O_\cX$ is $m$-bilateralising then the
standard $\niv{\D}{m}_{\cX/\cS}$-module structure of $\O_\cX$ induces
a quasi-nilpotent $\niv{\D}{m}_{\cX/\cS,J}$-module structure
$\O_\cX/J$. Applying this to the $\niv{\D}{m}_{\cX/\cS,J^n}$-module
$\O_\cX/J^n$, we see from the corollary that $J^n/J^{n+1}$ is a
quasi-nilpotent $\niv{\D}{m}_{\cX/\cS,J}$-module for all $n\ge0$.

An $\niv{\D}{m}_{X/\cS}$-module $M$ is \textit{topologically
  quasi-nilpotent} if for every bilateralising ideal of definition
$J\subset\O_\cX$ the reduction $M/JM$ is a quasi-nilpotent
$\niv{\D}{m}_{\cX/\cS,J}$-module.

\begin{prop}\label{prop:top-nilpotence-criterion}
  A left $\niv{\D}{m}_{X/\cS}$-module $M$ is topologically
  quasi-nilpotent if and only if $M/JM$ is a quasi-nilpotent
  $\niv{\D}{m}_{\cX/\cS,J}$-module for some $m$-bilateralising ideal
  of definition $J\subset\O_\cX$.
\end{prop}
\begin{demo}
  The condition is evidently necessary, and for the converse it
  suffices to show that if $M/JM$ is quasi-nilpotent for $J$ in the
  proposition then $M/J^nM$ is a quasi-nilpotent
  $\niv{\D}{m}_{\cX/\cS,J^n}$-module for all $n>0$. We have seen that
  $J^k/J^{k+1}$ is a quasi-nilpotent $\niv{\D}{m}_{\cX/\cS,J}$-module
  for all $k$, so by the hypothesis and corollary
  \ref{cor:nilpotence-criterion} the same holds for the tensor product
  $J^k/J^{k+1}\tens_{\O_\cX}M/JM$ and for its quotient
  $J^kM/J^{k+1}M$. Then for $k<n$, $J^kM/J^{k+1}M$ is quasi-nilpotent
  as a $\niv{\D}{m}_{\cX/\cS,J^n}$-module, and corollary
  \ref{cor:nilpotence-criterion} shows that $M/J^n$ is a
  quasi-nilpotent $\niv{\D}{m}_{\cX/\cS,J^n}$-module as well.
\end{demo}

A quasi-nilpotent $\niv{\D}{m}_{X/\cS}$-module $M$ gives rise to an
isomorphism
\begin{equation}
  \label{eq:m-HPD-stratification-limit}
  \chi:\cP_{\cX/\cS,(m)}\ctens_{\O_\cX}M\isom
  M\ctens_{\O_\cX}\cP_{\cX/\cS,(m)} 
\end{equation}
reducing to the identity on the diagonal and satisfying the cocycle
condition; this defines the notion of an $m$-PD-structure on the
$\O_\cX$-module $M$. Suppose, in fact that $M$ is a
$\niv{\D}{m}_{X/\cS}$ such that $M/JM$ arises from an
$m$-PD-stratification $\chi_J$ for all $J$. Since a left
$\niv{\D}{m}_{X/\cS}$-module structure arises from at most one
$m$-PD-stratification on an $\O_{X_J}$-module, the various $\chi_J$ of
the $M/JM$ for variable $J$ must all be compatible, and then
$\chi=\liminv_J\chi_J$ has the required properties. Conversely an
isomorphism \ref{eq:m-HPD-stratification-limit} induces
$m$-PD-stratifications of $M/JM$ for all $J$, all of which correspond
to the same left $\niv{\D}{m}_{X/\cS}$-module structure.

\begin{prop}\label{prop:invariance-of-base-change1}
  Suppose $\cX\to\cS$ is quasi-smooth and $(\fa,\fb,\alpha)$ is an
  $m$-PD-structure on $\cS$, and $M$ is a left
  $\niv{\hD}{m}_{\cX/\cS}$-module. Suppose $\cX'$ is a formal
  $\cS$-scheme such that $(\fa,\fb,\alpha)$ extends to $\cX'$, and let
  $f$, $f':\cX'\to\cX$ be two $\cS$-morphisms having the same
  restriction to the closed formal subscheme $X'_0\subset\cX'$ defined
  by $\fa\O_{\cX'}$. (i) If the $m$-PD-ideal $(\fa,\fb,\alpha)$ is
  $m$-PD-nilpotent, there is a canonical isomorphism
  \begin{displaymath}
    \tau_{f,f'}:(f')^*M\isom f^*M
  \end{displaymath}
  of left $\O_{\cX'}$-modules, such that $\tau_{f,f}=id_{f^*M}$, and
  the system of $\tau_{f,f'}$ is transitive in the sense that if
  $f'':\cX'\to\cX$ is a third such morphism then
  $\tau_{f,f'}\circ\tau_{f',f''}=\tau_{f,f''}$. (ii) If
  $(\fa,\fb,\alpha)$ is not assumed to be $m$-PD-nilpotent, but if $M$
  is a topologically quasi-nilpotent left
  $\niv{\hD}{m}_{\cX/\cS}$-module, the system of $\tau_{f,f'}$ also
  exists and has the same properties. (iii) In either case, in the
  situation of the diagram \ref{eq:base-change} the morphism
  $\tau_{f,f'}$ is $\niv{\D}{m}_{\cX'/\cS'}$-linear.
\end{prop}

The argument is the same as in \cite[Prop. 2.1.5]{berthelot:2000}, and
is a direct consequence of the universal property of the system of
$\cX^J_{\cS,(m)}$. In (iii), the proof of $\niv{\D}{m}$-linearity uses
the compatibility of the canonical ideal of $\cX^n_{\cS,(m)}$ with the
$m$-PD-structure of $\fa$, which relies on the structure theorem
\cite[Prop. 1.5.3]{berthelot:1996} for $m$-PD-envelopes of a regular
ideal.

\subsubsection{Coefficient Rings.}
\label{sec:coefficients}

As in \cite[2.3.4]{berthelot:1996}, a left
$\niv{\D}{m}_{\cX/\cS}$-module structure on a commutative
$\O_\cX$-algebra $\cB$ is \textit{compatible with its algebra
  structure} if the given $\O_\cX$-module structure of $\cB$ coincides
with the one derived from its left $\niv{\D}{m}_{\cX/\cS}$-module
structure, and if the isomorphisms \ref{eq:m-PD-stratification2} are
isomorphisms of $\cP^n_{\cX/\cS,(m)}$-algebras. An equivalent
condition is that the multiplication map $\cB\tens_{\O_\cX}\cB\to\cB$
is $\niv{\D}{m}_{\cX/\cS}$-linear. In local coordinates, this is
equivalent to the level $m$ Leibnitz rule
\begin{equation}
  \label{eq:Leibnitz-coefficient-rings}
  \dpabniv{\d}{K}{m}(ab)
  =\sum_{I+J=K}\bbinom{K}{I}{m}\dpabniv{\d}{I}{m}(a)\dpabniv{\d}{J}{m}(b)
\end{equation}
holding for all local sections $a$, $b$ of $\cB$. 

When $\cB$ is an $\O_\cX$-algebra with a compatible left
$\niv{\D}{m}_{\cX/\cS}$-module structure, the $\O_\cX$-module
$\cB\tens_{\O_\cX}\niv{\D}{m}_{\cX/\cS}$ has a unique ring structure
such that the canonical inclusions
\begin{align*}
  \cB\to\cB\tens_{\O_\cX}\niv{\D}{m}_{\cX/\cS}\qquad &b\mapsto b\tens1\\
  \niv{\D}{m}_{\cX/\cS}\to\cB\tens_{\O_\cX}\niv{\D}{m}_{\cX/\cS}
  \qquad&P\mapsto 1\tens P\\
\end{align*}
are ring homomorphisms. The product is defined as follows: with the
identification
\begin{equation}
  \label{eq:DmB/s-mult1}
  \cB\tens_{\O_\cX}\Diff^n_{\cX/\cS,(m)}
  \simeq\Hom_{\O_\cX}(\cP^n_{\cX/\cS,(m)},\cB)
\end{equation}
the product of local sections
$P\in\cB\tens_{\O_\cX}\Diff^{n'}_{\cX/\cS,(m)}$,
$Q\in\cB\tens_{\O_\cX}\Diff^n_{\cX/\cS,(m)}$ is
\begin{equation}
  \label{eq:DmB/s-mult2}
  \begin{split}
    \cP^{n+n'}_{\cX/\cS,(m)}
    &\Xto{\delta^{n,n'}}\cP^{n'}_{\cX/\cS,(m)}\tens\cP^n_{\cX/\cS,(m)}\\
    &\Xto{1\tens Q}\cP^{n'}_{\cX/\cS,(m)}\tens\cB\\
    &\Xto{\chi_{n'}}\cB\tens\cP^{n'}_{\cX/\cS,(m)}\\
    &\Xto{P}\cB\tens\cB\to\cB
  \end{split}
\end{equation}
where $\chi$ is the stratification of $\cB$.

Since on occaison we will be considering
several $\cB$ at once we will use the notation
\begin{equation}
  \label{eq:D-with-coefficients}
  \niv{\D}{m}_{\cB/\cS}=\cB\tens_{\O_\cX}\niv{\D}{m}_{\cX/\cS}
\end{equation}
in preference to that of \cite{berthelot:1996}. For any open affine
$U\sset\cX$ the canonical homomorphism
\begin{equation}
  \label{eq:coefficient-ring}
  \Gamma(U,\cB)\tens_{\Gamma(U,\O_\cX)}\Gamma(U,\niv{\D}{m}_{\cX/\cS})\to
  \Gamma(U,\niv{\D}{m}_{\cB/\cS})
\end{equation}
is an isomorphism; argument is the same as that of
\cite[Prop. 2.3.6]{berthelot:1996} and depends mainly on the fact that
$\niv{\D}{m}_{\cX/\cS}$ is an inductive limit of locally free
$\O_\cX$-modules. Suppose now that $\cB$ satisfies the conditions
\begin{enumerate}
\item for every open affine $U\sset\cX$, $\Gamma(U,\cB)$ is
  noetherian;
\item for every ideal of definition $J\sset\O_\cX$; $\cB/J\cB_J$ is a
  quasi-coherent $O_{X_J}$-algebra;
\item $\cB\simeq\liminv_J\cB/J\cB$ where the inverse limit is over
  ideals of definition of $\cX$.
\end{enumerate}
We define
\begin{equation}
  \label{eq:coefficient-ring-complete}
  \niv{\hD}{m}_{\cB/\cS}=\liminv_J(\cB/J\cB)
  \tens_{\O_\cX}\niv{\D}{m}_{\cX/\cS}
\end{equation}
where the inverse limit is over $m$-bilateralising ideals of
definition. Then $\niv{\hD}{m}_{\cB/\cS}$ is a ring, and the previous
discussion shows that a left $\niv{\hD}{m}_{\cB/\cS}$-module is the
same as $\cB$-module with a compatible left
$\niv{\hD}{m}_{\cX/\cS}$-module structure in the previous sense. With
the hypotheses \ref{sec:coefficients}.3--5 on $\cB$, theorem
\ref{thm:coherence-finite-level}, \ref{thm:theorem-A} and its
corollary, theorem \ref{thm:thmB} and propositions
\ref{prop:coherent-modules-level-m}, \ref{prop:triangle-functor} hold
for $\niv{\hD}{m}_{\cB/\cS}$ without modification; we will not bother
to restate them.

For later use we reformulate the condition that an $\O_\cX$-algebra
$\cB$ has an $m$-PD-stratification of an $\O_\cX$ compatible with its
algebra structure. Suppose $\cP^n_{\cB/\cS,(m)}$ is an
$\O_{\cP^n_{\cX/\cS,(m)}}$-algebra and 
\begin{equation}
  \label{eq:cP_B^n}
  \begin{split}
    \alpha^n_0:\cB\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}&\isom\cP^n_{\cB/\cS,(m)}\\
    \alpha^n_1:\cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB&\isom\cP^n_{\cB/\cS,(m)}
  \end{split}
\end{equation}
are isomorphisms of $\cP^n_{\cX/\cS,(m)}$-algebras. We will say that
$\{\alpha^n_0\}_{n\ge0}$ and $\{\alpha^n_1\}_{n\ge0}$ are compatible
if for $n'\ge n$ they define the same morphism
$\cP^{n'}_{\cB/\cS,(m)}\to\cP^n_{\cB/\cS,(m)}$ and for $n=0$ they
yield the same identification $\cP^0_{\cB/\cS,(m)}\simeq\cB$. If
$\{\alpha^n_0\}_{n\ge0}$ and $\{\alpha^n_1\}_{n\ge0}$ are compatible,
the isomorphisms
\begin{equation}
  \label{eq:alpha-to-chi}
  \chi_n=(\alpha^n_0)^{-1}\circ\alpha^n_1:
  \cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB\to\cB\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}  
\end{equation}
are compatible in the previous sense. Conversely if $\chi_n$ is given
we set $\cP^n_{\cB/\cS,(m)}=\cB\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}$; then
$\alpha^n_0=id$ and $\alpha^n_0=\chi_n$ are compatible.

In any case the isomorphisms \ref{eq:cP_B^n} give
$\cP^n_{\cB/\cS,(m)}$ a $(\cB,\cB)$-bimodule structure, the left
(resp. right) one arising from $\alpha^n_0$
(resp. $\alpha^n_1$). These structures are exchanged by the
isomorphism $\chi_n=(\alpha^n_0)^{-1}\circ\alpha^n_1$, and by
construction $\chi_n$ is $\cP^n_{\cX/\cS,(m)}$-linear.

Given \ref{eq:cP_B^n} one can define two ring homomorphisms
\begin{displaymath}
  \cP^{n+n'}_{\cB/\cS,(m)}\to\cP^n_{\cB/\cS,(m)}\tens_\cB\cP^{n'}_{\cB/\cS,(m)}
\end{displaymath}
as follows. With the identification
\begin{align*}
  \cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB
  \tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)}
  &\simeq(\cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB)\tens_\cB
    (\cB\tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)})\\
  &\underset{\sim}{\Xto{\alpha^n_1\tens\alpha^{n'}_0}}
  \cP^n_{\cB/\cS,(m)}\tens_\cB\cP^{n'}_{\cB/\cS,(m)}
\end{align*}
the first is the composite
\begin{equation}
  \label{eq:P_B-delta1}
  \begin{split}
    \delta^{n,n'}_{\cB,0}:\cP^{n+n'}_{\cB/\cS,(m)}
    &\Xto{\alpha^{n+n'}_0}\cB\tens_{\O_\cX}\cP^{n+n'}_{\cX/\cS,(m)}\\
    &\Xto{\delta^{n,n'}\tens1}\cB\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}
    \tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)}\\
    &\Xto{\chi_n^{-1}\tens 1}\cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB
    \tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)}%\\
  \end{split}
\end{equation}
and the second is the composite
\begin{equation}
  \label{eq:P_B-delta2}
  \begin{split}
    \delta^{n,n'}_{\cB,1}:\cP^{n+n'}_{\cB/\cS,(m)}
    &\Xto{\alpha^{n+n'}_1}\cP^{n+n'}_{\cX/\cS,(m)}\tens_{\O_\cX}\cB\\
    &\Xto{\delta^{n,n'}\tens1}\cP^n_{\cX/\cS,(m)}
    \tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)}\tens_{\O_\cX}\cB\\    
    &\Xto{\chi_{n'}\tens 1}\cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB
    \tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)}.
  \end{split}
\end{equation}
Note that $\cP^n_{\cB/\cS,(m)}\tens_\cB\cP^{n'}_{\cB/\cS,(m)}$
has a $(\cB,\cB)$-bimodule structure, coming from $d_0\tens1$ on the
left and and $1\tens d_1$ on the right. By construction,
$\delta^{n,n'}_{\cB,0}$ is $\cB$-linear for the left structure and
$\delta^{n,n'}_{\cB,1}$ is $\cB$-linear for the right structure.

\begin{prop}\label{prop:m-PD-stratified-algebra}
  For any compatible system of isomorphisms \ref{eq:cP_B^n}, the
  following are equivalent:
  \begin{enumerate}
  \item The isomorphisms \ref{eq:alpha-to-chi} define an
    $m$-PD-stratification of $\cB$ compatible with its
    $\O_\cX$-algebra structure.
  \item For all $n$, $n'\ge0$,
    $\delta^{n,n'}_{\cB,0}=\delta^{n,n'}_{\cB,1}$. 
  \item There is a ring homomorphism
    \begin{equation}
      \label{eq:delta^B1}
      \delta^{n,n'}_\cB:\cP^{n+n'}_{\cB/\cS,(m)}\to\cP^n_{\cB/\cS,(m)}
      \tens_\cB\cP^{n'}_{\cB/\cS,(m)}     
    \end{equation}
    that is a homomorphism of $(\cB,\cB)$-bimodules and semilinear for
    the homomorphism
    $\delta^{n,n'}:\cP^{n+n'}_{\cX/\cS,(m)}\to\cP^n_{\cX/\cS,(m)}
    \tens_{\O_\cX}\cP^{n'}_{\cX/\cS,(m)}$.
  \end{enumerate}
\end{prop}
\begin{demo}
  Only the cocycle condition needs to be checked.  In the following
  calculations we drop the $(m)$. Consider the diagram
  \begin{displaymath}
    \xymatrix{
      \cP^{n+n'}_{\cX/\cS}\tensu{\O_\cX}{\cB}\ar[rr]^{\chi_{n+n'}}
      \ar[d]_{\delta^{n,n'}\tens1}
      &&
      \cB\tensu{\O_\cX}{\cP^{n+n'}_{\cX/\cS}}\ar[d]^{1\tens\delta^{n,n'}}\\
      \cP^n_{\cX/\cS}\tensu{\O_\cX}{\cP^{n'}_{\cX/\cS}}\tensu{\O_\cX}{\cB}
      \ar[r]^{1\tens\chi_{n'}}
      \ar[d]_{1\tens\chi_{n'}}
      &\cP^n_{\cX/\cS}\tensu{\O_\cX}{\cB}\tensu{\O_\cX}{\cP^{n'}_{\cX/\cS}}
      \ar[r]^{\chi_n\tens1}\ar@{=}[d]
      &\cB\tensu{\O_\cX}{\cP^n_{\cX/\cS}}\tensu{\O_\cX}{\cP^{n'}_{\cX/\cS}}
      \\
      \cP^n_{\cX/\cS}\tensu{\O_\cX}{\cB}\tensu{\O_\cX}{\cP^n_{\cX/\cS}}
      \ar@{=}[r]
      &(\cP^n_{\cX/\cS}\tensu{\O_\cX}{\cB})\tensu\cB(\cB
      \tensu{\O_\cX}{\cP^n_{\cX/\cS}})\ar@{=}[r]
      &\cP^n_{\cX/\cS}\tensu{\O_\cX}{\cB}\tensu{\O_\cX}{\cP^n_{\cX/\cS}}
      \ar[u]_{\chi_n\tens1}
    }
  \end{displaymath}
  where the equalities denote the appropriate canonical isomorphisms. By
  \cite[Prop. 2.3.2]{berthelot:1996} the cocycle condition for $\chi_n$
  is equivalent to the commutativity of the top rectangle. The equality
  $\delta^{n,n'}_{\cB,0}=\delta^{n,n'}_{\cB,1}$ is equivalent to the
  commutativity of the outside square. Since all morphisms in lower part
  of the diagram are isomorphisms, \ref{prop:m-PD-stratified-algebra}.1
  and \ref{prop:m-PD-stratified-algebra}.2 are equivalent.

  Since $\chi_n$ (resp. $\chi_{n'}$) is $\cP^n_{\cX/\cS,(m)}$-linear
  (resp. $\cP^{n'}_{\cX/\cS,(m)}$-linear) the morphisms
  $\delta^{n,n'}_{\cB,0}$ and $\delta^{n,n'}_{\cB,1}$ are semilinear
  for $\delta^{n,n'}$. Since $\delta^{n,n'}_{\cB,0}$
  (resp. $\delta^{n,n'}_{\cB,1}$) $\cB$-linear for the left
  (resp. right) structure, \ref{prop:m-PD-stratified-algebra}.2
  implies \ref{prop:m-PD-stratified-algebra}.3 with
  $\delta^{n,n'}_\cB= \delta^{n,n'}_{\cB,0}=\delta^{n,n'}_{\cB,1}$.
  Suppose conversely that \ref{prop:m-PD-stratified-algebra}.3
  holds. Since $\cP^{n+n'}_{\cB/\cS,(m)}$ is generated as a
  $\cB$-module (for either structure) by the image of
  $\cP^{n+n'}_{\cX/\cS,(m)}\to\cP^{n+n'}_{\cB/\cS,(m)}$,
  $\delta^{n,n'}_{\cB,0}$ (resp. $\delta^{n,n'}_{\cB,1}$) is the
  unique morphism that is semilinear for $\delta^{n,n'}$ and
  $\cB$-linear for the left (resp. rignt) $\cB$-structure. Thus
  \ref{prop:m-PD-stratified-algebra}.2 implies
  \ref{prop:m-PD-stratified-algebra}.3.
\end{demo}

We will let the reader check that the definition of the product given
by \ref{eq:DmB/s-mult1} and \ref{eq:DmB/s-mult2} can be rephrased in
terms of $\cP^n_{\cB/\cS,(m)}$ as follows. The isomorphism
\ref{eq:DmB/s-mult1} may be rewritten
\begin{equation}
  \label{eq:DmB/s-mult3}
  \cB\tens_{\O_\cX}\Diff^n_{\cX/\cS,(m)}\simeq\Hom_\cB(\cP^n_{\cB/\cS,(m)},\cB)
\end{equation}
and with this identification the product of
$P\in\Hom_\cB(\cP^{n'}_{\cB/\cS,(m)},\cB)$ and
$Q\in\Hom_\cB(\cP^n_{\cB/\cS,(m)},\cB)$ is
\begin{equation}
  \label{eq:DmB/s-mult4}
  \begin{split}
    \cP^{n+n'}_{\cB/\cS,(m)}
    &\Xto{\delta^{n,n'}_\cB}\cP^{n'}_{\cB/\cS,(m)}\tens_\cB\cP^n_{\cB/\cS,(m)}\\
    &\Xto{1\tens Q}\cP^{n'}_{\cX/\cB,(m)}\Xto{P}\cB
  \end{split}
\end{equation}

We can treat $m$-HPD-stratified $\O_\cX$-algebras in the same way. A
pair of ring isomorphisms
\begin{equation}
  \label{eq:cP_B}
  \begin{split}
    \alpha_0:\cB\ctens_{\O_\cX}\cP_{\cX/\cS,(m)}&\isom\cP_{\cB/\cS,(m)}\\
    \alpha_1:\cP_{\cX/\cS,(m)}\ctens_{\O_\cX}\cB&\isom\cP_{\cB/\cS,(m)}
  \end{split}
\end{equation}
is \textit{compatible} if they induce the same surjective homomorphism
$\cP_{\cB/\cS,(m)}\to\cB$. As before they induce a
$(\cB,\cB)$-module structure on $\cP_{\cB/\cS,(m)}$ via $d_0$ and
$d_1$,  and on
$\cP_{\cB/\cS,(m)}\ctens_\cB\cP_{\cB/\cS,(m)}$ via $d_0\tens1$ and
$1\tens d_1$.

\begin{prop}\label{prop:m-HPD-stratified-algebra}
  A pair of compatible ring isomorphisms \ref{eq:cP_B} defines an
  $m$-HPD-stratification of $\cB$ compatible with its ring structure
  if and only there is a ring homomorphism
  \begin{equation}
    \label{eq:delta^B3}
    \delta_{\cB,(m)}:\cP_{\cB/\cS,(m)}\to\cP_{\cB/\cS,(m)}
    \ctens_\cB\cP_{\cB/\cS,(m)}     
  \end{equation}
  that is $(\cB,\cB)$-bilinear and semilinear for the homomorphism
  \begin{displaymath}
    \delta:\cP_{\cX/\cS,(m)}\to\cP_{\cX/\cS,(m)}\ctens_{\O_\cX}\cP_{\cX/\cS,(m)}.
  \end{displaymath}
  \nodemo
\end{prop}
Note the use of completed tensor products in place of ordinary ones.
In this connection one should recall the canonical
isomorphism
\begin{displaymath}
  \cP_{\cX/\cS,(m)}\ctens_{\O_\cX}\cP_{\cX/\cS,(m)}\simeq
  \cP_{\cX/\cS,(m)}(2)
\end{displaymath}
so that it would make sense to define
\begin{equation}
  \label{eq:P_B/S(2)}
  \cP_{\cB/\cS,(m)}\ctens_\cB\cP_{\cB/\cS,(m)}\simeq
  \cP_{\cB/\cS,(m)}(2)
\end{equation}
so that \ref{eq:delta^B3} corresponds to a homomorphism
\begin{equation}
  \label{eq:d_02^B}
  d^\cB_{02}:\cP_{\cB/\cS,(m)}\to\cP_{\cB/\cS,(m)}(2).
\end{equation}
On the other hand there are homomorphisms
\begin{equation}
  \label{eq:d_01,12^B}
  d^\cB_{01},\ d^\cB_{12}:\cP_{\cB/\cS,(m)}\to\cP_{\cB/\cS,(m)}(2)
\end{equation}
which via \ref{eq:delta^B3} correspond to the morphisms
$x\mapsto x\ctens1$ and $x\mapsto 1\ctens x$ for $x$ in
$\cP_{\cB/\cS,(m)}$. These homomorphisms satisfy the simplicial
identities
\begin{equation}
  \label{eq:d^B-simplicial-identities}
  d^\cB_0d^\cB_{02}=d^\cB_0d^\cB_{01},\quad
  d^\cB_1d^\cB_{02}=d^\cB_1d^\cB_{12},\quad
  d^\cB_0d^\cB_{12}=d^\cB_1d^\cB_{01}
\end{equation}
and the diagrams
\begin{equation}
  \label{eq:d^B-and-d}
  \xymatrix{
    \cP_{\cX/\cS,(m)}\ar[r]^{d_{ij}}\ar[d]
    &\cP_{\cB/\cS,(m)}(2)\ar[d]\\
    \cP_{\cB/\cS,(m)}\ar[r]_{d^\cB_{ij}}
    &\cP_{\cB/\cS,(m)}(2)\\
  }
\end{equation}
commute for $(ij)=(01)$, $(02)$ and $(12)$.

\subsubsection{Modules over coefficient rings.}
\label{sec:B-modules}

Suppose $M$ is a $\cB$-module and $\cB$ has a compatible left
$\niv{\D}{m}_{\cX/\cS}$-module structure. An $m$-PD-stratification on
$M$ can be viewed as a set of isomorphisms
\begin{equation}
  \label{eq:B-compatible-m-PD-stratification}
  \chi_n:(\cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB)\tens_\cB M
  \isom
  M\tens_\cB(\cB\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)})
\end{equation}
and we say that the $m$-PD-stratification of $M$ is compatible with
the $\cB$-module structure if the isomorphism
\ref{eq:B-compatible-m-PD-stratification} is semilinear with respect
to the stratification
\begin{displaymath}
  \cP^n_{\cX/\cS,(m)}\tens_{\O_\cX}\cB
  \isom
  \cB\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}
\end{displaymath}
of $\cB$. A left $\niv{\D}{m}_{\cX/\cS}$-module structure on $M$ is
compatible with the $\cB$-module structure if this is the case for the
corresponding $m$-PD-stratification. An equivalent condition is that
the map $\cB\tens_{\O_\cX}M\to M$ defining the $\cB$-module structure
is compatible with the $m$-PD-stratifications, or in other words is
$\niv{\D}{m}_{\cX/\cS}$-linear. In local coordinates, this
condition says that
\begin{equation}
  \label{eq:Leibnitz-B-modules}
  \dpabniv{\d}{K}{m}(ax)
  =\sum_{I+J=K}\bbinom{K}{I}{m}\dpabniv{\d}{I}{m}(a)\dpabniv{\d}{J}{m}(x)
\end{equation}
for local sections $a$ of $\cB$ and $x$ of $M$. 

A $\cB$-module with a compatible left $\niv{\D}{m}_{\cX/\cS}$-module
structure evidently gives rise to a left
$\niv{\D}{m}_{\cB/\cS}$-module structure. Conversely a left
$\niv{\D}{m}_{\cB/\cS}$-module $M$ gets compatible 
$\cB$-module and $\niv{\D}{m}_{\cX/\cS}$-module structures from the
canonical inclusions of $\cB$ and $\niv{\D}{m}_{\cX/\cS}$ into
$\niv{\D}{m}_{\cB/\cS}$.

If we are given a compatible pair of isomorphisms \ref{eq:cP_B^n}, the
isomorphisms \ref{eq:B-compatible-m-PD-stratification} defining the
stratification may be rewritten
\begin{equation}
  \label{eq:B-compatible-m-PD-stratification2}
  \chi^\cB_n:\cP^n_{\cB/\cS,(m)}\tens_\cB M\isom M\tens_\cB\cP^n_{\cB/\cS,(m)}
\end{equation}
and \ref{eq:B-compatible-m-PD-stratification} is semilinear for the
stratification of $\cB$ if and only if the isomorphisms
\ref{eq:B-compatible-m-PD-stratification2} are
$\cP^n_{\cB/\cS}$-linear. The compatibility of \ref{eq:cP_B^n}
guarantees the compatiblility of the $\chi^\cB_n$, while the cocycle
condition can be expressed in various ways. One is to introduce the
morphisms
\begin{equation}
  \label{eq:theta^B}
  \theta^\cB_n:M\to M\tens_\cB\cP^n_{\cB/\cS,(m)}
\end{equation}
induced by \ref{eq:B-compatible-m-PD-stratification2}, which are
$\cB$-linear for the right structure of $\cP^n_{\cB/\cS,(m)}$; they
are compatible in an obvious sense, and $\chi_n$ satisfies the cocycle
condition if and only if diagram
\begin{equation}
  \label{eq:B-cocycle-condition}
  \xymatrix{
    M\ar[r]^{\theta^\cB_{n+n'}}\ar[d]_{\theta^\cB_{n'}}
    &M\tensu\cB\cP^{n+n'}_{\cB/\cS,(m)}\ar[d]^{\delta^{n,n'}_\cB}\\
    M\tensu\cB\cP^{n'}_{\cB/\cS,(m)}
    \ar[r]^{\theta^\cB_n}
    &M\tensu\cB\cP^n_{\cB/\cS,(m)}\tensu\cB\cP^{n'}_{\cB/\cS,(m)}
  }
\end{equation}
commutes for all $n$, $n'\ge0$. On the other hand the commutativity of
\ref{eq:B-cocycle-condition} shows that the $\theta^\cB_n$ give $M$
the structure of a left $\niv{\D}{m}_{\cB/\cS}$-module, and thus
yields another way of understanding the equivalence of the
category of left $\niv{\D}{m}_{\cB/\cS}$-modules with the category of
$\cB$-modules endowed with a 
left $\niv{\D}{m}_{\cX/\cS}$-module structure compatible with the
$\cB$-algebra structure. 

When $\cB$ has a quasi-nilpotent left $\niv{\D}{m}_{\cX/\cS}$-module
structure compatible with its algebra structure, the same picture
holds for quasi-nilpotent left $\niv{\D}{m}_{\cX/\cS}$-modules endowed
with a compatible $\cB$-module structure. The $m$-HPD-stratification
\begin{displaymath}
  \chi:\cP_{\cX/\cS,(m)}\ctens_{\O_\cX}M\isom
  M\ctens_{\O_\cX}\cP_{\cX/\cS,(m)}  
\end{displaymath}
can be rewritten
\begin{equation}
  \label{eq:B-compatible-HPD-stratification}
  \chi^\cB:\cP_{\cB/\cS,(m)}\ctens_\cB M\isom
  M\ctens_\cB\cP_{\cB/\cS,(m)}    
\end{equation}
as before, or as a morphism
\begin{equation}
  \label{eq:B-compatible-HPD-stratification2}
  \theta^\cB:M\to M\ctens_\cB\cP_{\cB/\cS,(m)}  
\end{equation}
linear for the right $\cP_{\cB/\cS,(m)}$-structure. The analogue of
\ref{eq:B-cocycle-condition} is the commutative diagram
\begin{equation}
  \label{eq:B-cocycle-condition-HPD}
  \xymatrix{
    M\ar[r]^{\theta^\cB}\ar[d]_{\theta^\cB}
    &M\ctensu\cB\cP_{\cB/\cS,(m)}\ar[d]^{\delta_{\cB,(m)}}\\
    M\ctensu\cB\cP_{\cB/\cS,(m)}
    \ar[r]^{\theta^\cB_n}
    &M\ctensu\cB\cP_{\cB/\cS,(m)}\ctensu\cB\cP_{\cB/\cS,(m)}
  }
\end{equation}
where $\delta_{\cB,(m)}$ is \ref{eq:delta^B3}. But we can also
linearize \ref{eq:B-cocycle-condition-HPD} and use the isomorphism 
\ref{eq:P_B/S(2)} and the maps $d^\cB_{ij}$; then the cocycle
condition takes the usual form of an equality
\begin{equation}
  \label{eq:B-compatible-cocycle-condition}
  (d^\cB_{02})_*(\chi^\cB)
  =(d^\cB_{01})_*(\chi^\cB)\circ (d^\cB_{12})_*(\chi^\cB)
\end{equation}
of $\cP_{\cB/\cS,(m)}(2)$-modules, where $(d^\cB_{ij})_*(\chi^\cB)$
denotes the extension of scalars of $\chi^\cB$ by $d^\cB_{ij}$
(corresponding to the pullbacks by the projections for the nonexistent
formal schemes corresponding the the $\O_\cX$-algebras
$\cP_{\cB/\cS,(m)}$ and $\cP_{\cB/\cS,(m)}(2)$).

The following proposition is proven in exactly the same way in
\cite[Prop. 3.1.3]{berthelot:1990}. 

\begin{prop}\label{prop:Dm-and-Dmhat-coherent}
  Suppose $M$ is a coherent $\niv{\D}{m}_{\cB/\cS}$-module, that is
  coherent as a $\cB$-module. Then $M$ is coherent as a
  $\niv{\hD}{m}_{\cB/\cS}$-module, and the canonical homomorphism
  \begin{displaymath}
    M\to\niv{\hD}{m}_{\cB/\cS}\tens_{\niv{\D}{m}_{\cB/\cS}}M
  \end{displaymath}
  is an isomorphism. \nodemo
\end{prop}

\subsubsection{Change of coefficient ring.}
\label{sec:change-of-coefficient-ring}

Suppose $\cC$ is a second $\O_\cX$-algebra with a left
$\niv{\D}{m}_{\cX/\cS}$-module structure compatible with its
$\O_\cX$-algebra structure. If $\cB\to\cC$ is an $\O_\cX$-algebra
homomorphism linear for the $\niv{\D}{m}_{\cX/\cS}$-module structures,
there is an obvious ring homomorphism
$\niv{\D}{m}_{\cB/\cS}\to\niv{\D}{m}_{\cC/\cS}$ inducing a canonical
$\niv{\D}{m}_{\cX/\cS}$-linear and $\cC$-linear isomorphism
\begin{equation}
  \label{eq:change-of-coefficient-ring}
  \cC\tens_\cB\niv{\D}{m}_{\cB/\cS}\to\niv{\D}{m}_{\cC/\cS}.
\end{equation}
If $M$ is a left $\niv{\D}{m}_{\cB/\cS}$-module, the transitivity of
tensor shows that there is an isomorphism
\begin{equation}
  \label{eq:change-of-coefficient-ring2}
  \cC\tens_\cB M\isom\niv{\D}{m}_{\cC/\cS}\tens_{\niv{\D}{m}_{\cB/\cS}}M.
\end{equation}
In particular, if $M$ is a coherent $\niv{\D}{m}_{\cB/\cS}$-module
then $\cC\tens_\cB M$ is a coherent $\niv{\D}{m}_{\cC/\cS}$-module. 

If $\cB$ and $\cC$ satisfy conditions \ref{sec:coefficients}.5--7,
the same argument can be applied to $M/JM$ for any $m$-bilateralising
ideal $J\subset\O_\cX$, and passing to the inverse limit yields an
isomorphism 
\begin{equation}
  \label{eq:change-of-coefficient-ring-hat}
  \cC\ctens_\cB\niv{\D}{m}_{\cB/\cS}\to\niv{\D}{m}_{\cC/\cS}.
\end{equation}
and, for any coherent left $\niv{\hD}{m}_{\cB/\cS}$-module $M$, an
isomorphism
\begin{equation}
  \label{eq:change-of-coefficient-ring2-hat}
  \cC\ctens_\cB M\isom\niv{\hD}{m}_{\cC/\cS}\tens_{\niv{\hD}{m}_{\cB/\cS}}M.
\end{equation}
Thus if $M$ is a coherent $\niv{\hD}{m}_{\cB/\cS}$-module then
$\cC\tens_\cB M$ is a coherent $\niv{\hD}{m}_{\cC/\cS}$-module.

\begin{prop}\label{prop:quasi-nilpotence-and-base-change}
  Suppose $\cB$ (resp. $\cC$) is an $\O_\cX$-algebra with a compatible
  $\niv{\hD}{m'}_{\cX/\cS}$-module structure (resp. a compatible
  $\niv{\hD}{m}_{\cX/\cS}$-module structure), $m'>m$ and $\cB\to\cC$
  is a $\niv{\hD}{m}_{\cX/\cS}$-linear homomomorphism of
  $\O_\cX$-algebras. If $M$ is a coherent
  $\niv{\hD}{m'}_{\cX/\cS}$-module and $\cC$ is topologically
  quasi-nilpotent as a $\niv{\hD}{m}_{\cX/\cS}$-module,
  $\cC\ctens_\cB M$ is topologically quasi-nilpotent for its induced
  $\niv{\hD}{m}_{\cX/\cS}$-module structure.
\end{prop}
\begin{demo}
  We may work locally, so suppose $M$ is generated as a
  $\niv{\hD}{m'}_{\cB/\cS}$-module by $a_1,\ldots,a_n$. Since $m'>m$,
  the formula \ref{eq:Dm-change-of-level-explicit} shows that
  $\dpabniv{\d}{K}{m}(a_i)\to0$ for $|K|\to\infty$. Since $\cC$ is a
  quasi-nilpotent $\niv{\hD}{m}_{\cX/\cS}$-module the Leibnitz formula
  \ref{eq:Leibnitz-B-modules} shows that $\dpabniv{\d}{K}{m}(x)\to0$
  for any local section of $\cC\ctens_\cB M$, and we are done.
\end{demo}

\subsection{The isogeny category.}
\label{sec:isogeny-category}

To extend these results to coherent $\niv{\D}{m}_{\cB/\cS\bQ}$-modules
we use the following theorem of Ogus, which was proven by him when
$\cB=\O_\cX$ and $m=0$, but the argument in the general case is the
same; c.f. also \cite[Prop. 3.1.2]{berthelot:1990} for the case
$\cB=\O_\cX$.

\begin{prop}\label{prop:Ogus-integrality-thm}
  Suppose $\cB$ is an $\O_\cX$-algebra with a compatible
  $\niv{\hD}{m}_{\cB/\cS}$-module structure satisfying conditions
  \ref{sec:coefficients}.5--7. If $M$ is a $\cB_\bQ$-coherent left
  $\niv{\hD}{m}_{\cB/\cS\bQ}$-module, then locally on $\cX$ there is a
  $\cB$-coherent left $\niv{\hD}{m}_{\cB/\cS}$-module $M^0$ such that
  $(M^0)_\bQ\simeq M$.
\end{prop}
\begin{demo}
  Let $M'$ be any coherent $\cB$-module such that $M'_\bQ=M$.  Pick
  an open affine on which $\cX/\cS$ is parallelizable and choose local
  coordinates $x_1,\ldots,x_d$; then $\cP^n_{\cX/\cS,(m)}$ is free on
  the corresponding $\dpbrniv{\xi}{K}{m}$. For $n\ge0$ the map
  \begin{displaymath}
    \theta_n:M\to M\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)}
  \end{displaymath}
  arising from the $m$-PD-stratification of $M$ is
  \begin{displaymath}
    \theta_n(x)=\sum_{|K|\le n}\dpabniv{\d}{K}{m}(x)\tens\dpbrniv{\xi}{K}{m}.
  \end{displaymath}
  We will show that
  \begin{displaymath}
    M^0=\bigcap_{n\ge0}\theta_n^{-1}(M'\tens_{\O_\cX}\cP^n_{\cX/\cS,(m)})
  \end{displaymath}
  satisifies the conditions of the proposition.  From the definition
  we see that $x\in M^0$ if and only if $\dpabniv{\d}{K}{m}(x)\in M'$
  for all $K$, and thus $M^0$ is preserved by the
  $\dpabniv{\d}{K}{m}$. Since the $m$-PD-stratification of $M$ is
  semilinear with respect to the $m$-PD-stratification of $\cB$, $M^0$
  is a $\cB$-submodule of $M'$; this is most easily seen from
  condition \ref{eq:Leibnitz-B-modules}. Clearly $M^0_\bQ\simeq M$,
  and $M^0\sset M'$ since $\theta_0(M')=M'$. Thus $M^0$ is
  $\cB$-coherent, and by \ref{sec:coefficients}.5 $M^0$ is complete
  for the adic topology of $\cB$ (induced by the adic topology of
  $\O_\cX$). Since $\dpabniv{\d}{K}{m}(M^0)\sset M^0$ for all $K$ it
  follows that $M^0$ is a $\niv{\hD}{m}_{\cX/\cS}$-submodule of
  $M$. Finally, since the $\cB$-module and
  $\niv{\hD}{m}_{\cB/\cS}$-module structures of $M$ are compatible
  this will also be the case for $M^0$, and thus $M^0$ is a
  $\niv{\hD}{m}_{\cB/\cS}$-module.
\end{demo}

If $\cX$ is quasicompact, the $M$ in the proposition can be chosen
globally, but we will not need this refinement. An immediate
consequence of Ogus's theorem is a version of
\ref{prop:Dm-and-Dmhat-coherent} for
$\niv{\D}{m}_{\cB/\cS\bQ}$-modules:

\begin{prop}\label{prop:Dm-and-Dmhat-coherent-Q}
  Suppose $M$ is a left $\niv{\D}{m}_{\cB/\cS\bQ}$-module that is
  coherent as a $\cB_\bQ$-module. Then $M$ is coherent as a left
  $\niv{\D}{m}_{\cB/\cS\bQ}$-module, and the canonical homomorphism
  \begin{displaymath}
    M\to\niv{\hD}{m}_{\cB/\cS\bQ}\tens_{\niv{\D}{m}_{\cB/\cS\bQ}}M
  \end{displaymath}
  is an isomorphism. \nodemo
\end{prop}

The following is also useful when going back and forth between
$\niv{\D}{m}_{\cB/\cS}$-modules and
$\niv{\D}{m}_{\cB/\cS\bQ}$-modules:

\begin{lemma}\label{lemma:choice-of-integral-model}
  Let $A$ be a noetherian topological $\bZ_p$-algebra (not necessarily
  commutative) and $A\to B$ a ring homomorphism. Suppose $A$ has a
  ideal $J$ centralising in both $A$ and $B$, and such that $A$ and
  $B$ both have the $J$-adic topology. Let $f:M\to M'$ be a
  homomorphism of finitely generated left $A$-modules. If the kernel
  and cokernel of $f$ are $p$-torsion, $f$ induces an isomorphism
  $(B\tens_AM)_\bQ\isom(B\tens_AM')_\bQ$.
\end{lemma}
\begin{demo}
  It suffices to treat the cases in which $f$ is surjective or
  injective. Suppose $f$ is injective and
  \begin{displaymath}
    0\to M\to M'\to M''\to 0
  \end{displaymath}
  is exact; then there is an exact sequence
  \begin{displaymath}
    0\to K\to B\tens_AM\to B\tens_AM'\to B\tens_AM''\to 0
  \end{displaymath}
  where $K$ is a quotient of $\Tor^1_A(B,M'')$. Since $M''$ is
  $p$-torsion and a finitely generated $A$-module, $K$ and
  $B\tens_AM''$ are $p$-torsion finitely generated $B$-modules, and
  are therefore annihilated by some power of $p$. By the hypotheses
  made on the topologies of $A$ and $B$, the completion of the exact
  sequence
  \begin{displaymath}
    0\to\hat K\to B\ctens_AM\to B\ctens_AM'\to B\ctens_AM''\to 0
  \end{displaymath}
  is still exact. Furthermore $\hat K$ and $B\ctens_AM''$ are
  annihilated by some power of $p$, and the assertion follows. The
  case where $f$ is surjective is similar.
\end{demo}

The next lemma is evident, and its equivalent conditions define the
notion of a \textit{topologically quasi-nilpotent left
  $\niv{\hD}{m}_{\cB/\cS\bQ}$-module}. 

\begin{lemma}\label{lemma:quasi-nilpotent-Q}
  Suppose $\cB$ is an $\O_\cX$-algebra with a compatible
  $m$-HPD-stra\-ti\-fi\-cation and $M$ is a coherent left
  $\niv{\hD}{m}_{\cB/\cS\bQ}$-module. The following are equivalent:
  \begin{enumerate}
  \item Any finitely generated $\niv{\hD}{m}_{\cB/\cS}$-submodule of
    $M$ is topologically quasi-nilpotent.
  \item There is a topologically quasi-nilpotent left
    $\niv{\hD}{m}_{\cB/\cS}$-module $M^0$ and an isomorphism
    $M^0_\bQ\simeq M$ of $\niv{\hD}{m}_{\cB/\cS}$-modules.
  \end{enumerate}\nodemo
\end{lemma}

If $M$ is a coherent $\niv{\hD}{m}_{\cB/\cS\bQ}$-module we define the
$\cC\ctens_\cB M$ as follows: choose locally a coherent
$\niv{\hD}{m}_{\cB/\cS}$-submodule $M^0$ of $M$ such that
$M^0_\bQ\simeq M$; then
\begin{equation}
  \label{eq:rigid-analytic-base-change}
  \cC\ctens_\cB M:=(\cC\ctens_\cB M^0)_\bQ
\end{equation}
where in the right hand side we have the usual completed tensor
product. Lemma \ref{lemma:choice-of-integral-model} shows that the
left hand side of \ref{eq:rigid-analytic-base-change} is independent
of the choice of $M^0$, so the definition is justified. Note that if
$M$ is coherent as a $\cB_\bQ$-module we may choose an $M^0$ that is
coherent as a $\cB$-module. In any case the resulting
$\niv{\hD}{m}_{\cC/\cS}$-module is coherent.

From the proposition \ref{prop:quasi-nilpotence-and-base-change} and
lemma \ref{lemma:quasi-nilpotent-Q} we get:

\begin{cor}\label{cor:quasi-nilpotence-and-base-change}
  Let $\cB$ and $\cC$ be as in proposition
  \ref{prop:quasi-nilpotence-and-base-change}, and let $M$ be a
  coherent left $\niv{\hD}{m'}_{\cC/\cS\bQ}$-module. If $m'>m$,
  $\cC\ctens_\cB M$ is a quasi-nilpotent left
  $\niv{\hD}{m}_{\cB/\cS\bQ}$-module.\nodemo
\end{cor}

\subsection{Descent by Frobenius.}
\label{sec:Frobenius-descent}

Suppose now $\cS$ has the $m$-PD-structure $(\fa,\fb,\alpha)$ and
$p\in\fa$. As before we set $S_0=V(\fa)$, set $q=p^s$ and denote by
$F_{S_0}$ the $q$th power Frobenius of $S_0$. For any formal
$\cS$-scheme $\cX$ we again set $X_0=V(\fa\O_\cX)$ and denote by
$F_{X_0}$ the $q$th power Frobenius; then the relative Frobenius
$F_{X_0/S_0}:X_0\to\niv{X_0}{q}$ is defined, and we denote by
$W_{X_0/S_0}:\niv{X_0}{q}\to X_0$ the canonical projection.  Suppose
$F_{X_0/S_0}$ lifts to a morphism $F:\cX\to\cX'$. The argument of
\cite[Prop. 2.2.2]{berthelot:2000} can be used as is to show:

\begin{prop}\label{prop:raising-the-level}
  For any left $\niv{\D}{m}_{\cX'/\cS}$-module $M$, $F^*M$ has a
  canonical and functorial left $\niv{\D}{m+s}_{\cX/\cS}$-module
  structure restricting to the $\niv{\D}{m}_{\cX/\cS}$-module
  structure derived from base change. If $M$ is a topologically
  quasi-nilpotent $\niv{\D}{m}_{\cX'/\cS}$-module, $F^*M$ is a
  topologically quasi-nilpotent
  $\niv{\D}{m+s}_{\cX/\cS}$-module.\nodemo
\end{prop}

An important point in the proof is that $F$ is flat, a fact used in
the proofs of \cite[Lemme 2.3.2]{berthelot:2000} and \cite[Lemme
2.3.3]{berthelot:2000}. This is true in the present case, since $F$ is
a lifting of $F_{X_0/S_0}:X_0\to\niv{X_0}{q}$ which is flat by
proposition \ref{prop:flatness-of-Frobenius}.

To prove the descent theorem we need to make the further assumption
that $F$ is finite, a fact needed in the argument of
\cite[Th\'eor\`eme 2.3.6]{berthelot:2000}. This will be true if
$F_{X_0/S_0}$ is finite, but so far we only know this when
$X_0\to S_0$ is formally of finite type, again by proposition
\ref{prop:flatness-of-Frobenius}. We therefore state the Frobenius
descent theorem for $\niv{\D}{m}$-modules as follows; no changes are
needed in adapting the argument of \cite[\S2.3]{berthelot:2000}.

\begin{thm}\label{thm:Frobenius-descent-D}
  Suppose $f:\cX\to\cS$ is quasi-smooth and the relative Frobenius
  $F_{X_0/S_0}$ is finite. The functor $F^*$ induces an equivalence of
  the category of left $\niv{\D}{m}_{\cX'/\cS}$-modules with the
  category of left $\niv{\D}{m+s}_{\cX/\cS}$-modules.\nodemo
\end{thm}

The Frobenius descent theorem for $\niv{\hD}{m}$-modules is an
immediate consequence. If $J'\sset\O_{\cX'}$ is open and
$\niv{\D}{m}_{\cX'/\cS}$-bilateralising, $J=F^*J'\sset\O_\cX$ is open
and $\niv{\D}{m}_{\cX'/\cS}$-bilateralising. From the equivalence of
categories in the last paragraph we deduce, again with the assumption
that $F$ is finite and flat, that the category of left
$\niv{\D}{m}_{X'_{J'}/\cS}$-modules is equivalent to the category of
left $\niv{\D}{m}_{\cX/\cS,J}$-modules. If $J'$ is an ideal of
definition, so is $J$; this is because $F_{X_0/S_0}$ is a
homeomorphism.Furthermore, as $J'\sset\O_{\cX'}$ runs through a
cofinal set of $\niv{\D}{m}_{\cX'/\cS}$-bilateralising ideals of
definition, $F^*J$ runs through a cofinal set of
$\niv{\D}{m+s}_{\cX/\cS}$-bilateralising ideals of definition. From
this and the previous discussion we get the following:

\begin{thm}\label{thm:Frobenius-descent-Dhat}
  Suppose $\cX\to\cS$ is quasi-smooth and the relative Frobenius
  $F_{X_0/S_0}$ lifts to an $\cS$-morphism $F:\cX\to\cX'$. For any
  left $\niv{\hD}{m}_{\cX'/\cS}$-module $M$, $F^*M$ has a canonical
  left $\niv{\hD}{m+s}_{\cX/\cS}$-module structure. If $F_{X_0/S_0}$
  is finite, this induces an equivalence of the category of left
  $\niv{\hD}{m}_{\cX'/\cS}$-modules with the category of left
  $\niv{\hD}{m+s}_{\cX/\cS}$-modules.
\end{thm}

Suppose $F':\cX\to\cX'$ is a second lifting of $F_{X_0/S_0}$. If the
$m$-PD-structure $(\fa,\fb,\alpha)$ of $\cS$ is $m$-PD-nilpotent, the
isomorphism $\tau_{F,F'}$ of proposition
\ref{prop:invariance-of-base-change1} is
$\niv{\D}{m+s}_{\cX/\cS}$-linear, the argument being the same as
\cite[Prop. 2.2.5]{berthelot:1996}.

The Frobenius descent theorem extends to the case of coefficient
rings. Let $\cB$ be an $\O_{\cX'}$-algebra with a compatible left
$\niv{\hD}{m}_{\cX'/\cS}$-module structure. Then $F^*\cB$ has a left
$\niv{\hD}{m+s}_{\cX/\cS}$-module structure compatible with its
$\O_\cX$-algebra structure. Furthermore if $\cB$ satisfies the
assumptions \ref{sec:coefficients}.3--5 relative to $\cX'$, the
$\O_\cX$-algebra $F^*\cB$ satisfies these same conditions relative to
$\cX$. In these cases the Frobenius descent theorem can be stated as
follows:

\begin{thm}\label{thm:Frobenius-descent-with-coefficients}
  Let $\cB$ be an $\O_{\cX'}$-algebra with a left
  $\niv{\D}{m}_{\cX'/\cS}$-module structure compatible with its
  $\O_{\cX'}$-algebra structure. For any left
  $\niv{\D}{m}_{\cB/\cS}$-module $M$, $F^*$ has a canonical left
  $\niv{\D}{m+s}_{F^*\cB/\cS}$-module structure, and if $F_{X_0/S_0}$
  is finite this construction yields an equivalence of the category of
  left $\niv{\D}{m}_{\cB/\cS}$-modules with the category of left
  $\niv{\D}{m+s}_{F^*\cB/\cS}$-modules. If in addition $\cB$ satisfies
  the conditions \ref{sec:coefficients}.3--5, $F^*$ induces an
  equivalence of the category of left $\niv{\hD}{m}_{\cB/\cS}$-modules
  with the category of left $\niv{\hD}{m+s}_{F^*\cB/\cS}$-modules
\end{thm}

\section{Tubes}
\label{sec:tubes-and-isocrystals}

Let $\V$ be a complete discrete valuation ring of mixed characteristic
$p$ with residue field $k$ and fraction field $K$. The goal of this
section and the next is to reconstruct in purely formal terms the
categories of convergent isocrystals on a separated $k$-scheme $X$ of
finite type relative to $K$. This will allow us to apply the Frobenius
descent theorem to show that the Frobenius pullback is an
autoequivalence of the categories of convergent and overconvergent
isocrystals on $X/K$.

The key to doing this is a formal version of Berthelot's construction
of the tube of $X$ relative to an embedding over $\V$ of $X$ into a
smooth formal $\V$-scheme $\cP$. If $\cX$ is the completion of $\cP$
along $X\subset\cP$, the tube $]X[_\cP$ is the analytic space
$\cX^\an$ associated to the formal $\V$-scheme $\cX$ by the procedure
of \cite[0.2.6]{berthelot:1996a}, which we now recall.  Fix an ideal
of definition of $\cX$, and assume for the moment that $\cX=\Spf{A}$
is affine, with ideal of definition $J=(f_1,\ldots,f_r)$. The
$\V$-algebra
\begin{displaymath}
  A_n=A\{T_1,\ldots,T_r\}/(\pi T_i-f^{p^n},\ 1\le i\le nj)
\end{displaymath}
is topologically of finite type, and $A_n\tens\bQ$ is a Tate
algebra. For $n'\ge n$ there are natural continuous homomorphisms
$A_{n'}\tens\bQ\to A_n\tens\bQ$, and $\cX^\an$ is the direct limit of
the rigid analytic spaces $\Max(A_n\tens\bQ)$. The general case is
handled by patching together the $A_n$ for various affine opens of
$\cX$. 

In the next few sections we revisit this construction in a more
general setting. We will then be able to construct all of the analytic
data involved in the definition of a convergent isocrystal on $X/K$ in
terms of the formal scheme $\cX$ and modules over various differential
operator rings. The construction can in fact be done in much greater
generality, as we shall soon see.

\subsection{Tube algebras.}
\label{sec:tubes}

Let $p$ be a prime, and denote by $\cC_p$ the category of flat
$\bZ_{(p)}$-algebras. 

\subsubsection{}

If $A$ is any $\bZ_{(p)}$-algebra and $N\sset A$
is a subset, the set functor $F_{N\subset A}$ on $\cC_p$ defined by
\begin{displaymath}
  F_{N\subset A}
(C)=\{f\in\Hom(A,C)\,|\, f(N)\sset pA\}
\end{displaymath}
is represented by a flat $\bZ_{(p)}$-algebra $A[N]$ and a homomorphism
(necessarily a $\bZ_{(p)}$-algebra homomorphism, by flatness) $A\to
A[N]$. In fact if we set
\begin{equation}
  \label{eq:tube-raw}
  A\lc N\rc=A[T_f,\ f\in N]/(pT_f-f,\ f\in N)
\end{equation}
then the representing object is
\begin{equation}
  \label{eq:tube-cooked}
  A[N]=A\lc N\rc/(\text{$p$-torsion}).
\end{equation}
Note that $A[N]\simeq A$ if $N$ is empty or if every element of $N$ is
divisible by $p$ in $A$.

\begin{example}
  Let $R$ be any $\bZ_{(p)}$-flat ring and set $A=R[X_1,\ldots,X_n]$
  and $N=\{X_1,\ldots,X_n\}$. Then $A\lc N\rc$ may be identified with
  the subring of $A\tens\bQ$ consisting of the $R$-span of the
  monomials $X^K/p^{|K|}$. In this case $A[N]=A\lc N\rc$, and $A[N]$
  is a free $R$-module. 
\end{example}

\begin{remark}
  The same construction can be made the the category of flat
  $\V$-algebras where $\V$ is any flat $\bZ_{(p)}$ and $\pi\in\V$ is
  any nonzero element in place of $p$. Most of the results to follow,
  suitably modified, if $p$ is a mulitple of $\pi$. We will not need
  the extra generality.
\end{remark}

The constructions \ref{eq:tube-raw} and \ref{eq:tube-cooked} are
evidently functorial: if $A\to A'$ induces a map $N\to N'$ of subsets,
there are natural homomorphisms $A\lc N\rc\to A'\lc N'\rc$ and
$A[N]\to A'[N']$. In what follows we are mainly interested in $A[N]$
but we will need $A\lc N\rc$ for some arguments.

If $A$ is $\bZ_{(p)}$-flat, the natural morphism
$A_\bQ\to A\lc N\rc_\bQ$ is an isomorphism, and $A\to A[N]$ is
injective, as one sees from the commutative diagram
\begin{displaymath}
  \xymatrix{
    A\ar[r]\ar@{^{(}->}[d]&A\lc N\rc\ar[d]\ar[rd]\\
    A_\bQ\ar[r]^{\sim\quad}&A\lc N\rc\tens\bQ&A[N]\ar@{_{(}->}[l]
  }.
\end{displaymath}
Thus if $A$ is $\bZ_{(p)}$-flat, $A\to A[N]$ is injective and $A[N]$
may be identified with its image in $A[N]\tens\bQ\simeq A\tens\bQ$.

\begin{lemma}\label{lemma:tubes-and-generators}
  If $J$ is the ideal generated by a subset $N\sset A$, the
  natural morphism $A[N]\to A[J]$ is an isomorphism.
\end{lemma}
\begin{demo}
  This follows from the universal property: if $C$ is $\bZ_{(p)}$-flat
  and $A\to C$ maps $N$ into $pC$ then it will do the same for
  $J$. Thus $A\to A[N]$ factors through a homomorphism $A[J]\to A[N]$
  which is an inverse to the natural morphism $A[N]\to A[J]$.
\end{demo}

It follows that if $A$ is a noetherian ring then so is $A[N]$ for
\textit{any} subset $N\sset A$, even an infinite one. Another
consequence of the universal property is a canonical isomorphism
\begin{equation}
  \label{eq:ignores-multiples-of-p}
  A[N]\isom A[N\cup pN'].
\end{equation}
for all subsets $N$, $N'\sset A$.

\begin{remark}
  We will make frequent use of lemma \ref{lemma:tubes-and-generators}
  in combination with the isomorphism \ref{eq:ignores-multiples-of-p}
  in the following way. Let $J=(f_1,\ldots,f_n)$ be an ideal of $A$
  and set $N=\{f_1,\ldots,f_n\}$. Denoting as usual by $\niv{J}{p^i}$
  the ideal generated by the $f^{p^i}$ for all $f\in J$, we have
  \begin{displaymath}
    (f_1^{p^i},\ldots,f_n^{p^i})+pA=\niv{J}{p^i}+pA
  \end{displaymath}
  and therefore
  \begin{equation}
    \label{eq:tubes-and-generators}
    A[N^{p^i}]\simeq A[N^{p^i}\cup pA]\simeq A[\niv{J}{p^i}+pA]
    \simeq A[\niv{J}{p^i}\cup pA]\simeq A[\niv{J}{p^i}]    
  \end{equation}
  by the lemma and \ref{eq:ignores-multiples-of-p}.
\end{remark}

\begin{prop}\label{prop:independence-of-tube-mod-p}
  Suppose $N=\{f_\alpha\}_{\alpha\in I}$ and
  $N'=\{f'_\alpha\}_{\alpha\in I}$ are subsets of $A$ such that for
  every $f\in N$ there is an $f'\in N'$ such that
  $f'\equiv f\pmod{p}$, and \textit{vice versa}. There is a canonical
  isomorphism
  \begin{equation}
    \label{eq:invariance-of-A[N]}
    A[N]\simeq A[N']
  \end{equation}
  functorial in $A$, $N$ and $N'$.
\end{prop}
\begin{demo}
  This follows from the universal property: for any ring homomorphism
  $f:A\to C$ with $C$ flat over $\bZ_{(p)}$, $f(N)\sset pC$ if and
  only if $f(N')\sset pC$.
\end{demo}

\subsubsection{Tensor products and base change.}
\label{sec:tube-base-change}

For $N$, $N'\sset A$ there is a canonical isomorphism
\begin{equation}
  \label{eq:union-of-N1}
  A\lc N\rc\tens_AA\lc N'\rc\isom 
  A\lc N\cup N'\rc
\end{equation}
and a canonical surjective homomorphism
\begin{equation}
  \label{eq:union-of-N2}
  A[N]\tens_AA[N']\surj 
  A[N\cup N']
\end{equation}
with $p$-torsion kernel. This reduces many questions to the case of a
singleton set $N$.

For any ring homomorphism $f:A\to A'$ the universal property implies the
existence of a canonical homomorphism
\begin{equation}
  \label{eq:tube-base-change2}
  A'\tens_AA[N]\surj A'[f(N)]
\end{equation}
with $p$-torsion kernel. It is evidently induced by an isomorphism
\begin{equation}
  \label{eq:tube-base-change}
  A'\tens_AA\lc N\rc\isom A'\lc f(N)\rc
\end{equation}
from which we see that \ref{eq:tube-base-change2} is surjective

\begin{lemma}\label{lemma:A[N]-and-flat-base-change}
  If $A'$ is a flat $A$-algebra, the natural map
  \ref{eq:tube-base-change2} is an isomorphism
\end{lemma}
\begin{demo}
  It suffices to show that $A'\tens_AA[N]$ is $p$-torsion-free. Since
  $A[N]$ is $p$-torsion free,
  \begin{displaymath}
    0\to A[N]\Xto{p} A[N]
  \end{displaymath}
  is exact and remains exact after tensoring with $A'$.
\end{demo}

We will see later that the tube algebras have some of the properties
of divided power envelopes; the following might be compared with the
discussion in section \ref{sec:m-PD-regular}.

\begin{prop}\label{prop:regular-tubes}
  Let $(p,f_1,\ldots,f_n)$ be a regular sequence in $A$ and set
  $N=\{f_1,\ldots,f_n\}$ and $I=(f_1,\ldots,f_n)$. (i) The natural map
  $A\lc N\rc\to A[N]$ is an isomorphism. (ii) Suppose $A$ is Zariski
  ring for the $I$-adic topology, $R=A/I$ has no $p$-torsion and the
  natural morphism $A\to R$ has a section. Then via this section,
  $A[N]$ is a flat $R$-algebra.
\end{prop}
\begin{demo}
  (i) Since the statement that a sequence is regular does not depend on
  the order of the sequence, and since a regular sequence remains
  regular after a flat ring extension,
  \begin{align*}
    (p,f_1,\ldots,f_n)\ \text{is regular in $A$}
    &\implies\text{it's also regular in $A[T_1,\ldots,T_n]$}\\
    &\implies\text{so is}\ (p,pT_1-f_1,\ldots,pT_n-f_n)\\
    &\implies\text{so is}\ (pT_1-f_1,\ldots,pT_n-f_n,p)
  \end{align*}
  and the last statement says that $A\lc N\rc$ has no $p$-torsion.

  (ii) We borrow an idea from \cite[1.5.3]{berthelot:1996} (itself
  borrowed from \cite[2.3.3--4]{bbm:1982}). Set
  $A_0=R[X_1,\ldots,X_n]$, $N_0=\{X_1,\ldots,X_n\}$ and
  $I_0=(X_1,\ldots,X_n)$. Let $f:A_0\to A$ be the morphism induced by
  $X_i\mapsto f_i$. Since $(f_1,\ldots,f_n)$ is a regular sequence,
  $\Tor^{A_0}_i(R,A)=0$ for $i>0$. Evidently
  $A/I_0A\simeq A/I\simeq R$ is flat over $A_0/I_0\simeq R$. We claim
  that $A$ is $I_0$-adically separated as an $A_0$-module. In fact if
  $\fa\subset A_0$ is a finitely generated ideal, $\fa\tens_{A_0}A$ is
  a finitely generated $A$-module, and its $I_0$-adic topology
  coincides with the $I$-adic topology as an $A$-module. Since $A$ is
  a Zariski ring for the $I$-adic topology, $\fa\tens_{A_0}A$ is
  $I_0$-adically separated, and the claim follows. The criterion
  \cite[Ch. III \S5 no. 1 Th. 1]{bourbaki-AC} shows that $A$ is a flat
  $A_0$-algebra, and it follows that $A[N]\simeq A\tens_{A_0}A_0[N_0]$
  is a flat $A_0[N_0]$-algebra. By the example at the beginning of
  this section, $A_0[N_0]$ is a flat $R$-algebra, and we are done.
\end{demo}

The formation of $A[N]$ commutes with localizations:

\begin{lemma}\label{lemma:tube-commutes-with-localization}
  Let $S\subset A$ be a multiplicative system and denote by $S^{-1}N$
  the image of $N$ in $S^{-1}A$. The natural map
  $S^{-1}(A\lc N\rc_\bQ)\to (S^{-1}A)\lc S^{-1}N\rc_\bQ$ induces an
  isomorphism
  \begin{displaymath}
    S^{-1}(A[N])\to (S^{-1}A)[S^{-1}N].
  \end{displaymath}
\end{lemma}
\begin{demo}
  By the exactness of localizations $S^{-1}(A[N])$ is the image of
  $S^{-1}(A\lc N\rc)\to S^{-1}(A\lc N\rc_\bQ)$. In the commutative
  square
  \begin{displaymath}
    \xymatrix{
      S^{-1}(A\lc N\rc)\ar[r]\ar[d]&
      S^{-1}(A\lc N\rc_\bQ)\ar[d]\\
      (S^{-1}A)\lc S^{-1}N\rc\ar[r]&
      (S^{-1}A)\lc S^{-1}N\rc_\bQ\\
    }
  \end{displaymath}
  the vertical arrows are isomorphisms: for the left-hand one this
  follows from the definition \ref{eq:tube-raw} and the exactness of
  localization. Since localization commutes with tensor products, the
  right-hand arrow is the tensor product of the left-hand one and so
  is also an isomorphism, and the assertion follows.
\end{demo}

For any subset $N\sset A$ we denote by $N^r$ the set of $f^r$ for all
$f\in N$. The $A$-homomorphisms $A[T_f,\ f\in N^r]\to A[T_g,\ g\in N]$
defined by $T_{f^r}\mapsto f^{r-1}T_f$ for all $f\in N$ passes to the
quotient to yield a $A$-homomorphism
\begin{equation}
  \label{eq:passage-to-smaller-tube1}
  A\lc N^r\rc\to A\lc N\rc.
\end{equation}

\begin{lemma}\label{lemma:passage-to-smaller-tube}
  Suppose $N\subset A$ and let $J$ be the ideal generated by $N$, and
  $\niv{J}{r}$ the ideal generated by $N^r$. The homomorphismn
  \begin{equation}
    \label{eq:passage-to-smaller-tube2}
    A[N^r]\to A[N]
  \end{equation}
  induced by \ref{eq:passage-to-smaller-tube1} is the canonical
  homomorphism $A[\niv{J}{r}]\to A[J]$ induced by the inclusion
  $\niv{J}{r}\subset J$.
\end{lemma}
\begin{demo}
  Since $J$ is also generated by $N\cup N^r$ it suffices to show that
  the homomorphism \ref{eq:passage-to-smaller-tube2} is the one
  generated by the inclusion $N^r\inj N\cup N^r$. By definition, the
  latter sends $T_{f^r}\mapsto T_{f^r}$, but in $A[N\cup N^r]$ we have
  $T_{f^r}=f^{r-1}T_f$ since $T_{f^r}-f^{r-1}T_f$ is killed by $p$ in
  $A\lc N\cup N^r\rc$.
\end{demo}

\subsubsection{Tubes and analytic spaces.}
\label{sec:tubes-to-analytic-space}

We now revisit the construction of Berthelot described in the
introduction to this section. Let $\V$ be a complete discrete
valuation ring of mixed characteristic $p$. We denote by $k$ the
residue field of $\V$ and by $K$ the fraction field. Suppose $\cX$ is
an adic local noetherian formal $\V$-scheme whose reduced closed
subscheme $X$ is a separated $k$-scheme of finite type. To any open
ideal $J\subset\O_\cX$ we attach a rigid analytic space $[X]_J$ as
follows. When $X=\Spf{A}$ the $\V$-algebra $A[J]$ is topologically of
finite type, and $A[J]_\bQ$ is a Tate algebra over $K$. In this case
we set $[X]_J=\Max(A[J]_\bQ)$, and in the general case the $[X]_J$
defined relative to affine opens in $\cX$ patch together to yield the
global $[X]_J$. This construction is clearly functorial: if $\cY$ is
an adic locally noetherian formal $\V$-scheme whose reduced closed
subscheme $Y$ is a separated $k$-scheme of finite type, a morphism
$f:\cY\to\cX$ over $\V$ induces a morphism $[Y]_{f^*J}\to[X]_J$ of
analytic spaces over $K$.

For $J'\sset J$ the natural morphism $A[J']\to A[J]$ induces a
morphism $i_{JJ'}:[X]_J\to[X]_{J'}$ identifying $[X]_J$ with a
Weierstrass domain in $[X]_{J'}$. The morphisms $i_{JJ'}$ are
transitive, and as we let $J$ run through the set of ideals of
definition of $\O_\cX$ the $[X]_J$ patch together to yield an analytic
space $\cX^\an$ over $K$. By construction each $[X]_J$ is an
admissible open in $\cX^\an$, and we denote by $u_J:[X]_J\to\cX^\an$ the
canonical inclusion. The construction of $\cX^\an$ is functorial in
$\cX$: with $\cY/\V$ and $f:\cY\to\cX$ as in the previous paragraph,
the morphism $f$ induces a morphism $f^\an:\cY^\an\to\cX^\an$ of
analytic spaces over $K$. For this it suffices to observe that if
$J\subset\O_\cX$ is any ideal of definition, $f^*J$ is contained in
some ideal of definition of $\O_\cY$.

If $sp:\cX^\an\to\cX$ is the specialization map \cite{berthelot:1996a}
and $J\sset\O_\cX$ is open there is an canonical isomorphism
\begin{equation}
  \label{eq:tube-formal-and-analytic}
  sp_*u_{J*}u^*_J\O_{[X]_J}\simeq\O_\cX[J]_\bQ  
\end{equation}
and for $J'\sset J\sset\O_\cX$ with $J'$ open, the isomorphisms
\ref{eq:tube-formal-and-analytic} fit into commutative diagrams
\begin{equation}
  \label{eq:tube-formal-and-analytic-restriction}
  \xymatrix{
    sp_*u_{J*}u^*_J\O_{[X]_J}\ar[r]\ar[d]&\O_\cX[J]_\bQ\ar[d]\\
    sp_*u_{J'*}u^*_{J'}\O_{[X]_J'}\ar[r]&\O_\cX[J']_\bQ\\
  }
\end{equation}

If $J\subset\O_\cX$ is any open ideal defining a closed subscheme
$Z\subset\cX$, $[X]_J$ is, in the terminology of
\cite{berthelot:1996a} a closed tube in $\cX^\an$ around $Z$. If
$Z\subset\cX$ is a reduced closed subscheme, the open tube $]Z[_\cX$
is the inductive limit of the $[X]_J$ for all $J$ whose corresponding
reduced closed subscheme is $Z$.

Suppose $J\subset J'$ are open ideals in $\O_\cX$ and $M$ is a
coherent $\O_{[X]_J}$-module. The pullback $i_{JJ'}^*M$ can be
described as follows: locally on $[X]_J$ there is a coherent
$\O_{[X]_J}$-module $M^0$ such that $M=M^0_\bQ$; then $i_{JJ'}^*M^0$
is a coherent $\O_{[X]_{J'}}$-module (in the sense of formal schemes)
and we define $i_{JJ'}^*M=(i_{JJ'}^*M^0)_\bQ$; that this is
independent of the choice of $M^0$ follows from lemma
\ref{lemma:choice-of-integral-model}. The results of this procedure
patch together to define $i_{JJ'}^*M$ globally.

A similar construction defines the pullback $f^{\an*}M$ when $M$ is a
coherent $\O_{\cX^\an}$-module and $f:\cY\to\cX$ is a morphism over
$\V$; we leave the details to the reader.

\subsection{$\niv{D}{m}$-module structure.}
\label{sec:Dm-modules-on-tubes}

We now suppose that $R$ is an adic noetherian flat $\bZ_{(p)}$-algebra
and that $R\to A$ is a quasi-smooth homomomorphism. Fix an ideal of
definition $J\subset A$. We assume in addition that $R$ has an
$m$-PD-structure $(\fa,\fb,\alpha)$ compatible with the canonical
divided powers of $(p)\subset\bZ_{(p)}$. Our aim is to show that for
any natural numbers $m<i$ and $n$, $A\lc N^{p^i}\rc$ and $A[N^{p^i}]$
have a canonical left $\niv{D}{m}_{A/R}$-module structures compatible
with their ring structure. This is simple variant of a construction
of Berthelot \cite[Prop. 4.2.1]{berthelot:1996}. We begin with the
case of $A \lc N^{p^i}\rc$.

Denote by $P_{(m)}=P_{A/R,(m)}$ the $m$-PD-envelope of the diagonal
ideal $I=\Ker(A\ctens_RA\to A)$ of $A\ctens_RA$, and by $P^r_{(m)}$
the canonical quotient. We first construct isomorphisms
\begin{equation}
  \label{eq:tube-stratification1}
  P^n_{(m)}\tens_AA\lc N^{p^i}\rc
  \isom
  A\lc N^{p^i}\rc\tens_AP^n_{(m)}  
\end{equation}
as follows. We identify $P^n_{(m)}$ with a subring of
$P^n_{(m)}\tens_AA\lc N^{p^i}\rc$ and
$A\lc N^{p^i}\rc\tens_AP^n_{(m)}$ in the usual way, and recall the
$m$-PD-polynomial $\niv{\varphi}{m}_r$ from equality
\ref{eq:varphi}. This equality shows that
\begin{equation}
  \label{eq:tubes-stratification1bis}
  1\tens T_{f^{p^i}}\mapsto
  T_{f^{p^i}}\tens1+\niv{\varphi}{m}_{p^i}(d_0(f),d_1(f))
\end{equation}
works as a definition of \ref{eq:tube-stratification1}, where $d_0$,
$d_1:B\to P^n_{(m)}$ are the usual left and right
structures. Furthermore the relations \ref{eq:varphi-identities} show
that the base change of \ref{eq:tube-stratification1} by
$P^n_{(m)}\to A$ is the identity of $A\lc N^{p^i}\rc$, and that the
cocycle condition holds. We give $A\lc N^{p^i}\rc$ the corresponding
left $\niv{D}{m}_{A/R}$-module structure corresponding to the
$m$-PD-stratification \ref{eq:tube-stratification1}. Observe that this
left $\niv{D}{m}_{A/R}$-module structure is compatible with the
$A$-algebra structure of $A\lc N^{p^i}\tens1\rc$, since
\ref{eq:tubes-stratification1bis} defines a ring homomorphism.

We next show that the isomorphism \ref{eq:tube-stratification1}
descends to an isomorphism
\begin{equation}
  \label{eq:tube-HPD-stratification5}
  P^n_{A/R,(m)}\ctens_{A}A[N^{p^i}]
  \isom
  A[N^{p^i}]\ctens_{A_n}P^n_{A/R,(m)}.
\end{equation}
Let $C$ be the $p$-torsion submodule of $A\lc N^{p^i}\rc$, so that
by definition
\begin{equation}
  \label{eq:short-exact-seq-for-A[N]}
  0\to C\to A\lc N^{p^i}\rc\to A[N^{p^i}]\to 0
\end{equation}
is exact. Since $P^n_{A/R,(m)}$ is projective
for the right $A$-module structure
\begin{displaymath}
  0\to C\tens_AP^n_{A/R,(m)}\to A\lc N^{p^i}\rc\tens_AP^n_{A/R,(m)}\to
  A[N^{p^i}]\tens_AP^n_{A/R,(m)}\to 0 
\end{displaymath}
is also exact, and for the same reason
$A[N^{p^i}]\tens_AP^n_{A/R,(m)}$ has no $p$-torsion. On the other hand
$C\tens_AP^n_{A/R,(m)}$ is $p$-torsion, and is therefore the
$p$-torsion submodule of $A\lc N^{p^i}\rc\tens_AP^n_{A/R,(m)}$. Now
$P^n_{A/R,(m)}$ is also projective for the left structure, so the same
argument shows that $P^n_{A/R,(m)}\tens_AC$ is the $p$-torsion
submodule of $P^n_{A/R,(m)}\tens_AA\lc N^{p^i}\rc$. Since the
isomorphisms \ref{eq:tube-stratification1} must identify the
$p$-torsion submodules, it follows that they induce isomorphisms of
rings
\begin{equation}
  \label{eq:tube-stratification6}
  P^n_{A/R,(m)}\tens_AA[N^{p^i}]
  \isom
  A[N^{p^i}]\tens_AP^n_{A/R,(m)}  
\end{equation}
which restrict to the identity on the diagonal and satisfy the cocycle
condition. We have thus defined an $m$-PD-stratification of
$A[N^{p^i}]$. 

Rephrasing in terms of ideals, we get the following.

\begin{prop}\label{prop:Dm-module-str-on-tubes}
  Let $J\sset A$ be an ideal (i) If $0\le m<i$, the $A$-algebra
  $A[\niv{J}{p^i}]$ has a canonical $\niv{D}{m}_{A/R}$-module
  structure. (ii) For $m<i\le j$, the canonical homomorphisms
  $A[\niv{J}{p^j}]\to A[\niv{J}{p^i}]$ is $\niv{D}{m}_{A/R}$-linear.
\end{prop}
\begin{demo}
  In fact (i) follows from the preceding computations and the remark
  after lemma \ref{lemma:tubes-and-generators}. For (ii) we choose a
  generating set $N$ of $J$; it suffices to show that the diagram
  \begin{displaymath}
    \xymatrix{
      P^n_{A/R,(m)}\tens_AA[N^{p^j}]\ar[r]\ar[d]
      &A[N^{p^j}]\tens_AP^n_{A/R,(m)}\ar[d]\\
      P^n_{A/R,(m)}\tens_AA[N^{p^i}]\ar[r]
      &A[N^{p^i}]\tens_AP^n_{A/R,(m)}.
    }
  \end{displaymath}
  is commutative, the horizontal arrows being the stratification
  corresponding to the $\niv{D}{m}$-module structure. Recall that the
  homomorphism $A[\niv{J}{p^j}]\to A[\niv{J}{p^i}]$ is
  \ref{eq:passage-to-smaller-tube2} with $N$ replaced by $N^{p^i}$ and
  $r=p^{j-i}$: explicitly it is
  $T_{f^{p^j}}\mapsto f^{p^j-p^i}T_{f^{p^i}}$. It suffices to check that
  \begin{multline*}
    d_0(f)^{p^j-p^i}(T_{f^{p^i}}\tens1)
    +\niv{\varphi}{m}_{p^j}(d_0(f),d_1(f))\\
    =d_1(f)^{p^j-p^i}(T_{f^{p^i}}\tens1
    +\niv{\varphi}{m}_{p^i}(d_0(f),d_1(f)))
  \end{multline*}
  holds in $A[N^{p^i}]\tens_AP_{(m)}$. Since $A[N^{p^i}]$ is
  $p$-torsion free this may be checked after multiplication by $p$, in
  which case it follows from the equality $pT_{f^{p^i}}=d_0(f)^{p^i}$ in
  $A[N^{p^i}]\tens_AP_{(m)}$. We conclude that the homomorphism
  \ref{eq:tube-stratification6} is compatible with the
  $m$-PD-stratifications of $A[N^{p^i}]$, and is therefore
  $\niv{D}{m}_{A/R}$-linear.
\end{demo}

Suppose now that
\begin{displaymath}
  \xymatrix{
    A\ar[r]&A'\\
    R\ar[r]\ar[u]&R'\ar[u]
  }
\end{displaymath}
is a commutative diagram of rings with $A/R$ and $A'/R'$
quasi-smooth. If $N\subset A$ and $N'$ is the image of $N$ under
$A\to A'$, the canonical surjective morphism
\ref{eq:tube-base-change2} applied to $N^{p^i}$ is
\begin{equation}
  \label{eq:tube-base-change3}
  A'\tens_AA[N^{p^i}]\to A'[(N')^{p^i}]
\end{equation}
and the following assertion is clear from the construction:

\begin{prop}\label{prop:Dm-linearity-of-tube-base-change}
  When $m<i$, the morphism \ref{eq:tube-base-change3} is
  $\niv{D}{m}_{A'/R'}$-linear.\nodemo
\end{prop}

\subsection{Tube algebras and Frobenius.}
\label{sec:tubes-frobenius}

We now investigate the behavior of the algebras $A[J]$ with respect to
a relative Frobenius. As before $R$ is an adic noetherian
$\bZ_p$-algebra with an $m$-PD-structure $(\fa,\fb,\alpha)$. Then $p$
is topologically nilpotent in $R$, and from this it follows that $\fa$
is a topologically nilpotent ideal: if $f\in\fa$ then
$f^{p^{m+1}}\in pR$, and this implies that $\fa^N\sset pR$ for
$N\gg0$; in fact if $\fa$ is generated by $r$ elements we may take
$N=p^{m+1}r$.

For the rest of this section we assume that $p\in\fa$, so that
$R_0=R/\fa$ is a ring of characteristic $p$; furthermore we fix a flat
noetherian adic $R$-algebra $A$ and set $A_0=A/\fa A$ (note that this
is inconsistent with some earlier notation). Let $q=p^s$ be a power of
$p$ and denote by $F_{R_0}:R_0\to R_0$ and $F_{A_0}:A_0\to A_0$ the
$q$th power Frobenius homomorphisms. The relative Frobenius
$F_{A_0/R_0}$ is $R_0\tens_{R_0,F_{R_0}}A_0\to A_0$ is
$a\tens b\mapsto ab^q$, and if
$W_{A_0/R_0}:A_0\to R_0\tens_{R_0,F_{R_0}}A_0$ is the map
$b\mapsto 1\tens b$ then $F_{A_0}=F_{A_0/R_0}\circ
W_{A_0/R_0}$. Finally, we make the following assumptions:
\begin{enumerate}
\item $J\subset A$ is an ideal of definition containing $\fa A$;
\item there is a flat $R$-morphism $F:A'\to A$ whose reduction modulo
  $\fa$ is $F_{A_0/R_0}$.
\end{enumerate}
Since $\fa$ is topologically nilpotent there are always ideals $J$
satisfying \ref{sec:tubes-frobenius}.1. Furthermore if $F_{A_0/R_0}$
lifts at all then \ref{sec:tubes-frobenius}.2 is automatic if
$F_{A_0/R_0}$ is flat, which by proposition
\ref{prop:flatness-of-Frobenius} is the case if $R_0\to A_0$ is
quasi-smooth. Since $p\in\fa\sset J$,
\begin{displaymath}
  A'/\fa A':=A'_0\simeq R_0\tens_RA'
\end{displaymath}
and if $J_0=JA_0$, $W_{A_0/R_0}(J_0)A'_0$ is an ideal of definition of
$A'_0$. In what follows we denote reduction modulo $\fa$ by
$x\mapsto\bar x$; with this notation
\begin{displaymath}
  J'=\{x\in A'\,|\, \bar x\in W_{A_0/R_0}(J_0)A'_0\}
\end{displaymath}
is an ideal of definition of $A'$ containing $\fa A'$. By construction
we have $F(J')\sset J$, so $F$ induces a morphism $F:A'[J']\to A[J]$.

The proof of the next proposition borrows the argument of
\cite[\S2.2]{berthelot:2000} showing that $F^*$ increases the level:

\begin{prop}\label{prop:Frobenius-and-tubes}
  With the assumptions \ref{sec:tubes-frobenius}.1--2, the homorphism
  $F:A'\to A$ induces a $\niv{D}{m}_{A/R}$-linear isomorphism
  \begin{displaymath}
    A\tens_{A'}A'[\niv{(J')}{p^i}]\isom A[\niv{J}{p^{i+s}}]  
  \end{displaymath}
  for all $i>m$.
\end{prop}
\begin{demo}
  If $J''$ denotes the image of $J'$ under $F:A'\to A$, assumption
  \ref{sec:tubes-frobenius}.1 shows that the base change map
  \begin{displaymath}
    A\tens_{A'}A'[\niv{(J')}{p^i}]\to A[\niv{(J'')}{p^i}]
  \end{displaymath}
  is an isomorphism. It thus suffices to show that the
  morphism
  \begin{displaymath}
    A[\niv{(J'')}{p^i}]\to A[\niv{J}{p^i}]
  \end{displaymath}
  induced by the inclusion $J''\sset J$ induces the isomorphism of the
  proposition, which is automatically $\niv{D}{m}_{A/R}$-linear by
  proposition \ref{prop:Dm-linearity-of-tube-base-change}.

  We know that this map is injective, so it suffices to show that it
  is surjective. Pick $g\in J$ and choose $f\in J'$ such that
  $\bar f=W_{A_0/R_0}(\bar g)$; then $F(f)$ reduces to
  $F_{A_0/R_0}W_{A_0/R_0}(g)=\bar g^{p^s}$ and
  \begin{displaymath}
    F(f)=g^{p^s}+h\quad\text{for some}\ h\in\fa A.
  \end{displaymath}
  Taking powers we get
  \begin{displaymath}
    F(f^{p^i})=g^{p^{s+i}}+h^{p^i}+p(\text{element of $A$}).
  \end{displaymath}
  Now $h^{p^i}\in\niv{\fa}{p^i}A+pA$, and if $i>m$ then
  $\niv{\fa}{p^i}\sset pA$. Therefore
  \begin{displaymath}
    \text{for $i>m$},\ F(f^{p^i})=g^{p^{i+s}}+ph'\quad h'\in A.
  \end{displaymath}
  This and the canonical isomorphism \ref{eq:invariance-of-A[N]} show
  that for all $g\in J$, $T_{g^{p^{i+s}}}\in A[\niv{J}{p^{i+s}}]$ is
  in the image of $A[\niv{(J'')}{p^i}]$, which establishes the claim.
\end{demo}

\subsection{Completion.}
\label{sec:completion-of-tubes}

Before we can globalize these constructions we must take
completions. In this section $A$ is an adic noetherian ring with ideal
of definition $J$. For $N\sset A$ We denote by $A[[N]]$ (resp.
$A\lcc N\rcc$) the $J$-adic completion of $A[N]$ (resp $A\lc N\rc$).
For example if $R$ is adic noetherian with ideal of definition
$\fm$, $A=R[X_1,\ldots,X_d]$ and $J=\fm A$, the example in section
\ref{sec:tubes} shows that $A[[N]]=A\lcc N\rcc$
is the ring of restricted power series over $R$ in the $X_i/p$.

\subsubsection{}
The $A$-algebra $A[[N]]$ represents a functor similar to the one
defining $A[N]$, which gives rise to the universal property of
$A[[N]]$: for any $J$-adically complete $A$-algebra $B$, if the
structure morphism $f:A\to B$ is such that $f(N)\sset pB$, it factors
uniquely through an $A$-algebra homomorphism $A[[N]]\to B$. From this
we get properties of $A[[N]]$ analogous to those proven for $A[N]$:
\begin{enumerate}
\item If $N\sset N'\sset A$ there is a canonical $A$-algebra
  homomorphism $A[[N]]\to A[[N']]$ extending the homomorphism
  $A[N]\to A[N']$.
\item If $I$ is the ideal generated by $N$ then $A[[N]]\simeq A[[J]]$
  canonically.
\item If $A'$ is a flat $A$-algebra, the canonical homomorphism
  $A'\ctens_AA[[N]]\to A'[[N]]$ is an isomorphism.
\item Suppose that the image of $I$ in $A/pA$ is generated by a
  regular sequence, $A$ is $\bZ_p$-flat and the canonical homomorphism
  $A\to A/I:=R$ has a section. Then via this section, $A[[I]]$ is a
  flat $R$-algebra.
\end{enumerate}

The conclusion of proposition \ref{prop:independence-of-tube-mod-p}
holds for $A[[N]]$: it is independent of $N$ modulo $p$ up to
canonical isomorphism. The construction $A[[N]]$ commutes with formal
localization; we will only state the particular case which is needed
for sheafifying $A[[N]]$: for any $f\in A$, the natural morphism
$A[[N]]_{\{f\}}\to A_{\{f\}}[[N]]$ is an isomorphism (here $N$ denotes
both a subset of $A$ and its image in $A_{\{f\}}$). From
\ref{sec:completion-of-tubes}.2 we see that $A[[J]]$ is the completion
of a finitely generated $A$-algebra, and is therefore noetherian. It
is of course adic by construction.

Suppose now $R$ is adic noetherian with an $m$-PD-structure
$(\fa,\fb,\alpha)$, and $A$ is a quasi-smooth $R$-algebra. In section
\ref{sec:Dm-modules-on-tubes} we showed that for any $i>m$ and
$N\sset A$, $A[N^{p^i}]$ has a canonical left
$\niv{D}{m}_{A/R}$-module structure. We now show that this extends to
a quasi-nilpotent left $\niv{\hat D}{m}_{A/R}$-module structure on
$N\sset A$, $A[[N^{p^i}]]$. At this point we assume that $J$ is
$m$-bilateralising.

The first step is show that $A\lcc N\rcc$ has a quasi-nilpotent left
$\niv{\hat D}{m}_{A/R}$-module structure. Setting as before
$R_n=R/p^{n+1}R$ and $A_n=A/p^{n+1}A$, we 
may use \ref{eq:tubes-stratification1bis} to define an isomorphism
\begin{equation}
  \label{eq:tube-stratification2}
  P_{A_n/R_n,(m)}\tens_{A_n}A_n\lc N^{p^i}\rc
  \isom
  A_n\lc N^{p^i}\rc\tens_{A_n}P_{A_n/R_n(m)}  
\end{equation}
which reduces to the identity under base change by $P_{A_n/R_n(m)}\to
A_n$ and satisfies the cocycle condition. If now $J$ is an
$m$-bilateralising ideal of definition of $A$ and $p^{n+1}\in J$, we
may change base in \ref{eq:tube-stratification2} by $A_n\to A/J$,
obtaining an isomorphism
\begin{displaymath}
  P_{A/R,J,(m)}\tens_{A/J}(A_n\lc N^{p^i}\rc\tens_{A_n}A/J)
  \isom
  (A_n\lc N^{p^i}\rc\tens_{A_n}A/J)\tens_{A/J}P_{A/R,J,(m)}    
\end{displaymath}
with the same properties. Passing to the inverse limit in $J$ yields
the desired isomorphism
\begin{equation}
  \label{eq:tube-stratification3}
  \hat P_{A/R,(m)}\tens_{A/J}A\lcc N^{p^i}\rcc
  \isom
  A\lcc N^{p^i}\rcc\tens_{A/J}\hat P_{A/R,J,(m)}  
\end{equation}
reducing to the identity under the base change $\hat P_{A/R(m)}\to
A$ and satisfying the cocycle condtion. This $m$-HPD-stratification is
compatible with the $A$-algebra structure of $A\lcc N^{p^i}\rcc$ since
\ref{eq:tubes-stratification1bis} defines a ring homomorphism. By
construction, the induced $m$-PD-stratification coincides with the one
described earlier, and thus corresponds to the same
$\niv{D}{m}_{A/R}$-module structure. 

The $J$-adic completion of the short exact sequence
\ref{eq:short-exact-seq-for-A[N]} is the short exact sequence
\begin{displaymath}
  0\to \hat C\to A\lcc N^{p^i}\rcc\to A[[N^{p^i}]]\to 0
\end{displaymath}
and shows that $A[[N^{p^i}]]$ may be identified with the quotient of
$A\lcc N^{p^i}\rcc$ by its $p$-torsion submodule. By construction this
is an exact sequence of $\niv{\hat D}{m}_{A/R}$-modules, and since 
$A\lcc N^{p^i}\rcc$ is quasi-nilpotent, $A[[N^{p^i}]]$ is
quasi-nilpotent as well. 

Restating this in terms of ideals, we get the following version of
proposition \ref{prop:Dm-module-str-on-tubes}; the proof of the second
part is the same as before.

\begin{prop}\label{prop:Dmhat-module-str-on-tubes}
  Let $J\sset A$ be an ideal (i) If $0\le m<i$, the $A$-algebra
  $A[[\niv{J}{p^i}]]$ has a canonical quasi-nilpotent
  $\niv{\hat D}{m}_{A/R}$-module structure, or in other words a
  canonical $m$-HPD-stratification
  \begin{equation}
    \label{eq:m-HPD-stratfication-of-complete-tube}
    \hat P_{A/R,(m)}\ctens_AA[[\niv{J}{p^i}]]
    \isom
    A[[\niv{J}{p^i}]]\ctens_A\hat P_{A/R,(m)}
  \end{equation}
  compatible with its $A$-algebra structure. (ii) For $m<i\le j$, the
  canonical homomorphisms $A[[\niv{J}{p^j}]]\to A[[\niv{J}{p^i}]]$ is
  $\niv{\hat D}{m}_{A/R}$-linear.\nodemo
\end{prop}

In the situation of \S\ref{sec:tubes-frobenius}, we get:

\begin{prop}\label{prop:Frobenius-and-tubes}
  With the assumptions \ref{sec:tubes-frobenius}.1--2, the homorphism
  $F:A'\to A$ induces a $\niv{\hat D}{m}_{A/R}$-linear isomorphism
  \begin{displaymath}
    A\tens_{A'}A'[[\niv{(J')}{p^i}]]\isom A[[\niv{J}{p^{i+s}}]]
  \end{displaymath}
  for all $i>m$.\nodemo
\end{prop}

\subsection{Globalization.}
\label{sec:global-tubes}

Before going on we restate the results so far in global form. In what
follows $\cX$ is an adic locally noetherian flat formal
$\bZ_p$-scheme.

\subsubsection{Global tube algebras.}
\label{sec:global-tube-algebras}

For any ideal of definition $J\subset\O_\cX$ there is an
$\O_\cX$-algebra $\O_\cX[J]$ with the property that for any affine
open $U=\Spf{A}$, $\Gamma(U,\O_\cX[J])\simeq A[[J]]$. As the latter is
a topologically finitely generated $B$-algebra, $\O_\cX[J]$ is a
coherent sheaf of rings on $\cX$, and for any open ideal
$K\subset\O_\cX$, $\O_\cX[J]\tens_{\O_\cX}(\O_{\cX_K})$ is a
quasi-coherent $\O_{\cX_K}$-algebra. For $J'\sset J\subset\O_\cX$
there is a canonical $\O_\cX$-algebra homomorphism
$\O_\cX[J]\to\O_\cX[J']$. A morphism $f:\cY\to\cX$ of adic locally
noetherian formal schemes induces a canonical homomorphism
$f^*\O_\cX[J]\to\O_\cY[f^*J]$.

Since the rings $A[[J]]$ are adic noetherian, we could introduce a
formal scheme $\cX[J]$ by patching together the $A[[J]]$; then
$\cX[J]\to\cX$ has the property that if $f:\cY\to\cX$ is a morphism
with $\cY$ adic, locally noetherian and $\bZ_p$-flat, and if
$f^*J\sset p\O_\cY$, then $f$ has a unique factorization through
$\cY\to\cX[J]$. We will prefer to use $\O_\cX[J]$ however.

\subsubsection{$\niv{\hD}{m}$-module structure.}
\label{sec:global-tube-Dm-module}

Suppose next that $\cS$ is an adic locally noetherian flat formal
$\bZ_p$-scheme with an $m$-PD-structure $(\fa,\fb,\alpha)$ and
$\cX\to\cS$ is a quasi-smooth formal $\cS$-scheme. If $J\subset\O_\cX$
is an ideal of definition and $i>m$, the $\O_\cX$-algebra
$\O_\cX[\niv{J}{p^i}]$ has a canonical $m$-HPD-stratification
\begin{equation}
  \label{eq:tube-m-HPD-stratification}
  \cP_{\cX/\cS,(m)}\ctens_{\O_\cX}\O_\cX[\niv{J}{p^i}]
  \isom
  \O_\cX[\niv{J}{p^i}]\ctens_{\O_\cX}\cP_{\cX/\cS,(m)}
\end{equation}
relative to $\cS$, compatible with its algebra
structure. Equivalently, it has a canonical quasi-nilpotent
$\niv{\hD}{m}_{\cX/\cS}$-module structure; the stratification and
$\niv{\hD}{m}_{\cX/\cS}$-module structure are compatible with the ring
structure. For $m<i\le j$ the canonical $\O_\cX$-algebra homomorphism
$\O_\cX[\niv{J}{p^j}]\to\O_\cX[\niv{J}{p^i}]$ is
$\niv{\hD}{m}_{\cX/\cS}$-linear. If $f:\cY\to\cX$ is an
$\cS$-morphism, the canonical homomorphism
$f^*\O_\cX[\niv{J}{p^i}]\to\O_\cY[\niv{(f^*J)}{p^i}]$ is
$\niv{\hD}{m}_{\cY/\cS}$-linear.

\subsubsection{Frobenius pullbacks.}
\label{sec:global-tube-Frobenius-pullback}

When $p\in\fa$ we denote by $X_0\to S_0$ the reduction modulo $\fa$ of
$\cX\to\cS$. Choose a power $q=p^s$ of $p$ and suppose the relative
$q$-th power Frobenius $F_{X_0/S_0}:X_0\to\niv{X_0}{q}$ of $X_0/S_0$
lifts to a flat morphism $F:\cX\to\cX'$ of $\cS$-schemes. There exist
ideals of definition of $\O_\cX$ containing $\fa\O_\cX$ and we let
$J\subset\O_\cX$ be one such. Denote by $W^*(J)\subset\O_{\cX'}$ the
inverse image by reduction modulo $\fa$ of the ideal
$W^*_{X_0/S_0}(J)\subset\O_{\niv{X_0}{q}}$; the notation is purely
symbolic since we are \emph{not} assuming that
$W^*_{X_0/S_0}:\niv{X_0}{q}\to X_0$ lifts to a morphism
$\cX'\to\cX$. Then $F$ induces a $\niv{\hD}{m}_{\cX/\cS}$-linear
isomorphism
\begin{equation}
  \label{eq:Frobenius-and-tubes-global}
  F^*\O_{\cX'}[\niv{W^*(J)}{p^i}]\isom\O_\cX[\niv{J}{p^{i+s}}]
\end{equation}
for all $i>m$. 

\begin{prop}\label{prop:O[J]-flatness}
  For any open ideals $J\sset J'\sset\O_\cX$, the natural morphism
  \begin{displaymath}
    \O_\cX[J]_\bQ\to\O_\cX[J']_\bQ
  \end{displaymath}
  is flat.
\end{prop}
\begin{demo}
  We may assume $\cX$ is affine, so let $A$ be an adic noetherian
  $\bZ_p$-algebra and $J\sset J'\sset A$ be open ideals.  We borrow an
  idea from the proof of \cite[Th. 3.5.3]{berthelot:1996}. Pick
  generating sets $N$ and $N'$ of $J$ and $J'$ such that $N\sset N'$.
  By the universal property of completed tube algebras, the second of
  the natural homomorphisms
  \begin{displaymath}
    A[[N]]\to A[[N]][N']\to A[[N']]
  \end{displaymath}
  identifies $A[[N']]$ with the $J$-adic completion of
  $A[[N]][N']$. Since both rings are noetherian, it follows that
  $A[[N]][N']\to A[[N']]$ and $A[[N]][N']_\bQ\to A[[N']]_\bQ$ are
  flat. The conclusion follows since $A[[N]]_\bQ\to A[[N]][N']_\bQ$ is
  an isomorphism.
\end{demo}

\subsection{Tube algebras and $m$-PD-envelopes.}
\label{sec:PD-envelopes-tubes}

Consider now the following situation: $R$ is an adic noetherian
$\bZ_p$-algebra with an $m$-PD-structure $(\fa,\fb,\alpha)$, $A$ is an
adic noetherian $R$-algebra and $I\subset A$ is an ideal; we assume
that the conditions \ref{sec:P_m(I)}.1--3 hold, and that $A$ has an
ideal of definition satisfying \ref{eq:special-J1}. In this situation
the $A$-algebra $\hat P_{A/R,(m)}$ has an $m$-PD-structure compatible
with $(\fa,\fb,\alpha)$, and we want to compare it with the tube
algebras $A[[\niv{I}{p^i}]]$ for $i\ge m$. The calculations in this
section are inspired by \cite[\S3.1]{berthelot:1990}, especially the
proof of \cite[Prop. 3.1.2]{berthelot:1990}.

As before we set $A'=A/I$, and recall from the discussion after
\ref{sec:P_m(I)}.1--3 that $I$ is a regular ideal; we will assume it
is generated by a regular sequence (this is true locally). For the
$A'$-algebra structure given by the section $\sigma:A'\to A$,
$A[\niv{I}{p^i}]$ is a flat $A'$ algebra, and condition
\ref{eq:special-J1} says that if $J$ is an ideal of definition of
$A'$, then $A[[\niv{I}{p^i}]]$ is the $J$-adic completion of
$A[\niv{I}{p^i}]$ for the $A'$-module structure defined by
$\sigma$. It follows that $A[[\niv{I}{p^i}]]$ is a flat
$A'$-algebra. Since by assumption $A'$ is a flat $R$-algebra, we see
that $A[\niv{I}{p^i}]$ and $A[[\niv{I}{p^i}]]$ are also $R$-flat.  The
last statement implies that the $m$-PD-structure $(\fa,\fb,\alpha)$
extends to $A[\niv{I}{p^i}]$ and $A[[\niv{I}{p^i}]]$; we denote the
extension of $\alpha$ to $\fb_1 A[[\niv{I}{p^i}]]$ by $\bar\alpha$.

We now claim that for $i=m$, the triple
\begin{displaymath}
  (I_0=I+\fb_1 A[[\niv{I}{p^m}]], I_1=\fb_1 A[[\niv{I}{p^m}]],\bar\alpha)
\end{displaymath}
is an $m$-PD-structure on $A[[\niv{I}{p^i}]]$ compatible with
$(\fa,\fb,\alpha)$. By construction $pI_0\sset I_1$. If
$f\in I$ then $f^{p^m}$ is divisible by $p$ in $A[[\niv{I}{p^m}]]$ and
thus belongs to $\fb_1 A[[\niv{I}{p^m}]]$; this shows that
$\niv{I_0}{p^m}\sset I_1$ and establishes the claim. The
$m$-PD-structure $(I_0,I_1,\bar\alpha)$ is compatible with
$(\fa,\fb,\alpha)$; in fact condition \ref{sec:m-PD-structures}.1 is
tautological, and since $\fb_1A[[\niv{I}{p^m}]]\sset I_0$, condition
\ref{sec:m-PD-structures}.2 holds as well.

Since $A[[\niv{I}{p^m}]]$ is an adic noetherian $A$-algebra with an
$m$-PD-strucutre compatible with $(\fa,\fb,\alpha)$, The universal
property of $\hat P_{(m)}(I)$ implies that the structure morphism
$A\to A[[\niv{I}{p^m}]]$ factors uniquely through a morphism
\begin{equation}
  \label{eq:envelope-to-tube}
  \hat P_{(m)}(I)\to A[[\niv{I}{p^m}]].
\end{equation}
Since it is an $m$-PD-morphism, it is determined by the fact that for
$x\in I$ it sends
\begin{equation}
  \label{eq:envelope-to-tube-explicit}
  \dpbrniv{x}{k}{m}\mapsto x^r\dpe{p}{q}T^q_{x^{p^m}}
\end{equation}
where as usual $k=p^mq+r$, $0\le r<p^m$.

On the other hand there is an $(m+1)$-PD-morphism
\begin{equation}
  \label{eq:tube-to-envelope}
  A[[\niv{I}{p^{m+1}}]]\to\hat P_{(m)}(I)
\end{equation}
arising from the universal property of $A[[\niv{I}{p^{m+1}}]]$. In fact
if $x\in I\subset A$ then $x^{p^{m+1}}$ becomes a multiple of $p$ in
$\hat P_{(m)}(I)$, whence a map \ref{eq:tube-to-envelope} since
$\hat P_{(m)}(I)$ is $J$-adically complete. It is determined by the
fact that for $x\in I$ it sends
\begin{equation}
  \label{eq:tube-to-envelope-explicit}
  T_{x^{p^{m+1}}}\mapsto (p-1)!\dpniv{x}{p^{m+1}}{m}.  
\end{equation}
In global terms, we have constructed an $m$-PD-morphism
\begin{equation}\label{eq:envelope-to-tube-global}
  \cP_{(m)}(I)\to\O_\cX[\niv{I}{p^m}]
\end{equation}
and an $(m+1)$-PD-morphism
\begin{equation}\label{eq:tube-to-envelope-global}
  \O_\cX[\niv{I}{p^{m+1}}]\to\cP_{(m)}(I)
\end{equation}
for the $(m+1)$-PD-structure of $\cP_{(m)}(I)$ arising from its
$m$-PD-structure.

\begin{prop}\label{prop:tube-to-envelope-compositions}
  (i) The composition
  \begin{equation}
    \cP_{(m+1)}(I)\to\O_\cX[\niv{I}{p^{m+1}}]\to\cP_{(m)}(I)
  \end{equation}
  is the change-of-level map \ref{eq:Pm-change-of-level}. (ii)
  The composition
  \begin{equation}
    \O_\cX[\niv{I}{p^{m+1}}]\to\cP_{(m)}(I)\to\O_\cX[\niv{I}{p^m}]
  \end{equation}
  is the natural map induced by the inclusion
  $\niv{I}{p^{m+1}}\subset\niv{I}{p^m}$. 
\end{prop}
\begin{demo}
  As usual we may work in an affine setting. (i) If $x\in I$ and
  $k=p^{m+1}q+r$, the composition maps
  \begin{displaymath}
    \dpbrniv{x}{k}{m+1}\mapsto x^r\dpe{p}{q}((p-1)!\dpe{(x^{p^m})}{p})^q
  \end{displaymath}
  so we must check that if $k=p^mq'+r'$,
  \begin{displaymath}
    x^r\dpe{p}{q}((p-1)!\dpe{(x^{p^m})}{p})^q
    =\frac{q'!}{q!}x^{r'}\dpe{(x^{p^m})}{q'}.
  \end{displaymath}
  Now a PD-identity can be checked by reduction to the universal case,
  where it may be checked after multiplication by $q!$, but then the
  identity $q!\dpe{x}{q}=x^q$ shows that both sides are $x^k$.

  For (ii) we choose a generating set $N\subset I$ and compute in
  $A_n\lc N^{p^{m+1}}\rc$ and $A_n\lc N^{p^m}\rc$ as follows. By
  construction the first map sends
  \begin{displaymath}
    T_{f^{p^{m+1}}}\mapsto (p-1)!\dpniv{f}{p^{m+1}}{m}
    =(p-1)!\dpe{(f^{p^m})}{p}
  \end{displaymath}
  and since $pT_{f^{p^m}}=f^{p^m}$ in $A_n\lc N^{p^m}\rc$, this in turn is
  mapped to
  \begin{align*}
    (p-1)!\dpe{(pT_{f^{p^m}})}{p}
    &=(p-1)!\dpe{(p)}{p}T_{f^{p^m}}^p\\
    &=p^{p-1}T_{f^{p^m}}^p=(f^{p^m})^{p-1}T_{f^{p^m}}\\
    &=f^{p^{m+1}-p^m}T_{f^{p^m}}.
  \end{align*}
  By lemma \ref{lemma:passage-to-smaller-tube} the composition is the
  morphism $A[\niv{I}{p^{m+1}}]\to A[\niv{I}{p^m}]$ induced by the
  containment $\niv{I}{p^{m+1}}\subset\niv{I}{p^m}$, which on
  completion yields the canonical morphism
  $A[[\niv{I}{p^{m+1}}]]\to A[[\niv{I}{p^m}]]$.
\end{demo}

Suppose now we are given a commutative diagram
\begin{displaymath}
  \xymatrix{
    \cX'\ar[r]^f&\cX\\
    \cS'\ar[u]\ar[r]_g&\cS\ar[u]
  }
\end{displaymath}
in which $\cS$ and $\cS'$ are adic locally noetherian $\bZ_p$-schemes
with $m$-PD-structures $(\fa,\fb,\alpha)$ and $(\fa',\fb',\alpha')$,
$g$ is an $m$-PD-morphism, $\cX$ (resp. $\cX'$) is a quasi-smooth
formal $\cS$-scheme (resp $\cS'$-scheme), and $f$ is a
morphism of adic locally noetherian formal schemes such that
$f^*I\sset I'$. We assume that conditions \ref{sec:P_m(I)}.1--3 hold
both for $I\subset\O_\cX$ and $I'\subset\cX'$ relative to $\cS$ and
$\cS'$ respectively, and that both $\cX$ and $\cX'$ have ideals of
definition locally satisfying condition \ref{eq:special-J1}. The
formulas \ref{eq:envelope-to-tube} and \ref{eq:tube-to-envelope} and
the fact that $f$ is an $m$-PD-morphism shows that the diagram
\begin{equation}
  \label{eq:m-PD-to-analytic-base-change}
  \xymatrix{
    \O_\cX[[\niv{I}{p^{m+1}}]]\ar[r]\ar[d]
    &\cP_{(m),\alpha}(I)\ar[r]\ar[d]
    &\O_\cX[[\niv{I}{p^m}]]\ar[d]\\
    \O_{\cX'}[[\niv{I'}{p^{m+1}}]]\ar[r]
    &\cP_{(m),\alpha'}(I')\ar[r]
    &\O_{\cX'}[[\niv{I'}{p^m}]]
  }
\end{equation}
is commutative.

\subsection{Analytic stratifications.}
\label{sec:analytic-stratifications}

The close relation between tubes and $m$-PD-envelopes suggests that we
work out the corresponding notion of stratification.  As before $R$ is
an adic noetherian $\bZ_p$-algebra, $R\to A$ is quasi-smooth, $A_R(r)$
is the completed tensor product of $r+1$ copies of $A$ over $R$ and
$I\subset A_R(r)$ is the diagonal ideal.

\subsubsection{}

To emphasize the analogy with $m$-PD-envelopes we define
\begin{equation}
  \label{eq:analytic-Pm}
  \hat P^\an_{A/R,(m)}(r)=A_R(r)[[\niv{I}{p^m}]]
\end{equation}
and when $r=1$ we write $P^\an_{A/R,(m)}(1)=P^\an_{A/R,(m)}$. When
$\cX\to\cS$ is a quasi-smooth morphism, the corresponding objects are
denoted by $\cP^\an_{\cX/\cS,(m)}(r)$ and, when $r=1$,
$\cP^\an_{\cX/\cS,(m)}$. These are endowed with morphisms
$d_i:\O_\cX\to\cP^\an_{\cX/\cS,(m)}(r)$ for $0\le i\le r$, and more
generally with morphisms
\begin{displaymath}
  d_K:\cP^\an_{\cX/\cS,(m)}(r)\to\cP^\an_{\cX/\cS,(m)}(r')
\end{displaymath}
for $r'\ge r$, where $K$ is subsequence of $[0,1,\ldots,r']$, as well
as morphisms
\begin{displaymath}
  s_K:\cP^\an_{\cX/\cS,(m)}(r')\to\cP^\an_{\cX/\cS,(m)}(r)
\end{displaymath}
for $r'\ge r$, where now $K$ is subsequence of $[0,1,\ldots,r]$. When
$r'=1$ and $r=0$, $s_0$ is the canonical projection
$\cP^\an_{\cX/\cS,(m)}\to\O_\cX$. The morphisms
\ref{eq:envelope-to-tube-global} and \ref{eq:tube-to-envelope-global}
in the present case are
\begin{equation}
  \label{eq:envelope-and-tube-of-diagonal}
  \cP^\an_{\cX/\cS,(m+1)}(r)\to\cP_{\cX/\cS,(m)}(r)\to\cP^\an_{\cX/\cS,(m)}(r).
\end{equation}
Let $K$ (resp. $K'$ be an increasing subsequence of $[0,\ldots,r]$
(resp. $[0,\ldots,r']$). The diagram
\begin{equation}
  \label{eq:envelope-and-tube-of-diagonal-morphisms}
  \xymatrix{
    \cP^\an_{\cX/\cS,(m+1)}(r')\ar[r]\ar@/^/[d]^{s_K}
    &\cP_{\cX/\cS,(m)}(r')\ar[r]\ar@/^/[d]^{s_K}
    &\cP^\an_{\cX/\cS,(m)}(r')\ar@/^/[d]^{s_K}\\
    \cP^\an_{\cX/\cS,(m+1)}(r)\ar[r]\ar@/^/[u]^{d_K'}
    &\cP_{\cX/\cS,(m)}(r)\ar[r]\ar@/^/[u]^{d_K'}
    &\cP^\an_{\cX/\cS,(m)}(r)\ar@/^/[u]^{d_K'}
  }
\end{equation}
is commutative, being \ref{eq:m-PD-to-analytic-base-change} applied to
the morphisms $d_{K'}:\cX_\cS(r)\to\cX_\cS(r')$ and
$s_K:\cX_\cS(r')\to\cX_\cS(r)$.

As is the case for the $m$-PD-envelopes $\cP_{\cX/\cS,(m)}(r)$, there
is a canonical isomorphism
\begin{displaymath}
  \cP^\an_{\cX/\cS,(m)}(r)\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m)}(r')
  \isom\cP^\an_{\cX/\cS,(m)}(r+r')  
\end{displaymath}
for all $r$, $r'\ge0$. The case $r=r'=1$ is important since it means
that the morphism
$d_{02}:\cP^\an_{\cX/\cS,(m)}\to\cP^\an_{\cX/\cS,(m)}(2)$ can be
identified with a morphism
\begin{equation}
  \label{eq:analytic-delta}
  \delta^\an_{(m)}:\cP^\an_{\cX/\cS,(m)}\to
  \cP^\an_{\cX/\cS,(m)}\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m)}
\end{equation}
which is compatible with the morphisms
\ref{eq:envelope-and-tube-of-diagonal} in a sense which should be
obvious. 

\subsubsection{}

An \textit{analytic stratification of level $m$} of an $\O_\cX$-module
$M$ is a $\cP^\an_{\cX/\cS,(m)}$-linear isomorphism
\begin{equation}
  \label{eq:analytic-stratification}
  \chi:\cP^\an_{\cX/\cS,(m)}\ctens_{\O_\cX}M\isom
  M\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m)}
\end{equation}
which becomes the identity of $M$ after the change of ring
$s_0:\cP^\an_{\cX/\cS,(m)}\to\O_\cX$ and satisfies an evident analogue
of the cocycle condition. The morphisms
\ref{eq:envelope-and-tube-of-diagonal} allow us to derive an analytic
stratification of level $m$ from an $m$-HPD-stratification, and an
$m$-HPD-stratification from an analytic stratification of level $m+1$,
as one sees from the commutative diagram
\ref{eq:envelope-and-tube-of-diagonal-morphisms}.

We now show that when $i> m$ and $J\sset\O_\cX$ is open, the
$\O_\cX$-module $\O_\cX[\niv{J}{p^i}]$ has an analytic stratification
of level $m$. We can work locally on $\cX$ and $\cS$, so we assume
$\cX=\Spf{A}$ and $\cS=\Spf{R}$ for some quasi-smooth $R$-algebra
$A$. It will be convenient to set $B=A_R(1)=A\ctens_RA$; if
$I\subset B$ is the diagonal ideal, we must construct an
isomorphism
\begin{equation}
  \label{eq:analytic-stratification}
  B[[\niv{I}{p^m}]]\ctens_AA[[\niv{J}{p^i}]]\isom
  A[[\niv{J}{p^i}]]\ctens_AB[[\niv{I}{p^m}]]
\end{equation}
with the required properties for any $i>m$. 

Since $B$ is a Zariski ring for its natural ($I$-adic) topology
we may apply proposition \ref{prop:regular-tubes} to conclude that
$B[I]$ is a flat $A$-algebra with respect to both left and right
$A$-algebra structures. This yields an isomorphism
\begin{displaymath}
  B[\niv{I}{p^m}]\tens_AA[\niv{J}{p^i}]
  \isom B[\niv{I}{p^m}+B\niv{J}{p^i}]
\end{displaymath}
whose $J$-adic completion is the isomorphism
\begin{equation}
  \label{eq:[X]_m,i}
  B[[\niv{I}{p^m}]]\ctens_AA[[\niv{J}{p^i}]]
  \isom B[[\niv{I}{p^m}+B\niv{J}{p^i}]].  
\end{equation}
The same argument with the left structure yields an isomorphism
\begin{displaymath}
  A[[\niv{J}{p^i}]]\ctens_AB[[\niv{I}{p^m}]]
  \isom B[[\niv{I}{p^m}+\niv{J}{p^i}B]].
\end{displaymath}
Since $\niv{I}{p^m}+pB$ is generated by $p$ and elements of the
form
\begin{equation}
  \label{eq:delta-again}
\delta(f^{p^i})=1\ctens f^{p^i}-f^{p^i}\ctens1\in\niv{I}{p^m}
\end{equation}
the condition $i\ge m$ implies that
\begin{displaymath}
  \niv{I}{p^m}+B\niv{J}{p^i}+pB
  =\niv{I}{p^m}+\niv{J}{p^i}B+pB  
\end{displaymath}
are the same ideal of $B$, as one sees from \ref{eq:delta-again}. It
follows that there are canonical identifications
\begin{equation}
  \label{eq:analytic-stratification-in-steps}
  \begin{split}
    B[[\niv{I}{p^m}+B\niv{J}{p^i}]]&\simeq
    B[[\niv{I}{p^m}+B\niv{J}{p^i}+\niv{J}{p^i}B]]\\
    B[[\niv{I}{p^m}+\niv{J}{p^i}B]]&\simeq
    B[[\niv{I}{p^m}+B\niv{J}{p^i}+\niv{J}{p^i}B]]
  \end{split}
\end{equation}
and the isomorphism \ref{eq:analytic-stratification} is an immediate
consequence. Since
\begin{displaymath}
  T_{\delta(f^{p^i})}=
  1\ctens T_{f^{p^i}}-T_{f^{p^i}}\ctens1
\end{displaymath}
in $B[[\niv{I}{p^m}+B\niv{J}{p^i}+\niv{J}{p^i}B]]$,
\ref{eq:analytic-stratification} is given explicitly by
\begin{equation}
  \label{eq:analytic-stratification-explicit}
  1\ctens T_{f^{p^i}}\mapsto
  T_{f^{p^i}}\ctens1+T_{\delta(f^{p^i})}.
\end{equation}

It is perhaps worth remarking on the geometrical picture behind the
isomorphism \ref{eq:analytic-stratification}. In a rigid-analytic
setting where $R$ is a complete discrete valuation ring and $A$ is an
$R$-algebra topologically of finite type, $A[[\niv{J}{p^i}]]_\bQ$ is
the function algebra of a closed tube of radius $|p|^{p^{-i}}$, and
likewise $B[[\niv{I}{p^m}]]_\bQ$ is the function algebra of a
closed tube of the diagonal of radius $|p|^{p^{-m}}$. Then
$\Max(B[[\niv{I}{p^m}]]_\bQ)$ has two projections to
$\Max(A_\bQ)$, and the algebra in \ref{eq:analytic-stratification} is
the function algebra of the inverse image by either of these
projections; the condition that $i\ge m$ guarantees that they are the
same (this is the triangle inequality, really). The picture suggests
that the $m$-PD-envelope is some kind of ``tube'' intermediate between
those of radius $|p|^{p^{-m}}$ and $|p|^{p^{-(m+1)}}$.

For $i>m$ the level $m$ analytic stratification
\begin{equation}
  \label{eq:analytic-stratification-of-O[J,m]}
  \cP^\an_{\cX/\cS,(m)}\ctens_{\O_\cX}\O_\cX[\niv{J}{p^i}]
  \isom
  \O_\cX[\niv{J}{p^i}]\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m)}  
\end{equation}
of $\O_\cX[\niv{J}{p^i}]$
coincides with the one derived from its $m$-PD-stratification, in the
sense that the diagram
\begin{equation}
  \label{eq:1st-tube-comparison}
  \xymatrix{
  \cP_{\cX/\cS,(m)}\ctens_{\O_\cX}\O_\cX[\niv{J}{p^i}]\ar[r]^\sim\ar[d]&
  \O_\cX[\niv{J}{p^i}]\ctens_{\O_\cX}\cP_{\cX/\cS,(m)}\ar[d]\\
  \cP^\an_{\cX/\cS,(m)}\tens_{\O_\cX}\O_\cX[\niv{J}{p^i}]\ar[r]^\sim&
  \O_\cX[\niv{J}{p^i}]\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m)}
  }
\end{equation}
is commutative, where the horizontal arrows are the isomorphisms
\ref{eq:m-HPD-stratfication-of-complete-tube} and
\ref{eq:analytic-stratification} and the vertical arrows are induced
by \ref{eq:envelope-to-tube}. The two horizontal arrows are
$\cP_{\cX/\cS,(m)}$-linear and $\cP^\an_{\cX/\cS,(m)}$-linear
respectively, and the vertical arrows are semilinear for the morphism
\ref{eq:envelope-to-tube}. In particular, all arrows are
$\O_{\cX_\cS(1)}$-linear. We may work locally, so it suffices to check
what happens to an element $1\ctens T_{f^{p^i}}$ in the upper left
corner. The path around the lower left hand corner sends it first to
$1\ctens T_{f^{p^i}}$ and then to
$T_{f^{p^i}}\ctens1+T_{\delta(f^{p^i})}$. The top horizontal arrow
sends it to
$T_{f^{p^i}}\ctens1+1\ctens\niv{\varphi}{m}_{p^i}(d_0(f),d_1(f))$, so
we must check that the map \ref{eq:envelope-to-tube} sends
\begin{displaymath}
  \niv{\varphi}{m}_{p^i}(d_0(f),d_1(f))
  \mapsto
  T_{\delta(f^{p^i})}
\end{displaymath}
Since $\cP^\an_{\cX/\cS,(m)}$ is $p$-torsion-free this may be checked
after multiplication by $p$, in which case it follows from the
identity
\begin{displaymath}
  p\niv{\varphi}{m}_{p^i}(d_0(f),d_1(f))=\delta(f^{p^i})
\end{displaymath}
in $P_{A/R,(m)}$, the identity
\begin{displaymath}
  pT_{\delta(f^{p^i})}=\delta(f^{p^i})
\end{displaymath}
in $\cP^\an_{\cX/\cS,(m)}$ and the $\O_{\cX_\cS(1)}$-linearity of
$\cP_{\cX/\cS,(m)}\to \cP^\an_{\cX/\cS,(m)}$.

We can likewise check that for $i\ge m$ the $m$-HPD-stratification of
$\O_\cX[\niv{J}{p^i}]$ is derived from its level $m+1$ analytic
stratification, in the sense that the diagram
\begin{equation}
  \label{eq:2nd-tube-comparison}
  \xymatrix{
    \cP^\an_{\cX/\cS,(m+1)}\tens_{\O_\cX}\O_\cX[\niv{J}{p^i}]\ar[r]^\sim\ar[d]&
    \O_\cX[\niv{J}{p^i}]\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m+1)}\ar[d]\\
    \cP_{\cX/\cS,(m)}\ctens_{\O_\cX}\O_\cX[\niv{J}{p^i}]\ar[r]^\sim&
    \O_\cX[\niv{J}{p^i}]\ctens_{\O_\cX}\cP_{\cX/\cS,(m)}
  }
\end{equation}
is commutative, with the same horizontal maps as before, and the
vertical ones being induced by \ref{eq:tube-to-envelope}. This is in
fact the same argument as before, using the fact that
$\cP^\an_{\cX/\cS,(m)}\to\cP_{\cX/\cS,(m)}$ maps
\begin{displaymath}
T_{1\ctens f^{p^i}-f^{p^i}\ctens1}\mapsto
\niv{\varphi}{m}_{p^i}(f\ctens1,1\ctens f)
\end{displaymath}
which may be checked in the same way. 

\subsubsection{}

The stratification \ref{eq:analytic-stratification-of-O[J,m]} is a
$\cP^\an_{\cX/\cS,(m)}$-algebra homomorphism, so we could say that the
\ref{eq:analytic-stratification-of-O[J,m]} is compatible with the algebra
structure of $\O_\cX[\niv{J}{p^i}]$ in the same sense that this term
is used for $m$-PD-stratifications. Motivated by the analogy of
\ref{eq:analytic-stratification-in-steps} and \ref{eq:cP_B}, we set
$\cB_i=\O_\cX[\niv{J}{p^i}]$ and denote by $\cP^\an_{\cB_i/\cS,(m)}$
the sheafified common right hand side of
\ref{eq:analytic-stratification-in-steps}, which now takes the form
\begin{align*}
  \alpha_0:\cB_i\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m)}
  &\isom\cP^\an_{\cB_i/\cS,(m)}\\
  \alpha_1:\cP^\an_{\cX/\cS,(m)}\ctens_{\O_\cX}\cB_i
  &\isom\cP^\an_{\cB_i/\cS,(m)}.
\end{align*}
Then $\chi=\alpha_1\circ\alpha_0$, and as in proposition
\ref{prop:m-HPD-stratified-algebra} the cocycle condition for
$\O_\cX[\niv{J}{p^i}]$ expresses the existence of a ring homomorphism
\begin{equation}
  \delta^\an_{(m),i}:\cP^\an_{\cB_i/\cS,(m)}\ctens\cP^\an_{\cB_i/\cS,(m)}
  \isom\cP^\an_{\cB_i/\cS,(m)}
\end{equation}
that is $(\cB_i,\cB_i)$-bilinear and semilinear for the homomorphism
$\delta^\an_{(m)}$ in \ref{eq:analytic-delta}.

If $M$ is a $\cB_i$-module, a level $m$ analytic stratification
\begin{displaymath}
  \chi:\cP^\an_{\cX/\cS,(m)}\ctens_{\O_\cX}M\isom M\ctens_{\O_\cX}\cP^\an_{\cX/\cS,(m)}  
\end{displaymath}
of $M$ is compatible with its $\cB_i$-module structure if it is
semilinear for \ref{eq:analytic-stratification-of-O[J,m]}. As before we
may express this as an isomorphism
\begin{equation}
  \label{eq:analytic-stratification-coefficients}
  \chi^{\cB_i}:
\cP^\an_{\cB_i/\cS,(m)}\ctens_{\cB_i}M\isom M\ctens_{\cB_i}\cP^\an_{\cB_i/\cS,(m)}
\end{equation}
which is the identity after the extension of scalars
$\cP^\an_{\cB_i/\cS,(m)}\to\cB_i$ and satisfies the following analogue of the
cocycle condition: if the $d^{\cB_i}_{jk}$ are defined analogously to 
\ref{eq:d_02^B} and \ref{eq:d_01,12^B} then
\begin{equation}
  \label{eq:analytic-cocycle-condition}
  (d^{\cB_i}_{02})_*(\chi^{\cB_i})=
  (d^{\cB_i}_{01})_*(\chi^{\cB_i})\circ(d^{\cB_i}_{12})_*(\chi^{\cB_i})
\end{equation}
for all $i\ge m$.

\section{Convergent Isocrystals.}
\label{sec:isocrystals}

From now on we will be working in the following setting. As before
$\V$ is a complete discrete valuation ring of mixed characteristic $p$
with residue field $k$ and fraction field $K$.  We fix a natural
number $m_0$ and assume the uniformizer $\pi\in\V$ is such that
$(\pi\V,\pi^{m_0}\V,[\ ])$ is an $m_0$-PD-structure on $\V$; this will
be the case if and only if the absolute ramification index $e$ of $\V$
satisfies $e\le p^{m_0}(p-1)$. For what we want to do the value of
$m_0$ is not particularly important. Finally $\cS=\Spf{\V}$ will have
the $m_0$-PD-structure $(\pi\V,\pi^{m_0}\V,[\ ])$.

\subsection{The category $\Isoc(\cX,J)$.}
\label{sec:convergent-isocrystals}

If $X$ is a $k$-scheme of finite type then locally on $X$ there are
closed immersions $X\to\cX$ over $\V$ with $\cX/\V$ quasi-smooth
formal and formally of finite type; it suffices for example to find a
smooth formal $\V$-scheme $\cP$ and a closed immersion $X\inj\cP$ over
$\V$ and let $\cX$ be the completion of $\cP$ along $X$.  In any case,
we suppose for the moment that such a closed immersion exists
globally, and let $\cX^\an$ be the analytic space associated to $\cX$
by the procedure of the last section. A convergent isocrystal on $X/K$
is a coherent $\O_{\cX^\an}$-module endowed with a convergent
connection; let us recall how this is defined: let $]X[_{\cX_\V(1)}$
be the tube of the diagonal $X\to\cX_\V(1)$ and $p_0$,
$p_1:\,]X[_{\cX_\V(1)}\to\cX^\an$ the canonical projections; a
convergent connection on an $\O_{\cX^\an}$-module $M$ is an
isomorphism $\chi:p_1^*M\isom p_0^*M$ that restricts to the identity
on the diagonal $\cX\to\cX_\V(1)$ and satisfies the usual cocycle
condtion on the tube of the diagonal $X\inj\cX_\V(2)$. Morphisms of
convergent isocrystals are $\O_{\cX^\an}$-linear maps horizontal for
the connection. The category of such objects will be denoted by
$\Isoc(X\subset\cX/K)$. Up to canonical equivalence it is independent
of the choice of $X\inj\cX$, and is of local nature on $X$, i.e. the
fibered category $U\mapsto\Isoc(U\subset(\cX\cap U)/K)$ is a stack in
the Zariski topology of $X$. This allows one to define a category
$\Isoc(X/K)$ if no global embedding is available; we assume the
details are known to the reader.

Our aim is to describe the category $\Isoc(X\subset\cX/K)$ in terms of
the constructions worked out in the previous sections. Fix an ideal of
definition $J\subset\O_\cX$; when $m\ge m_0$ it will be convenient to
write $\cB_{J,m}$ or $\cB_m$ for the $\O_\cX$-algebra
$\O_\cX[\niv{J}{p^{m+1}}]$. With this notation, $\cB_{J,m}$ has a
canonical quasi-nilpotent left $\niv{\hD}{m}_{\cB_m/\V}$-module
structure compatible with its algebra structure. The analytic space
$[X]_{\niv{J}{p^{m+1}}}$ associated to $\niv{J}{p^{m+1}}$ will be
denoted by $[X]_{J,m}$ or $[X]_m$. We denote by $\Isoc(\cX,J)$ the
following category:
\begin{itemize}
\item Objects are systems $(M_m,f_{mm'})$ where for all $m\ge m_0$,
  $M_m$ is a left $\niv{\hD}{m}_{\cB_m/\V\bQ}$-module that is coherent
  as a $\cB_{m\bQ}$-module, and for all $m'\ge m\ge m_0$ the $f_{mm'}$
  are a transitive system of $\niv{\hD}{m}_{\cB_m/\V}$-linear
  isomorphisms
  \begin{equation}
    \label{eq:Isoc(X,J)}
    f_{mm'}:\cB_{m\bQ}\ctens_{\cB_{m'\bQ}}M_{m'}\to M_m.
  \end{equation}
\item A morphism $g:(M_m,f_{mm'})\to(M'_m,f'_{mm'})$ is a system of
  $\niv{\hD}{m}_{\cB_m/\V}$-linear maps compatible with the $f_{mm'}$
  and the $f'_{mm'}$.
\end{itemize}
It is not hard to show directly that $\Isoc(\cX,J)$ is independent up
to equivalence of the choice of $J\subset\O_\cX$, but in any case this
follows from theorem \ref{thm:convergent-formal-analytic-comparison}
below.

Suppose for example that $\cX/\V$ is smooth, and $X\subset\cX$ is the
closed fiber (and therefore smooth over $k$). The structure morphisms
$\O_\cX\to\cB_m$ are isomorphisms for all $m\ge m_0$, and the system
$(M_m,f_{mm'})$ can be identified with single coherent
$\O_{\cX\bQ}$-module $M$ endowed with compatible left
$\niv{\hD}{m}_{\cX/\V\bQ}$-module structures for all $m\ge m_0$. In
other words $M$ is an $\Ddag_{\cX/\V}$-module that is coherent as a
$\O_{\cX\bQ}$-module, and conversely any such $M$ defines an object of
$\Isoc(\cX,J)$ by taking $M_m=M$ and $f_{mm'}=id_M$. By proposition
4.1.4 of \cite{berthelot:1996}, $\Isoc(X\subset\cX/K)$ is equivalent
to the category of left $\Ddag_{\cX/\V}$-modules that are coherent as
$\O_{\cX\bQ}$-modules, so it follows that $\Isoc(\cX,J)$ is equivalent
to $\Isoc(X\subset\cX/K)$. We will show that this is true in general.

The construction of $\Isoc(\cX,J)$ is functorial in the following
sense. Suppose $f:\cX'\to\cX$ is a $\V$-morphism and $X'\subset\cX'$
is closed in $X\times_\cX\cX'$. If $K\subset\O_\cX$ is the ideal
defining $X'$ as a closed subscheme of $\cX'$ we set $J'=K+f^*J$. Then
$f$ induces natural morphisms $f^*\cB_m\to\cB'_m$ for all $m\ge m_0$,
where $\cB'_m$ is defined relative to $J'$ in the same way as $\cB_m$
for $J$. Then
\begin{displaymath}
  M_m\mapsto\cB'_m\tens_{f^*\cB_m}f^*M_m
\end{displaymath}
defines a functor
\begin{equation}
  \label{eq:base-change-of-Isoc}
  f^*:\Isoc(\cX,J)\to\Isoc(\cX',J').
\end{equation}
The functors so obtained are transitive, in the usual sense this has
for 2-categories.

\subsection{A Comparison Theorem. }
\label{sec:formal-analytic-comparison}

Let $(M_m,f_{mm'})$ be an object of $\Isoc(\cX,J)$. The discussion in
section \ref{sec:tubes-to-analytic-space} shows that there is a
coherent $\O_{\cX^\an}$-module $M^\an$ such that
$M_m\simeq sp_*(M^\an|[X]_m)$, and these identifications are
compatible with the $f_{mm'}$ and the restriction maps. Furthermore
for any $m\ge m_0$ $M_m$ is a quasi-nilpotent
$\niv{\hD}{m}_{\cB_m/\V\bQ}$-module by corollary
\ref{cor:quasi-nilpotence-and-base-change}, so by lemma
\ref{lemma:quasi-nilpotent-Q} there is a quasi-nilpotent
$\niv{\hD}{m}_{\cB_m/\V\bQ}$-module $M^0_m$ such that
$(M^0_m)\simeq M_m$. Let
\begin{displaymath}
  \chi_{(m)}:\cP_{\cB_m/\V,(m)}\ctens_{\cB_m}M^0_m\isom
  M^0_m\ctens_{\cB_m}\cP_{\cB_m/\V,(m)} 
\end{displaymath}
be the corresponding $m$-HPD-stratification of $M^0_m$. These are
$\cP_{\cB_m/\V,(m)} $-linear, and extending scalars by
$\cP_{\cB_m/\V,(m)}\to\cP^\an_{\cB_m/\V,(m)}$ yields isomorphisms
\begin{equation}
  \label{eq:tube-formal-to-analytic1}
  \chi^\an_{(m)}:\cP^\an_{\cB_m/\V,(m)}\ctens_{\cB_m}M^0_m\isom
  M^0_m\ctens_{\cB_m}\cP^\an_{\cB_m/\V,(m)}.  
\end{equation}
Since the $\chi_{(m)}$ satisfy the cocycle condition on
$\cP_{\cB_m/\V,(m)}(2)$, the $\chi^\an_{(m)}$ satisfy the cocycle
condition on $\cP^\an_{\cB_m/\V,(m)}(2)$. 

Denote by $[X]_{m,i}\sset]X[_{\cX_\V(1)}$ the admissible open defined
by $\cB_m\ctens\cP^\an_{\cX/\V,(i)}\simeq\cP^\an_{\cB_m/\V,(i)}$
(c.f. \ref{eq:[X]_m,i} and \ref{eq:analytic-stratification-in-steps}),
and for $m'\ge m$, $i'\ge i$ let
$i_{(m,i),(m',i')}:[X]_{m,i}\to[X]_{m',i'}$ be the canonical
morphism. The discussion in \S\ref{sec:tubes-to-analytic-space} shows
that \ref{eq:tube-formal-to-analytic1} tensored with $\bQ$ is an
isomorphism
\begin{equation}
  \label{eq:tube-formal-to-analytic2}
  \chi^\an_{(m)\bQ}:(p_1^*M^\an)|[X]_{m,m}\isom(p_0^*M^\an)[X]_{m,m}
\end{equation}
and since $\chi^\an_{(m)}$ satisfies the cocycle condition so does
$\chi^\an_{(m)\bQ}$. Finally proposition
\ref{prop:tube-to-envelope-compositions} and its globalization applied
to the diagonal of $\cX_\V(1)$ show that the $\chi^\an_{(m)\bQ}$ are
compatible with morphisms $i_{(m,m),(m',m')}$ for $m'\ge m$. Since the
$[X]_{m,m}$ for all $m\ge m_0$ form an admissible cover of
$]X[_{\cX_\V(1)}$, the $\chi^\an_{(m)\bQ}$ define an isomorphism
\begin{equation}
  \label{eq:tube-formal-and-analytic3}
  \chi^\an:p_1^*M^\an\isom p_0^*M^\an
\end{equation}
satisfying the cocycle condition. In other words $(M^\an,\chi^\an)$ is
a convergent isocrystal on $X/K$ relative to $X\inj\cX$. Since this
construction is clearly functorial in $M$ we have defined a functor
\begin{equation}
  \label{eq:formal-to-analytic}
  \alpha_J:\Isoc(\cX,J)\to\Isoc(X\subset\cX/K).
\end{equation}
%
% This bit needs some explanation?
%
By construction the functor $\alpha_J$ is compatible with the
functors \ref{eq:base-change-of-Isoc} in the sense that the diagram
\begin{equation}
  \label{eq:alpha_J-compatibility}
  \xymatrix{
    \Isoc(\cX,J)\ar[r]^{\alpha_J\quad}\ar[d]_{f^*}
    &\Isoc(X\subset\cX/K)\ar[d]^{f^*}\\
    \Isoc(\cX',f^*(J))\ar[r]_{\alpha_{f^*(J)}\quad}&\Isoc(X'\subset\cX'/K)
  }  
\end{equation}
is commutative up the isomorphism.

\begin{thm}\label{thm:convergent-formal-analytic-comparison}
  The functor \ref{eq:formal-to-analytic} is an equivalence of
  categories
\end{thm}
\begin{demo}
  We will construct an explicit inverse image functor
  \begin{equation}
    \label{eq:isoc-to-Dmod1}
    \beta_J:\Isoc(X\subset\cX/K)\to\Isoc(\cX,J).
  \end{equation}
  Let $(M,\chi)$ be a convergent isocrystal on $X/K$ relative to
  $X\inj\cX$. For $m\ge m_0$ we set $M_m=M|[X]_m$; then restriction to
  the subspace $[X]_{m'}\subset[X]_m$ for $m'\ge m$ yields
  isomorphisms
  \begin{equation}
    \label{eq:isoc-to-Dmod1.5}
    f_{mm'}:\cB_m\ctens_{\cB_m'}M_{m'}\isom M_m. 
  \end{equation}
  For $m_0<m\le i$ we denote by
  \begin{equation}
    \label{eq:isoc-to-Dmod2}
    (p_1^*M_m)|[X]_{m,i}\isom(p_0^*M_m)|[X]_{m,i}
  \end{equation}
  the restriction of $\chi$ to $[X]_{m,i}$. If $M_m^0$ is a coherent
  $\cB_m$-module such that $M^0_{m\bQ}\simeq M_m$, then
  \ref{eq:isoc-to-Dmod2} is an isomorphism
  \begin{displaymath}
    (\cP^\an_{\cB_i/\V,(i)}\ctens_{\cB_m}M^0_m)_\bQ\isom
    (M^0_m\ctens_{\cB_m}\cP^\an_{\cB_i/\V,(i)})_\bQ.
  \end{displaymath}
  Setting $i=m+1$ and extending scalars by
  $\cP^\an_{\cX/\V,(m+1)}\to\cP_{\cX/\V,(m)}$ yields a isomorphism
  \begin{equation}
    \label{eq:isoc-to-Dmod3}
    (\cP_{\cB_m/\V,(m)}\ctens_{\cB_m}M^0_m)_\bQ\isom
    (M^0_m\ctens_{\cB_m}\cP_{\cB_m/\V,(m)})_\bQ.
  \end{equation}
  Extending scalars by the canonical projections
  $\cP_{\cX/\V,(m)}\to\cP^n_{\cX/\V,(m)}$ then yields isomorphisms
  \begin{displaymath}
    (\cP^n_{\cB_m/\V,(m)}\tens_{\cB_m}M^0_m)_\bQ\isom
    (M^0_m\tens_{\cB_m}\cP^n_{\cB_m/\V,(m)})_\bQ.
  \end{displaymath}
  or, since an ordinary tensor product is involved,
  \begin{equation}
    \label{eq:isoc-to-Dmod4}
    \chi_n^m:\cP^n_{\cB_m/\V,(m)}\tens_{\cB_m}M^0_{m\bQ}\isom
    M^0_{m\bQ}\tens_{\cB_m}\cP^n_{\cB_m/\V,(m)}
  \end{equation}
  for all $n\ge0$. These satisfy the cocycle condition since
  \ref{eq:isoc-to-Dmod2} does, and thus gives $M^0_{m\bQ}$ a left
  $\niv{\hD}{m}_{\cB_m/\V}$-module structure. As before proposition
  \ref{prop:tube-to-envelope-compositions} shows that the $\chi_n^m$
  are compatible with the $f_{mm'}$ for $m'\ge m\ge m_0$. It follows
  that $\beta_J(M,\chi)=(M^0_{m\bQ},f_{mm'})$ is an object of
  $\Isoc(\cX,J)$, and is evidently functorial in $(M,\chi)$. 

  Suppose $(M_m,f_{mm'})$ is in $\Isoc(\cX,J)$ and set
  \begin{displaymath}
    \alpha_J(M_m,f_{mm'})=(M^\an,\chi^\an),
    \qquad
    \beta_J\circ\alpha_J(M_m,f_{mm'})=(M'_m,f'_{mm'}).
  \end{displaymath}
  By construction $M'_m=M^\an|[X]_{m,m}$ as a $\cB_{m\bQ}$-module, so
  for all $m$ we may identify $M_m\simeq M'_m$ in such a way that
  $f_{mm'}=f'_{mm'}$ for all $m'\ge m$. It remains to check that with
  these identifications the $\niv{\hD}{m}_{\cB_m/\V,(m)}$-module
  structures of $M_m$ and $M'_m$ coincide. Again by construction and
  the previous identifications, the
  $\niv{\hD}{m}_{\cB_m/\V,(m)}$-module structure of $M'_m$ is that
  induced from the $\niv{\hD}{m+1}_{\cB_{m+1}/\V,(m+1)}$-module
  structure of $M_{m+1}$ by applying the composite homomorphism
  \begin{displaymath}
    \cP_{\cX/\V,(m+1)}\to\cP^\an_{\cX/\V,(m+1)}\to\cP_{\cX/\V,(m)}
  \end{displaymath}
  to the corresponding $m$-HPD-stratifications.  By (i) of proposition
  \ref{prop:tube-to-envelope-compositions} this is the canonical
  change-of-level map, and it follows that
  $(M'_m,f'_{mm'})\simeq(M_m,f_{mm'})$ in $\Isoc(\cX,J)$, i.e.
  $\beta_J\circ\alpha_J$ is isomorphic to the identity of
  $\Isoc(\cX,J)$. A similar argument using (ii) of proposition
  \ref{prop:tube-to-envelope-compositions} shows that that
  $\alpha_J\circ\beta_J$ is isomorphic to the identity of
  $\Isoc(X\subset\cX/K)$, which concludes the proof.
\end{demo}

The theorem allows us to apply Berthelot's Frobenius descent theorem
for the rings $\niv{\hD}{m}_{\cB_m/\V}$, with the following result: 

\begin{thm}\label{thm:Frobenius-descent-in-Isoc}
  If $X/k$ is separated and of finite type, the pullback by the
  relative Frobenius
  \begin{displaymath}
    F_{X/k}^*:\Isoc(\niv{X}{q}/K)\to\Isoc(X/K)
  \end{displaymath}
  is an equivalence of categories.
\end{thm}
\begin{demo}
  Since the categories involved are of local nature on $X$ we may
  assume that there is a commutative diagram
  \begin{displaymath}
    \xymatrix{
      X\ar[r]\ar[d]_{F_{X/k}}&\cX\ar[d]^F\\
      \niv{X}{q}\ar[r]&\cX'
    }
  \end{displaymath}
  of formal $\V$-schemes in which the horizontal arrows are closed
  immersions, and $\cX$ and $\cX'$ are the completions along $X$ and
  $\niv{X}{q}$ of smooth formal $\V$-schemes. We resume the notation
  of section \ref{sec:tubes-frobenius}, with $R=\V$, and in its
  globalization in section \ref{sec:global-tube-Frobenius-pullback} we
  have $X_0=X$. As explained in that section, there is an ideal of
  definition $J$ satisfying condition \ref{sec:tubes-frobenius}.1, and
  any lifting $F:\cX\to\cX'$ of the relative Frobenius
  $F_{X_0/k}:X\to\niv{X}{q}$ satisfies condition
  \ref{sec:tubes-frobenius}.2. Since
  $\O_\cX[\niv{J}{p^s}\niv{\relax}{p^i}]\simeq\O_\cX[\niv{J}{p^{i+s}}]$,
  the isomorphism \ref{eq:Frobenius-and-tubes-global} shows that the
  diagram \ref{eq:alpha_J-compatibility} applied to $F:\cX\to\cX'$ and
  the ideal $W^*(J)\subset\O_{\cX'}$ is
  \begin{equation}
    \label{eq:Frobenius-descent-in-Isoc}
    \xymatrix@C+0.5cm{
      \Isoc(\cX',W^*(J))\ar[r]^{\alpha_{W^*(J)}}\ar[d]_{F^*}
      &\Isoc(\niv{X}{q}\subset\cX'/K)\ar[d]^{F^*}\\
      \Isoc(\cX,\niv{J}{p^s})\ar[r]_{\alpha_{\niv{J}{p^s}}}
      &\Isoc(X\subset\cX/K).
    }
  \end{equation}
  The Frobenius descent theorem and
  \ref{eq:Frobenius-and-tubes-global} show that $F^*$ induces an
  equivalence of the category of left
  $\niv{\hD}{m}_{\cB'_m/\V}$-modules with the category of left
  $\niv{\hD}{m}_{\cB_m/\V}$-modules, where we have set
  $\cB'_m=\O_{\cX'}[\niv{W^*(J)}{p^{m}}]$, and these equivalences are
  compatible with the morphisms $f_{mm'}$ defining the objects of
  $\Isoc(\cX',W^*(J))$ and $\Isoc(\cX,\niv{J}{p^s})$. It follows that
  the left hand vertical arrow in the diagram
  \ref{eq:Frobenius-descent-in-Isoc} is an equivalence. The horizontal
  arrows are are equivalences by theorem
  \ref{thm:convergent-formal-analytic-comparison}, and the assertion
  follows. 
\end{demo}






\bibliographystyle{../bibtex/hplain}
\bibliography{Dmods-adic}


\end{document}







%%% Local Variables: 
%%% TeX-master: t
%%% End: 
